<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reborn Invention</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,300;0,400;0,600;0,700;0,800;1,700&family=Share+Tech+Mono&display=swap');

/* â”€â”€â”€ VARIABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:     #07090e;
  --ink:    rgba(5,7,12,0.94);
  --sep:    rgba(80,160,255,0.18);
  --sep2:   rgba(80,160,255,0.07);
  --hi:     #4da6ff;
  --hi2:    #1a7aff;
  --gold:   #60aaff;
  --txt:    #b8d4ee;
  --dim:    rgba(140,180,220,0.55);
  --red:    #e03050;
  --hl:     rgba(80,160,255,0.07);
  --accent: #4da6ff;
  --border: rgba(80,160,255,0.2);
}

/* â”€â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Barlow Condensed',sans-serif;
  background:var(--bg);color:var(--txt);
  overflow:hidden;width:100vw;height:100vh;user-select:none;
}

/* â”€â”€â”€ BG â€” ambiance sombre + vignette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bg-anim{
  position:fixed;inset:0;z-index:0;
  background:
    radial-gradient(ellipse 70% 80% at 0% 100%, rgba(10,30,80,.5) 0%, transparent 55%),
    radial-gradient(ellipse 50% 60% at 100% 0%,  rgba(10,20,60,.35) 0%, transparent 60%),
    radial-gradient(ellipse 40% 40% at 50% 50%, rgba(10,20,50,.2) 0%, transparent 70%),
    linear-gradient(170deg,#060810 0%,#060a10 60%,#06080e 100%);
}
.bg-grid{
  position:fixed;inset:0;z-index:0;
  background-image:
    linear-gradient(rgba(80,160,255,.012) 1px,transparent 1px),
    linear-gradient(90deg,rgba(80,160,255,.012) 1px,transparent 1px);
  background-size:70px 70px;
}
.bg-scan{
  position:fixed;inset:0;z-index:1;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.05) 2px,rgba(0,0,0,.05) 3px);
}
.bg-vignette{
  position:fixed;inset:0;z-index:1;pointer-events:none;
  background:radial-gradient(ellipse 100% 100% at 50% 50%,transparent 35%,rgba(0,0,0,.75) 100%);
}

/* â”€â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.screen{position:fixed;inset:0;z-index:10;display:none;flex-direction:column;align-items:center;justify-content:center;}
.screen.active{display:flex;}

/* â”€â”€â”€ TYPOGRAPHIE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* Logo principal */
.logo{
  font-family:'Barlow Condensed',sans-serif;
  font-size:clamp(42px,7vw,92px);
  font-weight:800;letter-spacing:3px;text-transform:uppercase;
  color:#fff;line-height:1;
  text-shadow:0 0 60px rgba(80,160,255,.4),0 0 20px rgba(60,140,255,.2),0 3px 0 rgba(0,0,0,.9);
}
.logo-sub{
  font-family:'Share Tech Mono',monospace;
  font-size:clamp(9px,1.2vw,11px);letter-spacing:5px;
  color:var(--hi);opacity:.6;text-transform:uppercase;margin-top:8px;
}
/* Titres sous-Ã©crans */
.screen-title{
  font-family:'Barlow Condensed',sans-serif;
  font-size:clamp(13px,2vw,17px);font-weight:400;
  letter-spacing:6px;text-transform:uppercase;
  color:var(--hi);opacity:.7;margin-bottom:20px;
}
/* Section headers */
.gsec{
  font-family:'Share Tech Mono',monospace;
  font-size:10px;letter-spacing:3px;color:var(--hi);
  text-transform:uppercase;opacity:.7;
  margin-bottom:10px;padding-bottom:6px;
  border-bottom:1px solid var(--sep2);
}

/* â”€â”€â”€ PANELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rlp{
  background:var(--ink);
  border:1px solid var(--sep);
  border-top:2px solid var(--hi);
  backdrop-filter:blur(18px);
  position:relative;
}

/* â”€â”€â”€ MENU BUTTONS (style Hellion) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mbtn{
  display:block;width:100%;
  background:rgba(8,14,24,.7);
  border:none;
  border-top:1px solid var(--sep);
  border-left:3px solid transparent;
  color:rgba(184,206,222,.6);
  font-family:'Barlow Condensed',sans-serif;
  font-size:clamp(20px,3.2vw,30px);
  font-weight:600;letter-spacing:5px;text-transform:uppercase;
  padding:clamp(14px,2.2vw,20px) clamp(20px,3.5vw,36px);
  cursor:pointer;text-align:left;position:relative;
  transition:color .15s,border-left-color .15s,background .15s,letter-spacing .15s;
  backdrop-filter:blur(6px);
}
.mbtn:last-of-type{border-bottom:1px solid var(--sep);}
.mbtn:hover,.mbtn:focus{
  outline:none;
  border-left-color:var(--hi);
  color:#fff;background:rgba(80,160,255,.07);
  letter-spacing:6px;
  text-shadow:0 0 25px rgba(80,160,255,.45);
}

/* â”€â”€â”€ ACTION BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pbtn{
  background:transparent;
  border:1px solid var(--sep);border-top:2px solid var(--hi2);
  color:var(--hi2);
  font-family:'Barlow Condensed',sans-serif;
  font-size:clamp(14px,2vw,18px);font-weight:700;letter-spacing:4px;text-transform:uppercase;
  padding:clamp(10px,1.8vw,14px) clamp(24px,4vw,44px);
  cursor:pointer;position:relative;overflow:hidden;
  transition:color .14s,text-shadow .14s;
}
.pbtn::before{content:'';position:absolute;inset:0;background:var(--hi2);opacity:0;transition:opacity .14s;}
.pbtn:hover{color:#fff;text-shadow:0 0 18px rgba(192,120,48,.5);}
.pbtn:hover::before{opacity:.12;}

.bbtn{
  background:transparent;border:1px solid var(--sep2);
  color:var(--dim);
  font-family:'Share Tech Mono',monospace;
  font-size:clamp(10px,1.4vw,12px);letter-spacing:2px;text-transform:uppercase;
  padding:9px 20px;cursor:pointer;transition:border-color .12s,color .12s;margin-top:8px;
}
.bbtn:hover{border-color:var(--hi);color:var(--hi);}

/* â”€â”€â”€ TAB BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tbtn{
  background:transparent;
  border:1px solid var(--sep2);border-bottom:2px solid transparent;
  color:var(--dim);
  font-family:'Share Tech Mono',monospace;
  font-size:clamp(10px,1.6vw,12px);letter-spacing:2px;text-transform:uppercase;
  padding:clamp(7px,1.3vw,9px) clamp(10px,2vw,16px);
  cursor:pointer;transition:all .12s;
}
.tbtn:hover,.tbtn.active{border-color:var(--hi);border-bottom-color:var(--hi);color:#fff;background:rgba(160,200,230,.08);}

.botbtn{
  width:42px;height:42px;background:transparent;
  border:1px solid var(--sep2);
  color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:15px;font-weight:700;
  cursor:pointer;transition:all .12s;
}
.botbtn:hover,.botbtn.active{border-color:var(--hi);color:#fff;background:rgba(160,200,230,.1);}

/* â”€â”€â”€ MAP CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mc{cursor:pointer;border:1px solid var(--sep2);transition:all .18s;overflow:hidden;position:relative;}
.mc:hover,.mc.selected{border-color:var(--hi);box-shadow:0 0 16px rgba(160,200,230,.18);}
.mc.selected::after{content:'âœ“';position:absolute;top:6px;right:6px;background:var(--hi);color:#000;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;}
.mt{height:95px;position:relative;overflow:hidden;}
.mn{padding:7px 10px;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;background:rgba(5,7,12,.88);border-top:1px solid var(--sep2);color:var(--dim);}

/* â”€â”€â”€ COLOR SWATCHES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.csw{width:28px;height:28px;border:2px solid transparent;cursor:pointer;transition:all .12s;}
.csw:hover,.csw.active{border-color:#fff;transform:scale(1.12);box-shadow:0 0 8px rgba(255,255,255,.3);}
.oi{padding:6px 11px;background:transparent;border:1px solid var(--sep2);cursor:pointer;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--dim);transition:all .12s;}
.oi:hover,.oi.active{background:rgba(160,200,230,.1);border-color:var(--hi);color:var(--hi);}

/* â”€â”€â”€ HUD EN JEU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#game-hud{position:fixed;inset:0;z-index:60;display:none;pointer-events:none;}
.hud-sc{
  position:absolute;top:0;left:50%;transform:translateX(-50%);
  background:rgba(4,6,10,.92);
  border-bottom:1px solid var(--sep);
  border-left:1px solid var(--sep2);border-right:1px solid var(--sep2);
  padding:8px 36px 10px;display:flex;align-items:center;gap:20px;
  backdrop-filter:blur(14px);
}
.hud-n{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:800;color:#fff;min-width:32px;text-align:center;letter-spacing:1px;}
.hud-t{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--dim);text-align:center;}
.hud-div{width:1px;height:36px;background:var(--sep);}
.hud-tm{font-family:'Share Tech Mono',monospace;font-size:15px;font-weight:700;color:var(--hi);min-width:60px;text-align:center;letter-spacing:2px;}
.hud-bs{position:absolute;bottom:62px;right:26px;display:flex;flex-direction:column;align-items:center;gap:4px;}
.hud-bsl{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:3px;color:var(--dim);}
.hud-bsb{width:10px;height:88px;background:rgba(255,255,255,.05);border:1px solid var(--sep);position:relative;overflow:hidden;}
.hud-bsf{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(0deg,var(--hi2),var(--gold));transition:height .08s;}
.hud-hint{position:absolute;top:8px;left:14px;font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(184,206,222,.18);letter-spacing:2px;}

/* â”€â”€â”€ GAME CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#game-canvas{position:fixed;inset:0;z-index:50;display:none;}
#gameCanvas{width:100vw;height:100vh;}

/* â”€â”€â”€ OVERLAYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cdo{position:fixed;inset:0;z-index:70;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);pointer-events:none;}
#cdn{font-family:'Barlow Condensed',sans-serif;font-size:140px;font-weight:800;color:#fff;letter-spacing:-2px;text-shadow:0 0 60px rgba(160,200,230,.5);animation:cp .9s ease-in-out infinite;}
@keyframes cp{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}

#goa{position:fixed;inset:0;z-index:72;display:none;align-items:center;justify-content:center;pointer-events:none;flex-direction:column;}
#goa.show{display:flex;animation:gi .3s cubic-bezier(.175,.885,.32,1.275);}
#got{font-family:'Barlow Condensed',sans-serif;font-size:clamp(52px,9vw,104px);font-weight:800;letter-spacing:4px;text-align:center;line-height:1;padding:16px 48px;background:rgba(4,6,10,.75);border-top:3px solid currentColor;white-space:nowrap;}
@keyframes gi{from{transform:scale(.25) translateY(-40px);opacity:0}to{transform:scale(1);opacity:1}}

/* â”€â”€â”€ PAUSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#pm{position:fixed;inset:0;z-index:90;display:none;align-items:center;justify-content:center;background:rgba(2,4,8,.85);backdrop-filter:blur(12px);}
#pm.show{display:flex;}
.pp{width:380px;padding:36px 32px;}
.pt{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;letter-spacing:6px;text-align:center;margin-bottom:24px;color:#fff;text-shadow:0 0 20px rgba(160,200,230,.2);}
.pmbtn{display:block;width:100%;background:transparent;border:none;border-top:1px solid var(--sep);border-left:3px solid transparent;color:var(--dim);font-family:'Barlow Condensed',sans-serif;font-size:clamp(18px,2.5vw,24px);font-weight:600;letter-spacing:4px;text-transform:uppercase;padding:15px 18px;cursor:pointer;text-align:left;position:relative;transition:all .12s;}
.pmbtn:last-of-type{border-bottom:1px solid var(--sep);}
.pmbtn::before{content:'';position:absolute;inset:0;background:var(--hl);opacity:0;transition:opacity .12s;}
.pmbtn:hover{border-left-color:var(--hi);color:#fff;letter-spacing:5px;}.pmbtn:hover::before{opacity:1;}
.pmbtn.dng:hover{border-left-color:var(--red);color:var(--red);}

/* â”€â”€â”€ END SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#es{position:fixed;inset:0;z-index:80;display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px;background:rgba(2,4,8,.94);backdrop-filter:blur(12px);}
#es.show{display:flex;}
.er{font-family:'Barlow Condensed',sans-serif;font-size:clamp(38px,8vw,84px);font-weight:800;letter-spacing:6px;}
.er.win{color:var(--hi);text-shadow:0 0 50px rgba(160,200,230,.4);}
.er.lose{color:var(--red);text-shadow:0 0 50px rgba(184,48,64,.4);}
.erew{font-family:'Share Tech Mono',monospace;font-size:17px;color:var(--hi);letter-spacing:2px;}
.efs{font-family:'Barlow Condensed',sans-serif;font-size:56px;font-weight:800;letter-spacing:2px;color:#fff;}

/* â”€â”€â”€ PLAYER BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.plbar{position:fixed;bottom:0;left:0;right:0;z-index:100;background:rgba(4,6,10,.97);border-top:1px solid var(--sep);padding:8px 18px;display:flex;align-items:center;gap:14px;backdrop-filter:blur(14px);}
.pav{width:38px;height:38px;background:linear-gradient(135deg,rgba(160,200,230,.25),rgba(20,40,70,.8));border:1px solid var(--hi);display:flex;align-items:center;justify-content:center;font-size:17px;cursor:pointer;}
.xp-bar-wrap{width:80px;height:5px;background:rgba(255,255,255,.07);border:1px solid var(--sep2);overflow:hidden;}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--hi),rgba(160,200,230,.35));transition:width .4s;}

/* â”€â”€â”€ VAK BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.vak-bar{position:fixed;top:14px;right:14px;z-index:100;display:flex;align-items:center;gap:8px;background:rgba(4,6,10,.94);border:1px solid var(--sep);border-left:3px solid var(--gold);padding:7px 16px;font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--hi);letter-spacing:2px;backdrop-filter:blur(12px);}

/* â”€â”€â”€ NOTIF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.notif{position:fixed;top:58px;right:14px;z-index:200;background:rgba(4,6,10,.98);border:1px solid var(--sep);border-left:3px solid var(--hi2);padding:10px 16px;font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:1px;transform:translateX(130%);transition:transform .28s cubic-bezier(.16,1,.3,1);max-width:260px;}
.notif.show{transform:translateX(0);}

/* â”€â”€â”€ KEYBINDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.krow{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--sep2);}
.klbl{font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:2px;color:var(--dim);}
.kkey{background:transparent;border:1px solid var(--sep);padding:6px 12px;font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:2px;cursor:pointer;min-width:78px;text-align:center;transition:all .12s;color:var(--dim);}
.kkey:hover,.kkey.listening{background:rgba(192,120,48,.1);border-color:var(--hi2);color:var(--hi2);}
.kkey.listening{animation:lp .7s ease-in-out infinite;}
@keyframes lp{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€â”€ ADMIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#admin-panel{position:fixed;inset:0;z-index:300;display:none;align-items:center;justify-content:center;background:rgba(2,4,8,.9);backdrop-filter:blur(14px);}
#admin-panel.show{display:flex;}
.admin-box{width:340px;padding:32px 28px;background:rgba(5,8,14,.98);border:1px solid var(--sep);border-top:2px solid var(--hi);}
.srv-card{background:rgba(160,200,230,.02);border:1px solid var(--sep2);padding:12px 16px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.srv-card:hover{border-color:var(--hi);background:rgba(160,200,230,.06);}

/* â”€â”€â”€ GOAL COUNTDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#goal-countdown{position:fixed;inset:0;z-index:73;display:none;align-items:center;justify-content:center;pointer-events:none;}
#goal-countdown.show{display:flex;}
.gc-num{font-family:'Barlow Condensed',sans-serif;font-size:120px;font-weight:800;color:#fff;text-shadow:0 0 60px rgba(160,200,230,.55);}

/* â”€â”€â”€ PING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#ping-display{position:fixed;bottom:12px;right:14px;z-index:200;font-family:'Share Tech Mono',monospace;font-size:9px;color:rgba(184,206,222,.22);letter-spacing:1px;display:none;}
#ping-display.show{display:block;}

/* â”€â”€â”€ MOBILE JOYSTICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#mobile-controls{position:fixed;bottom:0;left:0;right:0;height:220px;z-index:65;display:none;pointer-events:none;}
#joy-zone{position:absolute;left:24px;bottom:28px;width:130px;height:130px;pointer-events:auto;touch-action:none;}
#joy-base{position:absolute;inset:0;border-radius:50%;background:rgba(160,200,230,.06);border:2px solid rgba(160,200,230,.2);backdrop-filter:blur(4px);}
#joy-stick{position:absolute;width:52px;height:52px;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(255,255,255,.45),rgba(160,200,230,.25));border:2px solid rgba(160,200,230,.55);box-shadow:0 0 14px rgba(160,200,230,.25);left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:none;}
#boost-btn{position:absolute;right:28px;bottom:28px;width:90px;height:90px;border-radius:50%;background:radial-gradient(circle at 35% 30%,rgba(192,120,48,.55),rgba(140,60,0,.4));border:2px solid rgba(192,120,48,.55);box-shadow:0 0 20px rgba(192,120,48,.25);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:2px;pointer-events:auto;touch-action:none;cursor:pointer;backdrop-filter:blur(4px);}
#boost-btn.active{transform:scale(0.92);box-shadow:0 0 32px rgba(192,160,0,.65);background:radial-gradient(circle at 35% 30%,rgba(220,180,0,.75),rgba(192,100,0,.6));}
.boost-icon{font-size:26px;line-height:1;}
.boost-label{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:rgba(255,255,255,.75);}
/* Only ever show on genuine touch/coarse-pointer devices */
#mobile-controls.ingame{display:none;}
@media(pointer:coarse),(hover:none){
  #mobile-controls.ingame{display:block;}
  #hud-bs-wrap{display:none;}
}
@media(pointer:fine),(hover:hover){
  #mobile-controls{display:none !important;}
}

/* â”€â”€â”€ MAIN MENU LAYOUT (style Hellion) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#screen-main{
  flex-direction:row;align-items:stretch;
  justify-content:flex-start;padding:0;
  overflow:hidden;
}
/* Colonne gauche : logo + boutons */
.menu-left{
  display:flex;flex-direction:column;justify-content:flex-end;
  padding:0 0 clamp(60px,10vh,100px) clamp(40px,6vw,90px);
  width:clamp(300px,44vw,560px);flex-shrink:0;
}
.menu-logo-block{margin-bottom:clamp(28px,5vh,56px);}
.menu-btns{display:flex;flex-direction:column;border-bottom:1px solid var(--sep);}
/* SÃ©parateur vertical */
.menu-divider{
  width:1px;
  background:linear-gradient(180deg,transparent,var(--sep) 20%,var(--sep) 80%,transparent);
  flex-shrink:0;
}
/* Colonne droite : news */
.menu-right{
  flex:1;display:flex;flex-direction:column;justify-content:center;
  padding:clamp(60px,10vh,100px) clamp(40px,6vw,80px) clamp(60px,10vh,100px) clamp(28px,4vw,60px);
  overflow-y:auto;max-height:100vh;
}
.news-heading{
  font-family:'Barlow Condensed',sans-serif;font-size:clamp(14px,2vw,20px);
  font-weight:400;letter-spacing:6px;text-transform:uppercase;color:#fff;
  margin-bottom:14px;display:flex;align-items:center;gap:16px;opacity:.85;
}
.news-heading::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--hi),transparent);opacity:.3;}
.news-line{height:1px;background:linear-gradient(90deg,var(--sep),transparent);margin:14px 0;}
.news-title-big{font-family:'Barlow Condensed',sans-serif;font-size:clamp(18px,2.5vw,26px);font-weight:700;letter-spacing:1px;color:#fff;margin-bottom:4px;line-height:1.15;}
.news-date{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim);margin-bottom:12px;letter-spacing:1px;}
.news-img{width:100%;height:clamp(180px,26vh,300px);background:linear-gradient(135deg,rgba(20,40,70,.8),rgba(10,20,40,.9));border:1px solid var(--sep2);margin-bottom:10px;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:36px;}
.news-body{font-family:'Barlow Condensed',sans-serif;font-size:clamp(13px,1.6vw,15px);color:var(--dim);line-height:1.65;font-weight:400;}
.news-tag{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--hi);letter-spacing:2px;}

/* â”€â”€â”€ SUB-SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sub-wrap{width:min(700px,96vw);display:flex;flex-direction:column;gap:14px;align-items:center;}
.sub-wrap .rlp{width:100%;}

/* â”€â”€â”€ RARITY SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --r-common:   #8899aa;
  --r-uncommon: #44cc77;
  --r-rare:     #4da6ff;
  --r-epic:     #aa44ff;
  --r-legendary:#ff9900;
}
.rarity-badge {
  font-family:'Share Tech Mono',monospace;
  font-size:8px;letter-spacing:3px;text-transform:uppercase;
  padding:2px 8px;border:1px solid currentColor;display:inline-block;
}

/* â”€â”€â”€ SHOP ROTATION TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#shop-rotation-bar {
  width:100%;height:3px;background:rgba(80,160,255,.1);position:relative;overflow:hidden;margin-bottom:6px;
}
#shop-rotation-fill {
  position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--hi2),var(--hi));transition:width .5s linear;
}
#shop-next-timer {
  font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:rgba(140,180,220,.4);
}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/* Tablet / small desktop */
@media(max-width:1024px){
  .menu-left{
    padding:0 0 clamp(40px,7vh,80px) clamp(24px,4vw,56px);
    width:clamp(260px,38vw,480px);
  }
  .menu-right{
    padding:clamp(40px,7vh,80px) clamp(24px,4vw,48px) clamp(40px,7vh,80px) clamp(18px,3vw,36px);
  }
}

/* Mobile */
@media(max-width:720px){
  body{overflow-y:auto;height:auto;min-height:100vh;}
  .screen{position:relative;min-height:100vh;justify-content:flex-start;overflow-y:auto;}
  #screen-main{
    position:fixed !important;
    flex-direction:column !important;
    align-items:center !important;justify-content:center !important;
    padding:0 16px 80px !important;
  }
  .menu-left{
    width:100% !important;padding:0 !important;
    align-items:center;justify-content:center;
  }
  .menu-logo-block{text-align:center;margin-bottom:18px;}
  .menu-btns{width:min(320px,88vw) !important;}
  .menu-divider,.menu-right{display:none !important;}
  .sub-wrap{width:96vw;}
  #screen-play-solo,#screen-play-multi,#screen-play,#screen-garage,#screen-shop,#screen-settings,
  #screen-create-server,#screen-join-server{
    padding-top:48px !important;padding-bottom:80px !important;gap:12px;
  }
  #screen-play{padding:20px 10px 80px !important;}
  #screen-play-solo .rlp,#screen-play-multi .rlp{width:96vw !important;padding:14px !important;}
  .mc{width:calc(33% - 8px) !important;min-width:80px;}
  .mt{height:clamp(46px,12vw,88px) !important;}
  .mn{font-size:9px !important;padding:4px 6px !important;}
  #screen-garage .garage-inner{flex-direction:column !important;width:96vw !important;}
  #screen-garage canvas{width:100% !important;height:auto !important;}
  #shop-grid{grid-template-columns:repeat(2,1fr) !important;}
  .pp{width:92vw;padding:24px 18px;}
  .vak-bar{font-size:11px;padding:6px 10px;top:8px;right:8px;}
  .plbar{padding:7px 12px;gap:8px;}
  #screen-create-server .cs-inner{flex-direction:column !important;}
}

/* Very small screens */
@media(max-width:400px){
  .mbtn{font-size:18px;letter-spacing:3px;padding:12px 16px;}
  .logo{font-size:36px;}
  #shop-grid{grid-template-columns:repeat(2,1fr) !important;}
}

/* â”€â”€â”€ PLAY MODE CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.play-mode-hover-overlay{
  position:absolute;inset:0;background:rgba(80,160,255,.04);
  opacity:0;transition:opacity .18s;pointer-events:none;
}
#play-mode-solo:hover,#play-mode-multi:hover{
  border-color:var(--hi) !important;
  box-shadow:0 0 40px rgba(80,160,255,.15),inset 0 0 20px rgba(80,160,255,.04) !important;
  transform:translateY(-3px);
}
#play-mode-solo:hover .play-mode-hover-overlay,
#play-mode-multi:hover .play-mode-hover-overlay{opacity:1;}
#play-mode-solo:hover img,#play-mode-multi:hover img{filter:brightness(1.1) !important;}
#screen-play{overflow-y:auto;}

/* â”€â”€â”€ LEGENDARY SHIMMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes lgShimmer{
  0%{transform:translateX(-100%)}
  60%,100%{transform:translateX(200%)}
}

/* â”€â”€â”€ ALL SCREENS CENTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#screen-play-solo,#screen-play-multi,#screen-garage,
#screen-settings,#screen-create-server,#screen-join-server{
  overflow-y:auto;
  padding:clamp(16px,4vh,50px) clamp(12px,2vw,40px) clamp(50px,8vh,90px);
}
.sub-wrap{
  width:min(700px,96vw);
  display:flex;flex-direction:column;gap:14px;align-items:center;
}
.sub-wrap .rlp{width:100%;}
#screen-play-solo .sub-wrap,
#screen-garage .sub-wrap,
#screen-settings .sub-wrap{
  align-items:center;
  text-align:left;
}
/* Garage inner flex */
.garage-inner{display:flex;gap:18px;width:min(860px,96vw);}
</style>
</head>
<body>
<div class="bg-anim"></div><div class="bg-grid"></div><div class="bg-scan"></div><div class="bg-vignette"></div>
<div class="vak-bar" id="vak-display">ğŸ’° <span id="vak-amount">0</span> VAK</div>
<div class="notif" id="notif"></div>
<div id="ping-display">PING: <span id="ping-val">--</span>ms</div>

<!-- MAIN MENU -->
<div class="screen active" id="screen-main">
  <!-- Colonne gauche : logo + boutons -->
  <div class="menu-left">
    <div class="menu-logo-block">
      <div class="logo">Reborn Invention</div>
      <div class="logo-sub">/ / SAISON 1 â€” Ã‰DITION SPÃ‰CIALE</div>
    </div>
    <div class="menu-btns">
      <button class="mbtn" onclick="showScreen('screen-play')">JOUER</button>
      <button class="mbtn" onclick="showScreen('screen-garage')">GARAGE</button>
      <button class="mbtn" onclick="showScreen('screen-shop')">BOUTIQUE</button>
      <button class="mbtn" onclick="showScreen('screen-settings')">PARAMÃˆTRES</button>
      <button class="mbtn" onclick="openAdmin()" style="font-size:clamp(13px,1.8vw,16px);color:rgba(220,190,140,.2);letter-spacing:4px">STAFF ONLY</button>
    </div>
  </div>
  <!-- SÃ©parateur vertical -->
  <div class="menu-divider"></div>
  <!-- Colonne droite : news -->
  <div class="menu-right">
    <div class="news-heading">ACTUALITÃ‰S</div>
    <div class="news-line"></div>
    <div class="news-title-big">SAISON 1 EN COURS</div>
    <div class="news-date">SEMAINE 1 Â· Ã‰DITION SPÃ‰CIALE</div>
    <div class="news-img" id="news-car-wrap" style="position:relative;background:linear-gradient(135deg,rgba(10,15,30,.9),rgba(5,8,18,.95));border:1px solid var(--sep);height:clamp(180px,26vh,300px);">
      <canvas id="newsCarCanvas" style="width:100%;height:100%;display:block;"></canvas>
    </div>
    <div class="news-body">
      Bienvenue dans <strong style="color:var(--hi)">Reborn Invention</strong> â€” le jeu de voitures le plus controversÃ© du web.<br><br>
      Gagnez des matchs pour accumuler des <span class="news-tag">VAK</span> et dÃ©bloquer des skins exclusifs.<br><br>
      <span style="color:var(--hi)">+15 VAK</span> par victoire Â· <span style="color:var(--hi)">+100 XP</span> par match.
    </div>
    <div class="news-line"></div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim);letter-spacing:2px;text-align:right">v1.0 Â· SERVEURS EN LIGNE</div>
  </div>
  <!-- canvas cachÃ© pour prÃ©-rendu voiture -->
  <canvas id="menuCarCanvas" width="342" height="175" style="display:none"></canvas>
</div>

<!-- PLAY SCREEN â€” Style "Choose Your Mode" -->
<div class="screen" id="screen-play">
  <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,#000 0%,#04080a 50%,#000 100%);z-index:0;"></div>
  <!-- Ink splatter background lines like Batman Arkham -->
  <div style="position:absolute;inset:0;z-index:0;overflow:hidden;pointer-events:none;">
    <div style="position:absolute;top:50%;left:0;right:0;height:clamp(80px,20vh,160px);background:rgba(80,160,255,0.04);transform:translateY(-50%) skewY(-3deg);"></div>
    <div style="position:absolute;top:50%;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(80,160,255,0.3),transparent);transform:translateY(-50%);"></div>
  </div>
  <div style="position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;width:100%;padding:0 20px;">
    <!-- Header -->
    <div style="text-align:center;margin-bottom:clamp(20px,5vh,50px);">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(11px,1.4vw,14px);letter-spacing:8px;color:var(--hi);opacity:.8;text-transform:uppercase;border:1px solid rgba(80,160,255,.2);display:inline-block;padding:5px 20px;margin-bottom:12px;">MODE DE JEU</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(22px,4vw,38px);font-weight:800;letter-spacing:4px;color:#fff;text-transform:uppercase;text-shadow:0 0 40px rgba(80,160,255,.3);">CHOISIR VOTRE EXPÃ‰RIENCE...</div>
    </div>
    <!-- Two mode cards like Batman character select -->
    <div style="display:flex;gap:clamp(8px,2vw,24px);width:100%;max-width:900px;justify-content:center;flex-wrap:wrap;">
      <!-- SOLO card -->
      <div id="play-mode-solo" onclick="switchToSoloDetail()" style="flex:1;min-width:250px;max-width:380px;cursor:pointer;position:relative;overflow:hidden;border:2px solid rgba(80,160,255,0.15);transition:all .2s;background:#0a0806;">
        <div style="height:clamp(200px,30vh,320px);position:relative;overflow:hidden;background:#000;">
          <img src="https://i.imgur.com/72nrw3V.png" alt="Solo" style="width:100%;height:100%;object-fit:cover;object-position:center;image-rendering:high-quality;transition:filter .2s;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
          <div style="display:none;width:100%;height:100%;background:linear-gradient(135deg,#1a1000,#0a0800);align-items:center;justify-content:center;font-size:72px;">ğŸï¸</div>
          <div style="position:absolute;inset:0;background:linear-gradient(0deg,rgba(10,8,0,.9) 0%,transparent 50%);pointer-events:none;"></div>
        </div>
        <div style="padding:16px 20px;border-top:2px solid rgba(80,160,255,.2);background:rgba(10,8,2,.95);">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(24px,3.5vw,34px);font-weight:800;letter-spacing:4px;text-transform:uppercase;color:#fff;text-shadow:0 0 20px rgba(80,160,255,.3);">SOLO</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--dim);margin-top:2px;">JOUER CONTRE DES BOTS</div>
        </div>
        <div class="play-mode-hover-overlay"></div>
      </div>
      <!-- MULTIPLAYER card -->
      <div id="play-mode-multi" onclick="switchToMultiDetail()" style="flex:1;min-width:250px;max-width:380px;cursor:pointer;position:relative;overflow:hidden;border:2px solid rgba(80,160,255,.3);transition:all .2s;background:#0a0806;box-shadow:0 0 30px rgba(80,160,255,.08);">
        <div style="height:clamp(200px,30vh,320px);position:relative;overflow:hidden;background:#000;">
          <img src="https://i.imgur.com/X1yZVh0.png" alt="Multiplayer" style="width:100%;height:100%;object-fit:cover;object-position:center;image-rendering:high-quality;transition:filter .2s;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
          <div style="display:none;width:100%;height:100%;background:linear-gradient(135deg,#1a1000,#0a0800);align-items:center;justify-content:center;font-size:72px;">ğŸŒ</div>
          <div style="position:absolute;inset:0;background:linear-gradient(0deg,rgba(10,8,0,.9) 0%,transparent 50%);pointer-events:none;"></div>
        </div>
        <div style="padding:16px 20px;border-top:2px solid var(--hi);background:rgba(10,8,2,.95);">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(24px,3.5vw,34px);font-weight:800;letter-spacing:4px;text-transform:uppercase;color:var(--hi);text-shadow:0 0 20px rgba(80,160,255,.4);">MULTIJOUEUR</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--dim);margin-top:2px;">JOUER EN LIGNE</div>
        </div>
        <div class="play-mode-hover-overlay"></div>
      </div>
    </div>
    <!-- Back button -->
    <button class="bbtn" onclick="showScreen('screen-main')" style="margin-top:clamp(16px,4vh,36px);">â† RETOUR</button>
  </div>
</div>

<!-- PLAY SOLO DETAIL SCREEN -->
<div class="screen" id="screen-play-solo">
<div class="sub-wrap">
<div class="screen-title">SOLO â€” CONFIGURATION</div>
  <div class="rlp" style="padding:22px;width:660px;max-width:96vw">
    <div class="gsec">CHOISIR LA MAP</div>
    <div style="display:flex;gap:12px;margin:14px 0;flex-wrap:wrap">
      <div class="mc selected" id="map-0" onclick="selectMap(0)"><div class="mt"><canvas width="180" height="95" id="mpv-0"></canvas></div><div class="mn">ğŸœ Scorched Earth</div></div>
      <div class="mc" id="map-1" onclick="selectMap(1)"><div class="mt"><canvas width="180" height="95" id="mpv-1"></canvas></div><div class="mn">ğŸ§Š Arctic Freeze</div></div>
      <div class="mc" id="map-2" onclick="selectMap(2)"><div class="mt"><canvas width="180" height="95" id="mpv-2"></canvas></div><div class="mn">ğŸŒ¿ Neo Tokyo</div></div>
    </div>
    <div class="gsec" style="margin-top:12px">DURÃ‰E DU MATCH</div>
    <div style="display:flex;gap:8px;margin:10px 0;flex-wrap:wrap">
      <button class="tbtn" id="t-2" onclick="selectTime(120)">2 MIN</button>
      <button class="tbtn active" id="t-3" onclick="selectTime(180)">3 MIN</button>
      <button class="tbtn" id="t-5" onclick="selectTime(300)">5 MIN</button>
      <button class="tbtn" id="t-7" onclick="selectTime(420)">7 MIN</button>
      <button class="tbtn" id="t-10" onclick="selectTime(600)">10 MIN</button>
    </div>
    <div class="gsec" style="margin-top:12px">BOTS ADVERSES</div>
    <div style="display:flex;gap:8px;margin:10px 0;align-items:center">
      <button class="botbtn active" id="bot-1" onclick="selectBots(1)">1</button>
      <button class="botbtn" id="bot-2" onclick="selectBots(2)">2</button>
      <button class="botbtn" id="bot-3" onclick="selectBots(3)">3</button>
    </div>
    <div style="display:flex;gap:12px;margin-top:18px;align-items:center">
      <button class="pbtn" onclick="startSoloGame()">LANCER â–¶</button>
      <button class="bbtn" onclick="showScreen('screen-play')">â† RETOUR</button>
    </div>
  </div>
</div>
</div>

<!-- PLAY MULTI DETAIL SCREEN -->
<div class="screen" id="screen-play-multi">
  <!-- Ambient background lines -->
  <div style="position:absolute;inset:0;z-index:0;overflow:hidden;pointer-events:none;">
    <div style="position:absolute;top:50%;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(80,160,255,0.15),transparent);transform:translateY(-50%);"></div>
    <div style="position:absolute;top:30%;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(80,160,255,0.06),transparent);"></div>
    <div style="position:absolute;top:70%;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(80,160,255,0.06),transparent);"></div>
  </div>

  <div style="position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;width:100%;max-width:860px;padding:0 20px;">

    <!-- Header -->
    <div style="text-align:center;margin-bottom:clamp(24px,5vh,48px);">
      <div style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:8px;color:var(--hi);opacity:.7;text-transform:uppercase;margin-bottom:10px;">MODE EN LIGNE</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(28px,5vw,52px);font-weight:800;letter-spacing:5px;color:#fff;text-transform:uppercase;text-shadow:0 0 40px rgba(80,160,255,.3);">MULTIJOUEUR</div>
      <div style="width:60px;height:2px;background:var(--hi);margin:12px auto 0;opacity:.6;"></div>
    </div>

    <!-- Two action cards -->
    <div style="display:flex;gap:clamp(12px,3vw,28px);width:100%;justify-content:center;flex-wrap:wrap;">

      <!-- CREATE SERVER card -->
      <div onclick="goCreateServer()" style="flex:1;min-width:240px;max-width:360px;cursor:pointer;background:rgba(5,10,20,.85);border:1px solid rgba(80,160,255,.2);border-top:2px solid var(--hi);padding:clamp(24px,4vw,36px) clamp(20px,3vw,32px);position:relative;overflow:hidden;transition:all .2s;backdrop-filter:blur(12px);"
        onmouseenter="this.style.borderColor='var(--hi)';this.style.background='rgba(10,20,40,.9)';this.style.boxShadow='0 0 40px rgba(80,160,255,.12)';this.style.transform='translateY(-4px)'"
        onmouseleave="this.style.borderColor='rgba(80,160,255,.2)';this.style.background='rgba(5,10,20,.85)';this.style.boxShadow='none';this.style.transform='translateY(0)'">
        <!-- Corner accent -->
        <div style="position:absolute;top:0;right:0;width:0;height:0;border-style:solid;border-width:0 28px 28px 0;border-color:transparent var(--hi) transparent transparent;opacity:.4;"></div>
        <!-- Icon -->
        <div style="width:56px;height:56px;border:1px solid rgba(80,160,255,.3);background:rgba(80,160,255,.08);display:flex;align-items:center;justify-content:center;margin-bottom:18px;font-size:26px;">ğŸŒ</div>
        <!-- Title -->
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(22px,3vw,28px);font-weight:800;letter-spacing:4px;text-transform:uppercase;color:#fff;margin-bottom:6px;">CRÃ‰ER</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(22px,3vw,28px);font-weight:800;letter-spacing:4px;text-transform:uppercase;color:var(--hi);margin-bottom:12px;">UN SERVEUR</div>
        <!-- Description -->
        <div style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;color:rgba(140,180,220,.55);line-height:1.7;margin-bottom:20px;">HÃ‰BERGEZ UNE PARTIE<br>ET INVITEZ VOS AMIS</div>
        <!-- CTA -->
        <div style="display:flex;align-items:center;gap:10px;font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:3px;color:var(--hi);">
          <div style="width:28px;height:1px;background:var(--hi);"></div>DÃ‰MARRER
        </div>
      </div>

      <!-- JOIN SERVER card -->
      <div onclick="showScreen('screen-join-server')" style="flex:1;min-width:240px;max-width:360px;cursor:pointer;background:rgba(5,10,20,.85);border:1px solid rgba(80,160,255,.2);border-top:2px solid rgba(80,160,255,.4);padding:clamp(24px,4vw,36px) clamp(20px,3vw,32px);position:relative;overflow:hidden;transition:all .2s;backdrop-filter:blur(12px);"
        onmouseenter="this.style.borderColor='var(--hi)';this.style.background='rgba(10,20,40,.9)';this.style.boxShadow='0 0 40px rgba(80,160,255,.12)';this.style.transform='translateY(-4px)';this.style.borderTopColor='var(--hi)'"
        onmouseleave="this.style.borderColor='rgba(80,160,255,.2)';this.style.background='rgba(5,10,20,.85)';this.style.boxShadow='none';this.style.transform='translateY(0)';this.style.borderTopColor='rgba(80,160,255,.4)'">
        <div style="position:absolute;top:0;right:0;width:0;height:0;border-style:solid;border-width:0 28px 28px 0;border-color:transparent rgba(80,160,255,.3) transparent transparent;"></div>
        <!-- Icon -->
        <div style="width:56px;height:56px;border:1px solid rgba(80,160,255,.3);background:rgba(80,160,255,.06);display:flex;align-items:center;justify-content:center;margin-bottom:18px;font-size:26px;">ğŸ”</div>
        <!-- Title -->
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(22px,3vw,28px);font-weight:800;letter-spacing:4px;text-transform:uppercase;color:#fff;margin-bottom:6px;">REJOINDRE</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(22px,3vw,28px);font-weight:800;letter-spacing:4px;text-transform:uppercase;color:rgba(140,180,255,.7);margin-bottom:12px;">UN SERVEUR</div>
        <!-- Description -->
        <div style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;color:rgba(140,180,220,.55);line-height:1.7;margin-bottom:20px;">ENTREZ L'ID D'UNE PARTIE<br>POUR REJOINDRE UN AMI</div>
        <!-- CTA -->
        <div style="display:flex;align-items:center;gap:10px;font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:3px;color:rgba(140,180,255,.7);">
          <div style="width:28px;height:1px;background:rgba(140,180,255,.5);"></div>REJOINDRE
        </div>
      </div>

    </div>

    <!-- Info strip -->
    <div style="margin-top:clamp(16px,3vh,28px);display:flex;align-items:center;gap:12px;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:rgba(140,180,220,.35);">
      <div style="width:20px;height:1px;background:rgba(80,160,255,.2);"></div>
      PARTAGEZ L'ID DU SERVEUR AVEC VOS AMIS
      <div style="width:20px;height:1px;background:rgba(80,160,255,.2);"></div>
    </div>

    <!-- Back button -->
    <button class="bbtn" onclick="showScreen('screen-play')" style="margin-top:clamp(16px,3vh,28px);">â† RETOUR</button>
  </div>
</div>

<!-- GARAGE -->
<div class="screen" id="screen-garage">
<div class="sub-wrap">
<div class="screen-title">GARAGE</div>
  <div class="garage-inner">
    <div style="display:flex;flex-direction:column;align-items:center;min-width:240px;flex-shrink:0;">
      <div class="rlp" id="garage-car-wrap" style="padding:12px;width:100%;margin-bottom:10px"><canvas id="garageCanvas" style="width:100%;height:auto;display:block;"></canvas></div>
      <button class="pbtn" style="font-size:13px;padding:11px 28px" onclick="applyGarage()">APPLIQUER âœ“</button>
    </div>
    <div class="rlp" style="flex:1;padding:18px;max-height:62vh;overflow-y:auto">
      <div class="gsec">CARROSSERIE</div>
      <div id="car-opts" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px"></div>
      <div class="gsec">COULEUR PRINCIPALE</div>
      <div id="cp1" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px"></div>
      <div class="gsec">COULEUR SECONDAIRE</div>
      <div id="cp2" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px"></div>
      <div class="gsec">DÃ‰CAL</div>
      <div id="decal-opts" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px"></div>
      <div class="gsec">ROUES</div>
      <div id="wheel-opts" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px"></div>
    </div>
  </div>
  <button class="bbtn" onclick="showScreen('screen-main')" style="margin-top:0">â† RETOUR</button>
</div>
</div>

<!-- SHOP -->
<div class="screen" id="screen-shop">
  <div style="position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;width:100%;max-width:960px;padding:0 clamp(14px,3vw,40px);padding-bottom:80px;padding-top:clamp(20px,4vh,40px);">

    <!-- Header -->
    <div style="display:flex;align-items:flex-end;justify-content:space-between;width:100%;margin-bottom:8px;padding-bottom:14px;border-bottom:1px solid rgba(80,160,255,.1);">
      <div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:6px;color:var(--hi);opacity:.6;margin-bottom:6px;">ROTATION HORAIRE</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(28px,5vw,52px);font-weight:800;letter-spacing:4px;color:#fff;text-transform:uppercase;text-shadow:0 0 30px rgba(80,160,255,.25);">BOUTIQUE</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;justify-content:flex-end;gap:6px;padding-bottom:4px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:1px;color:rgba(140,180,220,.35);">RENOUVELLEMENT DANS</div>
          <div id="shop-next-timer" style="font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:2px;color:var(--hi);">--:--</div>
        </div>
      </div>
    </div>

    <!-- Rotation progress bar -->
    <div id="shop-rotation-bar" style="width:100%;height:2px;background:rgba(80,160,255,.08);position:relative;overflow:hidden;margin-bottom:clamp(12px,2vh,20px);">
      <div id="shop-rotation-fill" style="position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--hi2),var(--hi));width:0%;transition:width 1s linear;"></div>
    </div>

    <!-- Rarity legend -->
    <div style="display:flex;gap:clamp(8px,2vw,18px);width:100%;margin-bottom:clamp(10px,2vh,18px);flex-wrap:wrap;">
      <div style="display:flex;align-items:center;gap:5px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--r-common);">
        <div style="width:8px;height:8px;background:var(--r-common);opacity:.7;"></div>COMMUN
      </div>
      <div style="display:flex;align-items:center;gap:5px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--r-uncommon);">
        <div style="width:8px;height:8px;background:var(--r-uncommon);"></div>PEU COMMUN
      </div>
      <div style="display:flex;align-items:center;gap:5px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--r-rare);">
        <div style="width:8px;height:8px;background:var(--r-rare);"></div>RARE
      </div>
      <div style="display:flex;align-items:center;gap:5px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--r-epic);">
        <div style="width:8px;height:8px;background:var(--r-epic);"></div>Ã‰PIQUE
      </div>
      <div style="display:flex;align-items:center;gap:5px;font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;color:var(--r-legendary);">
        <div style="width:8px;height:8px;background:var(--r-legendary);"></div>LÃ‰GENDAIRE
      </div>
    </div>

    <!-- Grid -->
    <div id="shop-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:clamp(8px,1.5vw,14px);width:100%;max-height:calc(100vh - 320px);overflow-y:auto;padding-right:4px;"></div>

    <button class="bbtn" onclick="showScreen('screen-main')" style="margin-top:clamp(14px,2vh,24px);">â† RETOUR</button>
  </div>
</div>

<!-- SETTINGS -->
<div class="screen" id="screen-settings">
<div class="sub-wrap">
<div class="screen-title">PARAMÃˆTRES</div>
  <div class="rlp" style="padding:20px;width:500px;max-width:96vw">
    <div class="gsec">TOUCHES DU JEU</div>
    <div id="keybind-list"></div>
  </div>
  <button class="bbtn" onclick="exitSettings()" style="margin-top:0">â† RETOUR</button>
</div>
</div>

<!-- GAME -->
<div id="game-canvas"><canvas id="gameCanvas"></canvas></div>
<div id="game-hud">
  <div class="hud-sc">
    <div><div class="hud-t" id="hud-team-a">VOUS</div><div class="hud-n" id="score-player">0</div></div>
    <div class="hud-div"></div>
    <div class="hud-tm" id="hud-timer">3:00</div>
    <div class="hud-div"></div>
    <div><div class="hud-t" id="hud-team-b">BOTS</div><div class="hud-n" id="score-bot">0</div></div>
  </div>
  <div class="hud-bs">
    <div class="hud-bsb"><div class="hud-bsf" id="boost-fill" style="height:80%"></div></div>
    <div class="hud-bsl">BOOST</div>
  </div>
  <div class="hud-hint">ESC = PAUSE</div>
</div>
<div id="cdo"><div id="cdn">3</div></div>
<div id="goa"><div id="got">BUT !</div></div>

<!-- PAUSE -->
<div id="pm">
  <div class="pp rlp">
    <div class="pt">â¸ PAUSE</div>
    <button class="pmbtn" onclick="resumeGame()">â–¶ &nbsp;CONTINUER LE MATCH</button>
    <button class="pmbtn" onclick="openSettingsFromPause()">âš™ &nbsp;PARAMÃˆTRES</button>
    <button class="pmbtn dng" onclick="quitGame()">âœ• &nbsp;QUITTER</button>
  </div>
</div>

<!-- END SCREEN -->
<div id="es">
  <div class="er" id="end-result-text">VICTOIRE</div>
  <div class="efs" id="end-final-score">0 â€“ 0</div>
  <div class="erew" id="end-reward">+15 VAK ğŸ†</div>
  <button class="pbtn" onclick="endToMenu()" style="margin-top:8px">MENU PRINCIPAL</button>
</div>

<!-- PLAYER BAR -->
<div class="plbar" id="player-bar">
  <div class="pav" id="player-avatar" onclick="openAvatarEdit()" title="Changer logo/nom">ğŸ®</div>
  <div>
    <div style="font-size:16px;font-weight:700;letter-spacing:1px" id="player-name-display">Joueur</div>
    <div style="font-size:10px;color:var(--accent);letter-spacing:3px;text-transform:uppercase" id="player-level-display">ROOKIE Â· LVL 1</div>
    <div class="xp-bar-wrap" style="margin-top:3px"><div class="xp-bar-fill" id="xp-fill" style="width:0%"></div></div>
  </div>
  <div style="margin-left:auto;font-size:10px;color:rgba(255,255,255,.28);letter-spacing:2px">REBORN INVENTION</div>
</div>

<!-- AVATAR MODAL -->
<div id="avatar-modal" style="position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;background:rgba(0,0,20,.8);backdrop-filter:blur(8px);">
  <div class="rlp" style="width:320px;padding:26px">
    <div class="gsec">PERSONNALISATION</div>
    <div style="margin-bottom:10px">
      <label style="font-size:11px;letter-spacing:2px;color:rgba(255,255,255,.5);display:block;margin-bottom:5px">NOM DU JOUEUR</label>
      <input id="edit-name" type="text" maxlength="18" style="width:100%;background:rgba(255,255,255,.06);border:1px solid var(--border);color:#fff;font-family:'Rajdhani',sans-serif;font-size:15px;padding:8px 12px;outline:none;" placeholder="Votre nom">
    </div>
    <div style="margin-bottom:10px">
      <label style="font-size:11px;letter-spacing:2px;color:rgba(255,255,255,.5);display:block;margin-bottom:5px">LOGO (emoji)</label>
      <input id="edit-logo" type="text" maxlength="4" style="width:100%;background:rgba(255,255,255,.06);border:1px solid var(--border);color:#fff;font-family:'Rajdhani',sans-serif;font-size:20px;padding:8px 12px;text-align:center;outline:none;" placeholder="ğŸ®">
    </div>
    <div style="display:flex;gap:10px;margin-top:14px">
      <button class="pbtn" style="font-size:12px;padding:9px 22px" onclick="saveProfile()">SAUVEGARDER</button>
      <button class="bbtn" style="margin-top:0" onclick="document.getElementById('avatar-modal').style.display='none'">ANNULER</button>
    </div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="admin-panel">
  <div style="width:420px;max-width:96vw;background:rgba(4,6,14,.98);border:1px solid rgba(80,160,255,.2);border-top:2px solid var(--hi);padding:0;overflow:hidden;">
    <!-- Header -->
    <div style="background:rgba(80,160,255,.06);border-bottom:1px solid rgba(80,160,255,.12);padding:20px 24px;display:flex;align-items:center;gap:14px;">
      <div style="width:36px;height:36px;border:1px solid var(--hi);background:rgba(80,160,255,.1);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">âš™</div>
      <div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;letter-spacing:4px;color:#fff;text-transform:uppercase;">STAFF PANEL</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--hi);opacity:.6;margin-top:2px;">ACCÃˆS RESTREINT</div>
      </div>
      <button onclick="closeAdmin()" style="margin-left:auto;background:transparent;border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.4);width:28px;height:28px;cursor:pointer;font-size:14px;transition:all .12s;flex-shrink:0;" onmouseenter="this.style.borderColor='var(--red)';this.style.color='var(--red)'" onmouseleave="this.style.borderColor='rgba(255,255,255,.1)';this.style.color='rgba(255,255,255,.4)'">âœ•</button>
    </div>

    <div style="padding:24px;">
      <!-- Login -->
      <div id="admin-login-section">
        <div style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:3px;color:rgba(140,180,220,.4);text-align:center;margin-bottom:18px;">ENTREZ LE MOT DE PASSE</div>
        <div style="position:relative;margin-bottom:14px;">
          <input id="admin-pw" type="password"
            style="width:100%;background:rgba(80,160,255,.05);border:1px solid rgba(80,160,255,.2);border-bottom:2px solid var(--hi);color:#fff;font-family:'Share Tech Mono',monospace;font-size:16px;padding:12px 16px;outline:none;letter-spacing:4px;"
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            onkeydown="if(event.key==='Enter')checkAdminPw()">
        </div>
        <div style="display:flex;gap:10px;">
          <button class="pbtn" style="flex:1;font-size:14px;padding:13px;" onclick="checkAdminPw()">CONFIRMER â–¶</button>
        </div>
        <div id="admin-pw-error" style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--red);text-align:center;margin-top:10px;min-height:16px;letter-spacing:2px;"></div>
      </div>

      <!-- Tools -->
      <div id="admin-tools-section" style="display:none">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:20px;padding:10px 14px;background:rgba(68,204,119,.06);border:1px solid rgba(68,204,119,.2);">
          <span style="font-size:14px;">âœ…</span>
          <span style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;color:#44cc77;">ACCÃˆS AUTORISÃ‰</span>
        </div>

        <!-- VAK -->
        <div style="margin-bottom:16px;">
          <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:rgba(140,180,220,.5);margin-bottom:8px;">DONNER DES VAK</div>
          <div style="display:flex;gap:8px;align-items:stretch;">
            <input id="admin-vak-amount" type="number" min="1" value="100"
              style="flex:1;background:rgba(80,160,255,.05);border:1px solid rgba(80,160,255,.2);border-bottom:2px solid var(--hi);color:var(--hi);font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;padding:10px 14px;outline:none;text-align:center;letter-spacing:2px;">
            <button class="pbtn" style="font-size:13px;padding:10px 20px;white-space:nowrap;" onclick="adminGiveVak()">+ GIVE</button>
          </div>
        </div>

        <!-- XP -->
        <div style="margin-bottom:20px;">
          <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:rgba(140,180,220,.5);margin-bottom:8px;">DONNER DE L'XP</div>
          <div style="display:flex;gap:8px;align-items:stretch;">
            <input id="admin-xp-amount" type="number" min="1" value="500"
              style="flex:1;background:rgba(80,160,255,.05);border:1px solid rgba(80,160,255,.2);border-bottom:2px solid rgba(80,160,255,.5);color:var(--hi);font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;padding:10px 14px;outline:none;text-align:center;letter-spacing:2px;">
            <button class="pbtn" style="font-size:13px;padding:10px 20px;white-space:nowrap;" onclick="adminGiveXP()">+ GIVE</button>
          </div>
        </div>

        <div style="height:1px;background:rgba(80,160,255,.1);margin-bottom:16px;"></div>

        <!-- ITEMS -->
        <div style="margin-bottom:16px;">
          <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:rgba(140,180,220,.5);margin-bottom:8px;">INVENTAIRE COMPLET</div>
          <div style="display:flex;gap:8px;">
            <button class="pbtn" style="flex:1;padding:11px 8px;font-size:12px;letter-spacing:1px;" onclick="adminGiveAll()">â˜… TOUT DONNER</button>
            <button class="bbtn" style="flex:1;padding:11px 8px;font-size:12px;letter-spacing:1px;border-color:rgba(255,60,60,.4);color:rgba(255,100,100,.8);" onclick="adminUngiveAll()">âœ• TOUT RETIRER</button>
          </div>
        </div>

        <div style="height:1px;background:rgba(80,160,255,.1);margin-bottom:16px;"></div>
        <button class="bbtn" style="width:100%;padding:12px;" onclick="closeAdmin()">FERMER LE PANNEAU</button>
      </div>
    </div>
  </div>
</div>

<!-- POST-GOAL COUNTDOWN -->
<div id="goal-countdown"><div class="gc-num" id="gc-num">3</div></div>

<!-- CREATE SERVER -->
<div class="screen" id="screen-create-server">
  <div style="position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;width:100%;max-width:760px;padding:clamp(16px,3vh,36px) 20px clamp(60px,8vh,100px);">

    <!-- Header -->
    <div style="text-align:center;margin-bottom:clamp(14px,3vh,28px);width:100%;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:7px;color:var(--hi);opacity:.6;margin-bottom:8px;">MULTIJOUEUR</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(24px,4vw,44px);font-weight:800;letter-spacing:5px;color:#fff;text-transform:uppercase;text-shadow:0 0 30px rgba(80,160,255,.3);">CRÃ‰ER UN SERVEUR</div>
      <div style="width:50px;height:2px;background:var(--hi);margin:10px auto 0;opacity:.5;"></div>
    </div>

    <div style="display:flex;gap:clamp(10px,2vw,20px);width:100%;flex-wrap:wrap;">

      <!-- Left: Map preview + selection -->
      <div style="flex:1;min-width:220px;display:flex;flex-direction:column;gap:10px;">
        <!-- Map preview canvas -->
        <div style="background:rgba(4,8,18,.9);border:1px solid rgba(80,160,255,.18);border-top:2px solid var(--hi);position:relative;overflow:hidden;">
          <canvas id="srv-map-preview" width="320" height="160" style="width:100%;display:block;"></canvas>
          <div id="srv-map-name-overlay" style="position:absolute;bottom:0;left:0;right:0;padding:8px 12px;background:linear-gradient(0deg,rgba(4,8,18,.95),transparent);font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;letter-spacing:3px;color:#fff;text-transform:uppercase;"></div>
        </div>
        <!-- Map tabs -->
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="tbtn active" id="srv-map-0" onclick="selectSrvMapAndSync(0)" style="flex:1;">ğŸœ Scorched</button>
          <button class="tbtn" id="srv-map-1" onclick="selectSrvMapAndSync(1)" style="flex:1;">ğŸ§Š Arctic</button>
          <button class="tbtn" id="srv-map-2" onclick="selectSrvMapAndSync(2)" style="flex:1;">ğŸŒ¿ Tokyo</button>
        </div>
        <!-- Duration -->
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:rgba(140,180,220,.5);margin-top:4px;">DURÃ‰E</div>
        <div style="display:flex;gap:6px;">
          <button class="tbtn" id="srv-t-2" onclick="selectSrvTimeAndSync(120)" style="flex:1;">2 MIN</button>
          <button class="tbtn active" id="srv-t-3" onclick="selectSrvTimeAndSync(180)" style="flex:1;">3 MIN</button>
          <button class="tbtn" id="srv-t-5" onclick="selectSrvTimeAndSync(300)" style="flex:1;">5 MIN</button>
        </div>
      </div>

      <!-- Right: Server ID + Players -->
      <div style="flex:1;min-width:200px;display:flex;flex-direction:column;gap:10px;">

        <!-- Server ID with copy -->
        <div style="background:rgba(4,8,18,.9);border:1px solid rgba(80,160,255,.18);border-top:2px solid var(--hi);padding:16px 18px;">
          <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:rgba(140,180,220,.45);margin-bottom:10px;">CODE DE SESSION</div>
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <div id="srv-id-display" style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(28px,4vw,40px);font-weight:800;color:var(--hi);letter-spacing:6px;flex:1;">------</div>
            <button id="srv-copy-btn" onclick="copyServerId()" title="Copier le code"
              style="background:rgba(80,160,255,.08);border:1px solid rgba(80,160,255,.25);color:var(--hi);width:40px;height:40px;cursor:pointer;font-size:16px;transition:all .15s;flex-shrink:0;"
              onmouseenter="this.style.background='rgba(80,160,255,.18)';this.style.borderColor='var(--hi)'"
              onmouseleave="this.style.background='rgba(80,160,255,.08)';this.style.borderColor='rgba(80,160,255,.25)'">â˜</button>
          </div>
          <div id="srv-copy-feedback" style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:#44cc77;min-height:14px;transition:opacity .3s;opacity:0;">âœ“ CODE COPIÃ‰ !</div>
          <div style="height:1px;background:rgba(80,160,255,.08);margin:10px 0;"></div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:rgba(140,180,220,.35);">PARTAGEZ CE CODE AVEC VOS AMIS</div>
        </div>

        <!-- Players list -->
        <div style="background:rgba(4,8,18,.9);border:1px solid rgba(80,160,255,.12);padding:14px 18px;flex:1;">
          <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:rgba(140,180,220,.45);margin-bottom:10px;">JOUEURS â€” <span id="srv-member-count">1</span>/4</div>
          <div id="srv-members-list" style="font-family:'Barlow Condensed',sans-serif;font-size:15px;color:#fff;line-height:2.2;"></div>
        </div>

        <!-- Actions -->
        <div style="display:flex;gap:8px;">
          <button class="pbtn" onclick="launchMultiGame()" id="launch-multi-btn" style="flex:1;font-size:15px;padding:13px;">LANCER â–¶</button>
          <button class="bbtn" onclick="leaveServer()" style="margin-top:0;padding:13px 18px;">â† QUITTER</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JOIN SERVER -->
<div class="screen" id="screen-join-server">
  <div style="position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;width:100%;max-width:520px;padding:0 20px;">
    <!-- Header -->
    <div style="text-align:center;margin-bottom:clamp(20px,4vh,40px);width:100%;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:8px;color:var(--hi);opacity:.7;text-transform:uppercase;margin-bottom:10px;">MULTIJOUEUR</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:clamp(26px,4.5vw,46px);font-weight:800;letter-spacing:5px;color:#fff;text-transform:uppercase;text-shadow:0 0 40px rgba(80,160,255,.3);">REJOINDRE</div>
      <div style="width:50px;height:2px;background:var(--hi);margin:10px auto 0;opacity:.6;"></div>
    </div>

    <!-- Card -->
    <div style="width:100%;background:rgba(5,10,20,.88);border:1px solid rgba(80,160,255,.18);border-top:2px solid var(--hi);padding:clamp(24px,4vw,36px);position:relative;backdrop-filter:blur(14px);">
      <!-- Corner accent -->
      <div style="position:absolute;top:0;right:0;width:0;height:0;border-style:solid;border-width:0 32px 32px 0;border-color:transparent var(--hi) transparent transparent;opacity:.3;"></div>

      <div style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:4px;color:rgba(140,180,220,.5);margin-bottom:14px;">ENTREZ L'IDENTIFIANT DU SERVEUR</div>

      <!-- Input -->
      <div style="position:relative;margin-bottom:8px;">
        <input id="join-server-id" type="text" maxlength="6"
          style="width:100%;background:rgba(80,160,255,.05);border:1px solid rgba(80,160,255,.25);border-bottom:2px solid var(--hi);color:#fff;font-family:'Barlow Condensed',sans-serif;font-size:clamp(32px,5vw,52px);font-weight:800;padding:16px 20px;outline:none;text-align:center;letter-spacing:12px;text-transform:uppercase;transition:all .15s;"
          placeholder="Â·Â·Â·Â·Â·Â·"
          onfocus="this.style.borderBottomColor='#fff';this.style.background='rgba(80,160,255,.09)'"
          onblur="this.style.borderBottomColor='var(--hi)';this.style.background='rgba(80,160,255,.05)'">
        <!-- Scan line decoration -->
        <div style="position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--hi),transparent);opacity:.4;pointer-events:none;"></div>
      </div>

      <!-- Error -->
      <div id="join-error" style="color:var(--red);font-family:'Share Tech Mono',monospace;font-size:11px;min-height:20px;letter-spacing:2px;margin-bottom:16px;text-align:center;"></div>

      <!-- Hint -->
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;color:rgba(140,180,220,.3);text-align:center;margin-bottom:24px;">DEMANDEZ L'ID Ã€ L'HÃ”TE DE LA PARTIE</div>

      <!-- Buttons -->
      <div style="display:flex;gap:12px;">
        <button class="pbtn" onclick="joinServerAction()" style="flex:1;font-size:clamp(14px,2vw,17px);padding:16px;">REJOINDRE â–¶</button>
        <button class="bbtn" onclick="showScreen('screen-play-multi')" style="margin-top:0;padding:16px 24px;">â† RETOUR</button>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';
// =====================================================================
// STATE
// =====================================================================
const DEF_KEYS = {up:'ArrowUp',down:'ArrowDown',left:'ArrowLeft',right:'ArrowRight',boost:' '};
const S = {
  vak:   parseInt(localStorage.getItem('dvak')  || '0'),
  xp:    parseInt(localStorage.getItem('dxp')   || '0'),
  map:0, bots:1, time:180,
  car:   { model:0, c1:'#1a6fff', c2:'#ff6b00', decal:0, wheel:0 },
  owned: JSON.parse(localStorage.getItem('downed') || '[]'),
  keys:  JSON.parse(localStorage.getItem('dkeys')  || JSON.stringify(DEF_KEYS)),
  playerName: localStorage.getItem('dname')  || 'Joueur',
  playerLogo: localStorage.getItem('dlogo')  || 'ğŸ®',
};

function getLevel(xp)      { return Math.floor(xp / 200) + 1; }
function getXPForLevel(lvl){ return (lvl - 1) * 200; }
function getLevelName(lvl) { return ['ROOKIE','AMATEUR','PRO','EXPERT','LEGEND','GOD'][Math.min(lvl-1,5)]; }
function save() {
  localStorage.setItem('dvak',  S.vak);
  localStorage.setItem('dxp',   S.xp);
  localStorage.setItem('downed',JSON.stringify(S.owned));
  localStorage.setItem('dkeys', JSON.stringify(S.keys));
  localStorage.setItem('dname', S.playerName);
  localStorage.setItem('dlogo', S.playerLogo);
}

// =====================================================================
// CATALOG
// =====================================================================
const CAR_MODELS = [{name:'Octane'},{name:'Fennec'},{name:'Dominus'}];
const DECALS  = ['Aucun','Flammes','Ã‰clairs','Camouflage','Vagues','Dragon','Distortion','Tidal Stream','Biomass','Circuit','Slipstream','Hexed','Shattered','Spectre','Striker','Mainframe'];
const WHEELS  = ['Stock','Nitro','Chrono','Saffron','OEM','Infinium','Spiralis','Turbine','Raijin','Zomba','Draco','Anispray','Goldstone','Reactor','Cristiano','Apex'];
const COLS1   = ['#1a6fff','#ff2244','#00cc55','#ff6b00','#aa00ff','#ffffff','#ffdd00','#00cccc'];
const COLS2   = ['#ff6b00','#1a6fff','#111111','#ffffff','#ff2244','#ffdd00','#00cc55','#aa00ff'];
// RaritÃ©s : 0=commun, 1=peu commun, 2=rare, 3=Ã©pique, 4=lÃ©gendaire
const RARITY = [
  {key:0, label:'COMMUN',    col:'#8899aa', glow:'rgba(136,153,170,'},
  {key:1, label:'PEU COMMUN',col:'#44cc77', glow:'rgba(68,204,119,'},
  {key:2, label:'RARE',      col:'#4da6ff', glow:'rgba(77,166,255,'},
  {key:3, label:'Ã‰PIQUE',    col:'#aa44ff', glow:'rgba(170,68,255,'},
  {key:4, label:'LÃ‰GENDAIRE',col:'#ff9900', glow:'rgba(255,153,0,'},
];
const ALL_SHOP = [
  {id:'w_oem', name:'OEM',      type:'ROUES',       icon:'â­•', price:15,  col:'#888888', rarity:0},
  {id:'d_cam', name:'Camo',     type:'DÃ‰CAL',       icon:'ğŸŒ¿', price:20,  col:'#00cc55', rarity:0},
  {id:'d_ltg', name:'Ã‰clairs',  type:'DÃ‰CAL',       icon:'âš¡', price:20,  col:'#ffdd00', rarity:1},
  {id:'d_fl',  name:'Flammes',  type:'DÃ‰CAL',       icon:'ğŸ”¥', price:25,  col:'#ff4400', rarity:1},
  {id:'w_nit', name:'Nitro',    type:'ROUES',       icon:'ğŸ”µ', price:30,  col:'#00b4ff', rarity:1},
  {id:'w_saf', name:'Saffron',  type:'ROUES',       icon:'ğŸŸ¡', price:45,  col:'#ff9900', rarity:2},
  {id:'d_drg', name:'Dragon',   type:'DÃ‰CAL',       icon:'ğŸ‰', price:60,  col:'#aa00ff', rarity:2},
  {id:'c_fen', name:'Fennec',   type:'CARROSSERIE', icon:'ğŸš—', price:100, col:'#ff6b00', rarity:3},
  {id:'w_inf', name:'Infinium', type:'ROUES',       icon:'âš™ï¸', price:80,  col:'#ffd700', rarity:3},
  {id:'d_wv',  name:'Vagues',   type:'DÃ‰CAL',       icon:'ğŸŒŠ', price:35,  col:'#0099ff', rarity:2},
  {id:'w_chro',name:'Chrono',   type:'ROUES',       icon:'â±', price:55,  col:'#00cccc', rarity:2},
  {id:'c_dom', name:'Dominus X',type:'CARROSSERIE', icon:'ğŸï¸', price:200, col:'#ff0066', rarity:4},
  {id:'d_pls', name:'Pulse',    type:'DÃ‰CAL',       icon:'ğŸ’«', price:90,  col:'#ff44ff', rarity:3},
  {id:'w_aur', name:'Aurora',   type:'ROUES',       icon:'ğŸŒˆ', price:160, col:'#ff9900', rarity:4},
  {id:'d_blk', name:'Blackout', type:'DÃ‰CAL',       icon:'ğŸ–¤', price:120, col:'#444455', rarity:3},
  {id:'w_spi', name:'Spiralis',  type:'ROUES', icon:'ğŸŒ€', price:40,  col:'#00ffcc', rarity:1},
  {id:'w_tur', name:'Turbine',   type:'ROUES', icon:'âš™ï¸', price:50,  col:'#888888', rarity:2},
  {id:'w_raj', name:'Raijin',    type:'ROUES', icon:'âš¡', price:70,  col:'#00ccff', rarity:2},
  {id:'w_zom', name:'Zomba',     type:'ROUES', icon:'ğŸ’€', price:120, col:'#aa00ff', rarity:3},
  {id:'w_dra', name:'Draco',     type:'ROUES', icon:'ğŸ”¥', price:150, col:'#ff4400', rarity:4},
  {id:'w_ani', name:'Anispray',  type:'ROUES', icon:'ğŸ¨', price:90,  col:'#ff00aa', rarity:3},
  {id:'w_gld', name:'Goldstone', type:'ROUES', icon:'âœ¨', price:80,  col:'#ffd700', rarity:3},
  {id:'w_rea', name:'Reactor',   type:'ROUES', icon:'â˜¢ï¸', price:110, col:'#00ff88', rarity:3},
  {id:'w_cri', name:'Cristiano', type:'ROUES', icon:'ğŸ’', price:200, col:'#88ddff', rarity:4},
  {id:'w_apx', name:'Apex',      type:'ROUES', icon:'ğŸ†', price:250, col:'#ff6600', rarity:4},
  {id:'d_dis', name:'Distortion',   type:'DÃ‰CAL', icon:'ã€°ï¸', price:35,  col:'#ff0066', rarity:1},
  {id:'d_tid', name:'Tidal Stream', type:'DÃ‰CAL', icon:'ğŸŒŠ', price:45,  col:'#0066ff', rarity:2},
  {id:'d_bio', name:'Biomass',      type:'DÃ‰CAL', icon:'ğŸ§¬', price:55,  col:'#00ff44', rarity:2},
  {id:'d_cir', name:'Circuit',      type:'DÃ‰CAL', icon:'ğŸ”Œ', price:65,  col:'#00ffff', rarity:2},
  {id:'d_sli', name:'Slipstream',   type:'DÃ‰CAL', icon:'ğŸ’¨', price:75,  col:'#4488ff', rarity:2},
  {id:'d_hex', name:'Hexed',        type:'DÃ‰CAL', icon:'â¬¡',  price:90,  col:'#ffaa00', rarity:3},
  {id:'d_sha', name:'Shattered',    type:'DÃ‰CAL', icon:'ğŸ’¥', price:100, col:'#ff4488', rarity:3},
  {id:'d_spe', name:'Spectre',      type:'DÃ‰CAL', icon:'ğŸ‘»', price:130, col:'#8844ff', rarity:3},
  {id:'d_str', name:'Striker',      type:'DÃ‰CAL', icon:'âš½', price:180, col:'#ff6600', rarity:4},
  {id:'d_mai', name:'Mainframe',    type:'DÃ‰CAL', icon:'ğŸ–¥', price:220, col:'#00ffff', rarity:4},
];
// Current shop rotation â€” 6 items chosen by the current hour seed
let SHOP = [];
function getShopRotation() {
  const now = new Date();
  const seed = now.getFullYear() * 100000 + (now.getMonth()+1) * 1000 + now.getDate() * 24 + now.getHours();
  // Seeded shuffle: always pick same 6 items for the same hour
  const arr = [...ALL_SHOP];
  let s = seed;
  for(let i=arr.length-1;i>0;i--){s=(s*1664525+1013904223)&0xffffffff;const j=Math.abs(s)%(i+1);[arr[i],arr[j]]=[arr[j],arr[i]];}
  // Ensure at least 1 epic/legendary if possible
  const guaranteed = arr.filter(x=>x.rarity>=3).slice(0,1);
  const rest = arr.filter(x=>x.rarity<3).slice(0,5);
  return [...guaranteed,...rest].slice(0,6);
}
function initShop(){ SHOP = getShopRotation(); }
initShop();

// Expose legacy SHOP ref used elsewhere

// =====================================================================
// MAP THEMES
// =====================================================================
const MAPS = [
  {
    name:'Scorched Earth', skyT:'#1a0600', skyB:'#3d1200',
    fCol:['#6b3210','#7a3a12','#5c2808'],
    lCol:'rgba(255,180,60,.5)', fog:'rgba(255,60,0,.07)',
    decor:(ctx,FX,FY,FW,FH,W,H)=>{
      const sg=ctx.createRadialGradient(W*.82,H*.1,0,W*.82,H*.1,100);
      sg.addColorStop(0,'rgba(60,160,255,.85)');sg.addColorStop(.35,'rgba(20,100,255,.35)');sg.addColorStop(1,'transparent');
      ctx.fillStyle=sg;ctx.fillRect(0,0,W,H*.5);
      ctx.strokeStyle='rgba(255,80,0,.28)';ctx.lineWidth=2;
      for(let i=0;i<5;i++){ctx.beginPath();const sx=FX-60+i*FW/4;ctx.moveTo(sx,FY-30);ctx.bezierCurveTo(sx-20,FY+FH*.25,sx+15,FY+FH*.6,sx-10,FY+FH+30);ctx.stroke();}
      ctx.fillStyle='rgba(70,25,8,.75)';
      [[FX-75,FY+FH*.65,38,25],[FX+FW+25,FY+FH*.35,50,35],[FX+FW*.08,FY-28,32,22],[FX+FW*.88,FY-22,42,28]].forEach(([x,y,w,h])=>{ctx.beginPath();ctx.ellipse(x,y,w,h,0,0,Math.PI*2);ctx.fill();});
    },
    particles:'ember'
  },
  {
    name:'Arctic Freeze', skyT:'#000a1a', skyB:'#001430',
    fCol:['#1a3555','#1e3d62','#162d4a'],
    lCol:'rgba(100,200,255,.45)', fog:'rgba(0,100,200,.05)',
    decor:(ctx,FX,FY,FW,FH,W,H)=>{
      ctx.fillStyle='rgba(255,255,255,.75)';
      for(let i=0;i<60;i++){const sx=((i*137.508)%1)*W,sy=((i*97.3)%0.25)*H;ctx.beginPath();ctx.arc(sx,sy,((i%3)*.4)+.3,0,Math.PI*2);ctx.fill();}
      for(let i=0;i<4;i++){const ay=H*.06+i*H*.05;const ag=ctx.createLinearGradient(0,ay,W,ay+H*.08);ag.addColorStop(0,'transparent');ag.addColorStop(.3,`rgba(0,200,120,.${14-i*2})`);ag.addColorStop(1,'transparent');ctx.fillStyle=ag;ctx.fillRect(0,0,W,H*.45);}
    },
    particles:'snow'
  },
  {
    name:'Neo Tokyo', skyT:'#020a00', skyB:'#081a04',
    fCol:['#0c2008','#0e2408','#0a1c06'],
    lCol:'rgba(80,255,120,.4)', fog:'rgba(0,200,50,.04)',
    decor:(ctx,FX,FY,FW,FH,W,H)=>{
      [[.04,.52,.055,.33],[.1,.44,.05,.41],[.7,.43,.065,.42],[.86,.42,.05,.43]].forEach(([x,y,w,h])=>{ctx.fillStyle='rgba(0,30,8,.7)';ctx.fillRect(W*x,H*y,W*w,H*h);for(let r=0;r<8;r++)for(let c=0;c<3;c++){if(Math.random()>.5){ctx.fillStyle='rgba(0,255,100,.3)';ctx.fillRect(W*x+c*W*w*.3+2,H*y+r*8+4,W*w*.2,4);}}});
      ctx.strokeStyle='rgba(0,255,80,.35)';ctx.lineWidth=2;ctx.strokeRect(FX+4,FY+4,FW-8,FH-8);
    },
    particles:'leaf'
  },
];

// =====================================================================
// UTILS
// =====================================================================
function notify(msg) { const n=document.getElementById('notif'); n.textContent=msg; n.classList.add('show'); setTimeout(()=>n.classList.remove('show'),2800); }
function updateVak() {
  document.getElementById('vak-amount').textContent = S.vak;
}
function updatePlayerBar() {
  const lvl=getLevel(S.xp), lvlXP=getXPForLevel(lvl), nextXP=getXPForLevel(lvl+1);
  const pct=Math.min(100,Math.floor((S.xp-lvlXP)/(nextXP-lvlXP)*100));
  document.getElementById('player-name-display').textContent = S.playerName;
  document.getElementById('player-level-display').textContent = `${getLevelName(lvl)} Â· LVL ${lvl}`;
  document.getElementById('xp-fill').style.width = pct+'%';
  document.getElementById('player-avatar').textContent = S.playerLogo;
}
function addXP(amount) {
  const oldLvl=getLevel(S.xp); S.xp+=amount; const newLvl=getLevel(S.xp);
  save(); updatePlayerBar(); notify(`+${amount} XP !`);
  if(newLvl>oldLvl) setTimeout(()=>notify(`ğŸ‰ LEVEL UP ! LVL ${newLvl} !`),1500);
}
function shade(hex,p) {
  const n=parseInt(hex.replace('#',''),16);
  const r=Math.min(255,Math.max(0,((n>>16)&0xff)+p)), g=Math.min(255,Math.max(0,((n>>8)&0xff)+p)), b=Math.min(255,Math.max(0,(n&0xff)+p));
  return `#${((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1)}`;
}

// =====================================================================
// PROFILE / ADMIN
// =====================================================================
function openAvatarEdit() { document.getElementById('edit-name').value=S.playerName; document.getElementById('edit-logo').value=S.playerLogo; document.getElementById('avatar-modal').style.display='flex'; }
function saveProfile() {
  S.playerName=(document.getElementById('edit-name').value.trim()||'Joueur').slice(0,18);
  S.playerLogo=(document.getElementById('edit-logo').value.trim()||'ğŸ®').slice(0,4);
  save(); updatePlayerBar(); document.getElementById('avatar-modal').style.display='none'; notify('âœ… Profil mis Ã  jour !');
}
function openAdmin() { document.getElementById('admin-panel').classList.add('show'); document.getElementById('admin-pw').value=''; document.getElementById('admin-login-section').style.display=''; document.getElementById('admin-tools-section').style.display='none'; }
function closeAdmin() { document.getElementById('admin-panel').classList.remove('show'); }
function checkAdminPw() {
  const err=document.getElementById('admin-pw-error');
  if(document.getElementById('admin-pw').value==='Vaking.'){
    document.getElementById('admin-login-section').style.display='none';
    document.getElementById('admin-tools-section').style.display='block';
    if(err) err.textContent='';
  } else {
    if(err) err.textContent='âŒ MOT DE PASSE INCORRECT';
    document.getElementById('admin-pw').value='';
    document.getElementById('admin-pw').style.borderBottomColor='var(--red)';
    setTimeout(()=>{ const el=document.getElementById('admin-pw'); if(el)el.style.borderBottomColor='var(--hi)'; },1000);
  }
}
function adminGiveVak() { const a=parseInt(document.getElementById('admin-vak-amount').value)||100; S.vak+=a; save(); updateVak(); notify(`âœ… +${a} VAK ajoutÃ©s`); }
function adminGiveXP()  { const a=parseInt(document.getElementById('admin-xp-amount').value)||500; addXP(a); }
function adminGiveAll() {
  const allIds = ALL_SHOP.map(it=>it.id);
  allIds.forEach(id=>{ if(!S.owned.includes(id)) S.owned.push(id); });
  save(); notify(`âœ… ${allIds.length} items dÃ©bloquÃ©s !`);
  if(typeof renderGarageUI==='function') renderGarageUI();
  if(typeof renderShop==='function') renderShop();
}
function adminUngiveAll() {
  S.owned = [];
  // RÃ©initialiser les sÃ©lections si elles pointent vers un item non possÃ©dÃ©
  if(!['','c_fen','c_dom'][S.car.model]) S.car.model=0;
  S.car.decal=0; S.car.wheel=0;
  save(); notify('âœ• Inventaire vidÃ©');
  if(typeof renderGarageUI==='function') renderGarageUI();
  if(typeof renderShop==='function') renderShop();
}

// =====================================================================
// SCREENS / NAVIGATION
// =====================================================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const s=document.getElementById(id); if(s) s.classList.add('active');
  const menuScreens=['screen-main','screen-play','screen-play-solo','screen-play-multi','screen-garage','screen-shop','screen-settings','screen-create-server','screen-join-server'];
  const inMenu=menuScreens.includes(id);
  document.getElementById('player-bar').style.display = inMenu?'flex':'none';
  document.getElementById('vak-display').style.display= inMenu?'flex':'none';
  if(id==='screen-garage') renderGarageUI();
  if(id==='screen-shop') renderShop();
  if(id==='screen-main'){ renderMenuCar(); setTimeout(renderNewsCar,50); }
  if(id==='screen-settings') renderSettings();
  if(id==='screen-play-solo') { drawMapPreviews(); }
  if(id==='screen-create-server') { setTimeout(()=>renderSrvMapPreview(S.map||0), 50); }
}
function switchPlayTab(tab) {
  if(tab==='solo') showScreen('screen-play-solo');
  else showScreen('screen-play-multi');
}
function renderAllMapPreviews(){ drawMapPreviews(); }
function selectMap(i)  { S.map=i; document.querySelectorAll('.mc').forEach((c,x)=>c.classList.toggle('selected',x===i)); }
function selectBots(n) { S.bots=n; document.querySelectorAll('.botbtn').forEach((b,i)=>b.classList.toggle('active',i+1===n)); }
function selectTime(s) {
  S.time=s; document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('active'));
  const ids={120:'t-2',180:'t-3',300:'t-5',420:'t-7',600:'t-10'};
  if(ids[s]){const el=document.getElementById(ids[s]);if(el)el.classList.add('active');}
}
function selectSrvMap(i)  {
  document.querySelectorAll('[id^="srv-map-"]').forEach((b,x)=>b.classList.toggle('active',x===i));
  S.map=i;
  renderSrvMapPreview(i);
}
function selectSrvTime(s) { document.querySelectorAll('[id^="srv-t-"]').forEach(b=>b.classList.remove('active')); const ids={120:'srv-t-2',180:'srv-t-3',300:'srv-t-5'}; if(ids[s])document.getElementById(ids[s]).classList.add('active'); S.time=s; }

function renderSrvMapPreview(mapIdx) {
  const c=document.getElementById('srv-map-preview'); if(!c) return;
  const W=c.width, H=c.height;
  const ctx=c.getContext('2d'); ctx.clearRect(0,0,W,H);
  const t=MAPS[mapIdx||S.map||0];
  if(!t) return;
  const sky=ctx.createLinearGradient(0,0,0,H); sky.addColorStop(0,t.skyT); sky.addColorStop(1,t.skyB);
  ctx.fillStyle=sky; ctx.fillRect(0,0,W,H);
  const FX=W*.1, FY=H*.15, FW=W*.8, FH=H*.7;
  ctx.fillStyle=t.fCol[0]; ctx.fillRect(FX,FY,FW,FH);
  // Stripes
  for(let i=0;i<8;i++){ctx.fillStyle=i%2===0?t.fCol[1]:t.fCol[2];ctx.fillRect(FX+FW/8*i,FY,FW/8,FH);}
  try{t.decor(ctx,FX,FY,FW,FH,W,H);}catch(e){}
  ctx.strokeStyle=t.lCol; ctx.lineWidth=2; ctx.strokeRect(FX,FY,FW,FH);
  // Center line + circle
  ctx.strokeStyle=t.lCol; ctx.lineWidth=1.5; ctx.setLineDash([4,3]);
  ctx.beginPath(); ctx.moveTo(W/2,FY); ctx.lineTo(W/2,FY+FH); ctx.stroke();
  ctx.setLineDash([]);
  ctx.beginPath(); ctx.arc(W/2,FY+FH/2,FH*.18,0,Math.PI*2); ctx.stroke();
  // Goals
  const GH=FH*.28, GY=FY+FH/2-GH/2;
  ctx.fillStyle='rgba(80,160,255,.15)'; ctx.strokeStyle='rgba(80,160,255,.5)'; ctx.lineWidth=1.5;
  ctx.fillRect(FX-W*.04,GY,W*.04,GH); ctx.strokeRect(FX-W*.04,GY,W*.04,GH);
  ctx.fillRect(FX+FW,GY,W*.04,GH); ctx.strokeRect(FX+FW,GY,W*.04,GH);
  // Map name
  const names=['SCORCHED EARTH','ARCTIC FREEZE','NEO TOKYO'];
  const nameEl=document.getElementById('srv-map-name-overlay');
  if(nameEl) nameEl.textContent = (MAPS[mapIdx||S.map||0]?.name)||names[mapIdx||0]||'';
}

function copyServerId() {
  const id=document.getElementById('srv-id-display')?.textContent||'';
  if(!id||id==='------') return;
  navigator.clipboard.writeText(id).then(()=>{
    const fb=document.getElementById('srv-copy-feedback');
    const btn=document.getElementById('srv-copy-btn');
    if(fb){fb.style.opacity='1'; setTimeout(()=>fb.style.opacity='0',2000);}
    if(btn){btn.textContent='âœ“'; setTimeout(()=>btn.textContent='â˜',2000);}
  }).catch(()=>{
    // Fallback for older browsers
    const ta=document.createElement('textarea'); ta.value=id;
    ta.style.position='fixed'; ta.style.opacity='0';
    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
    const fb=document.getElementById('srv-copy-feedback');
    if(fb){fb.style.opacity='1'; setTimeout(()=>fb.style.opacity='0',2000);}
  });
}

// =====================================================================
// MAP PREVIEW
// =====================================================================
function drawMapPreviews() {
  [0,1,2].forEach(i=>{
    const c=document.getElementById(`mpv-${i}`); if(!c) return;
    const ctx=c.getContext('2d'); ctx.clearRect(0,0,180,95);
    const t=MAPS[i];
    const sky=ctx.createLinearGradient(0,0,0,95); sky.addColorStop(0,t.skyT); sky.addColorStop(1,t.skyB);
    ctx.fillStyle=sky; ctx.fillRect(0,0,180,95);
    ctx.fillStyle=t.fCol[0]; ctx.fillRect(18,28,144,67);
    t.decor(ctx,18,28,144,67,180,95);
    ctx.strokeStyle=t.lCol; ctx.lineWidth=1.5; ctx.strokeRect(18,28,144,67);
  });
}

// =====================================================================
// WHEEL DRAWING â€” 16 designs inspirÃ©s Rocket League
// =====================================================================
function drawWheel(ctx,cx,cy,r,style,c2,spin=0){
  ctx.save();ctx.translate(cx,cy);ctx.rotate(spin);
  ctx.shadowColor='rgba(0,0,0,.5)';ctx.shadowBlur=r*.4;ctx.shadowOffsetY=r*.1;
  ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);
  if(style===0){
    // STOCK â€” 5 branches Ã©paisses anthracite
    const g=ctx.createRadialGradient(0,0,0,0,0,r);g.addColorStop(0,'#3a3a3a');g.addColorStop(1,'#1a1a1a');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    for(let i=0;i<5;i++){const a=i*Math.PI*2/5-Math.PI/2;ctx.save();ctx.rotate(a);ctx.fillStyle='#555';ctx.beginPath();ctx.moveTo(-r*.09,r*.05);ctx.lineTo(r*.09,r*.05);ctx.lineTo(r*.07,r*.88);ctx.lineTo(-r*.07,r*.88);ctx.closePath();ctx.fill();ctx.fillStyle='#444';ctx.beginPath();ctx.arc(0,r*.72,r*.13,0,Math.PI*2);ctx.fill();ctx.restore();}
    const cg=ctx.createRadialGradient(-r*.06,-r*.06,0,0,0,r*.28);cg.addColorStop(0,'#666');cg.addColorStop(1,'#333');ctx.beginPath();ctx.arc(0,0,r*.28,0,Math.PI*2);ctx.fillStyle=cg;ctx.fill();
  }else if(style===1){
    // NITRO â€” 5 rayons fins, bord cerclÃ© c2
    const g=ctx.createRadialGradient(0,0,r*.1,0,0,r);g.addColorStop(0,'#111');g.addColorStop(.7,'#0d0d0d');g.addColorStop(1,c2+'bb');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    ctx.strokeStyle=c2;ctx.lineWidth=r*.14;ctx.beginPath();ctx.arc(0,0,r*.82,0,Math.PI*2);ctx.stroke();
    for(let i=0;i<5;i++){const a=i*Math.PI*2/5;ctx.strokeStyle=c2+'cc';ctx.lineWidth=r*.08;ctx.beginPath();ctx.moveTo(Math.cos(a)*r*.22,Math.sin(a)*r*.22);ctx.lineTo(Math.cos(a)*r*.75,Math.sin(a)*r*.75);ctx.stroke();}
    ctx.beginPath();ctx.arc(0,0,r*.22,0,Math.PI*2);ctx.fillStyle=c2;ctx.fill();
  }else if(style===2){
    // CHRONO â€” double cercle + 6 nervures futuristes
    const g=ctx.createRadialGradient(0,0,0,0,0,r);g.addColorStop(0,'#1a1a2e');g.addColorStop(1,'#0d0d18');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    [.72,.45].forEach((fr,idx)=>{ctx.strokeStyle=idx===0?'#00b4ff':'#0066aa';ctx.lineWidth=r*.07;ctx.beginPath();ctx.arc(0,0,r*fr,0,Math.PI*2);ctx.stroke();});
    for(let i=0;i<6;i++){ctx.save();ctx.rotate(i*Math.PI/3);ctx.fillStyle='#00b4ff55';ctx.fillRect(-r*.04,r*.12,r*.08,r*.55);ctx.strokeStyle='#00b4ffaa';ctx.lineWidth=r*.04;ctx.strokeRect(-r*.04,r*.12,r*.08,r*.55);ctx.restore();}
    const cg=ctx.createRadialGradient(0,0,0,0,0,r*.18);cg.addColorStop(0,'#00e5ff');cg.addColorStop(1,'#0066aa');ctx.beginPath();ctx.arc(0,0,r*.18,0,Math.PI*2);ctx.fillStyle=cg;ctx.fill();
  }else if(style===3){
    // SAFFRON â€” 4 branches larges dorÃ©es
    const g=ctx.createRadialGradient(0,0,0,0,0,r);g.addColorStop(0,'#2a1800');g.addColorStop(1,'#0f0800');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    ctx.strokeStyle='#ff9900';ctx.lineWidth=r*.12;ctx.beginPath();ctx.arc(0,0,r*.88,0,Math.PI*2);ctx.stroke();
    for(let i=0;i<4;i++){ctx.save();ctx.rotate(i*Math.PI/2);const sg=ctx.createLinearGradient(-r*.14,0,r*.14,0);sg.addColorStop(0,'#ffcc00');sg.addColorStop(.5,'#ff9900');sg.addColorStop(1,'#cc6600');ctx.fillStyle=sg;ctx.beginPath();ctx.moveTo(-r*.14,r*.2);ctx.lineTo(r*.14,r*.2);ctx.lineTo(r*.08,r*.85);ctx.lineTo(-r*.08,r*.85);ctx.closePath();ctx.fill();ctx.restore();}
    const cg=ctx.createRadialGradient(-r*.06,-r*.06,0,0,0,r*.25);cg.addColorStop(0,'#ffe066');cg.addColorStop(1,'#aa5500');ctx.beginPath();ctx.arc(0,0,r*.25,0,Math.PI*2);ctx.fillStyle=cg;ctx.fill();
  }else if(style===4){
    // OEM â€” 8 bÃ¢tonnets fins modernes
    const g=ctx.createRadialGradient(-r*.2,-r*.2,r*.05,0,0,r);g.addColorStop(0,'#d8d8d8');g.addColorStop(.5,'#b0b0b0');g.addColorStop(1,'#888');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    ctx.strokeStyle='#777';ctx.lineWidth=r*.06;ctx.beginPath();ctx.arc(0,0,r*.9,0,Math.PI*2);ctx.stroke();
    for(let i=0;i<8;i++){ctx.save();ctx.rotate(i*Math.PI/4);ctx.fillStyle=i%2===0?'#aaa':'#999';ctx.fillRect(-r*.045,r*.28,r*.09,r*.58);ctx.restore();}
    const cg=ctx.createRadialGradient(-r*.05,-r*.05,0,0,0,r*.22);cg.addColorStop(0,'#eee');cg.addColorStop(1,'#999');ctx.beginPath();ctx.arc(0,0,r*.22,0,Math.PI*2);ctx.fillStyle=cg;ctx.fill();
  }else if(style===5){
    // INFINIUM â€” 3 arcs arc-en-ciel
    ctx.fillStyle='#0a0a0a';ctx.fill();ctx.shadowColor='transparent';
    for(let i=0;i<3;i++){const a0=i*Math.PI*2/3,a1=a0+Math.PI*2/3-.22;const sg=ctx.createLinearGradient(Math.cos(a0)*r,Math.sin(a0)*r,Math.cos(a1)*r,Math.sin(a1)*r);sg.addColorStop(0,`hsl(${i*120},100%,55%)`);sg.addColorStop(.5,`hsl(${i*120+60},100%,65%)`);sg.addColorStop(1,`hsl(${i*120+120},100%,55%)`);ctx.strokeStyle=sg;ctx.lineWidth=r*.22;ctx.beginPath();ctx.arc(0,0,r*.72,a0,a1);ctx.stroke();}
    ctx.beginPath();ctx.arc(0,0,r*.2,0,Math.PI*2);ctx.fillStyle='#111';ctx.fill();
  }else if(style===6){
    // SPIRALIS â€” double spirale centrifuge
    const g=ctx.createRadialGradient(0,0,0,0,0,r);g.addColorStop(0,'#001a1a');g.addColorStop(1,'#000d0d');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    ctx.strokeStyle='#00ffcc';ctx.lineWidth=r*.06;ctx.beginPath();ctx.arc(0,0,r*.88,0,Math.PI*2);ctx.stroke();
    for(let arm=0;arm<2;arm++){ctx.beginPath();for(let t=0;t<=Math.PI*2.5;t+=.08){const rad=r*.15+r*.68*(t/(Math.PI*2.5));const ang=t+arm*Math.PI;t<.01?ctx.moveTo(Math.cos(ang)*rad,Math.sin(ang)*rad):ctx.lineTo(Math.cos(ang)*rad,Math.sin(ang)*rad);}ctx.strokeStyle=arm===0?'#00ffccdd':'#00aa8888';ctx.lineWidth=r*.07;ctx.stroke();}
    const cg=ctx.createRadialGradient(0,0,0,0,0,r*.18);cg.addColorStop(0,'#aaffee');cg.addColorStop(1,'#00aa88');ctx.beginPath();ctx.arc(0,0,r*.18,0,Math.PI*2);ctx.fillStyle=cg;ctx.fill();
  }else if(style===7){
    // TURBINE â€” 7 aubes courbÃ©es F1
    const g=ctx.createRadialGradient(0,0,r*.05,0,0,r);g.addColorStop(0,'#2a2a2a');g.addColorStop(1,'#111');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    for(let i=0;i<7;i++){ctx.save();ctx.rotate(i*Math.PI*2/7);const bg=ctx.createLinearGradient(-r*.07,r*.15,r*.07,r*.82);bg.addColorStop(0,'#888');bg.addColorStop(.5,'#bbb');bg.addColorStop(1,'#666');ctx.fillStyle=bg;ctx.beginPath();ctx.moveTo(-r*.07,r*.22);ctx.quadraticCurveTo(r*.18,r*.42,r*.04,r*.82);ctx.lineTo(-r*.02,r*.82);ctx.quadraticCurveTo(-r*.12,r*.42,-r*.07,r*.22);ctx.closePath();ctx.fill();ctx.restore();}
    const cg=ctx.createRadialGradient(-r*.05,-r*.05,0,0,0,r*.22);cg.addColorStop(0,'#ccc');cg.addColorStop(1,'#555');ctx.beginPath();ctx.arc(0,0,r*.22,0,Math.PI*2);ctx.fillStyle=cg;ctx.fill();
    ctx.beginPath();ctx.arc(0,0,r*.08,0,Math.PI*2);ctx.fillStyle='#222';ctx.fill();
  }else if(style===8){
    // RAIJIN â€” 8 Ã©clairs zigzag Ã©lectriques japonais
    const g=ctx.createRadialGradient(0,0,0,0,0,r);g.addColorStop(0,'#001020');g.addColorStop(1,'#000810');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    for(let i=0;i<8;i++){ctx.save();ctx.rotate(i*Math.PI/4);ctx.strokeStyle=i%2===0?'#00ccff':'#0066ff';ctx.lineWidth=r*(i%2===0?.06:.04);ctx.shadowColor='#00aaff';ctx.shadowBlur=r*.3;ctx.beginPath();ctx.moveTo(0,r*.2);ctx.lineTo(r*.08,r*.42);ctx.lineTo(-r*.04,r*.42);ctx.lineTo(r*.06,r*.72);ctx.lineTo(-r*.02,r*.72);ctx.lineTo(r*.04,r*.88);ctx.stroke();ctx.restore();}
    ctx.beginPath();ctx.arc(0,0,r*.2,0,Math.PI*2);ctx.fillStyle='#00aaff';ctx.fill();
    ctx.beginPath();ctx.arc(0,0,r*.1,0,Math.PI*2);ctx.fillStyle='#aaeeff';ctx.fill();
  }else if(style===9){
    // ZOMBA â€” cercles concentriques violets lÃ©gendaires
    const g=ctx.createRadialGradient(0,0,0,0,0,r);g.addColorStop(0,'#1a0020');g.addColorStop(1,'#0a0010');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    [.88,.68,.48].forEach((fr,idx)=>{ctx.strokeStyle=idx===0?'#cc00ff':idx===1?'#8800cc':'#5500aa';ctx.lineWidth=r*.08;ctx.beginPath();ctx.arc(0,0,r*fr,0,Math.PI*2);ctx.stroke();});
    for(let i=0;i<6;i++){ctx.save();ctx.rotate(i*Math.PI/3);ctx.fillStyle='#0a0010';ctx.fillRect(-r*.04,r*.42,r*.08,r*.15);ctx.restore();}
    const cg=ctx.createRadialGradient(0,0,0,0,0,r*.24);cg.addColorStop(0,'#ff88ff');cg.addColorStop(1,'#8800cc');ctx.beginPath();ctx.arc(0,0,r*.24,0,Math.PI*2);ctx.fillStyle=cg;ctx.fill();
  }else if(style===10){
    // DRACO â€” Ã©cailles de dragon
    const g=ctx.createRadialGradient(0,0,0,0,0,r);g.addColorStop(0,'#1a0500');g.addColorStop(1,'#080200');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    for(let row=0;row<3;row++){const radOff=r*(.28+row*.22),n=4+row*2;for(let i=0;i<n;i++){const a=i*Math.PI*2/n+(row%2?Math.PI/n:0);const px=Math.cos(a)*radOff,py=Math.sin(a)*radOff;const sg=ctx.createRadialGradient(px,py,0,px,py,r*.14);sg.addColorStop(0,'#ff6600');sg.addColorStop(.5,'#cc3300');sg.addColorStop(1,'#440000');ctx.fillStyle=sg;ctx.beginPath();ctx.ellipse(px,py,r*.12,r*.09,a,0,Math.PI*2);ctx.fill();}}
    const cg=ctx.createRadialGradient(0,0,0,0,0,r*.2);cg.addColorStop(0,'#ff8844');cg.addColorStop(1,'#cc2200');ctx.beginPath();ctx.arc(0,0,r*.2,0,Math.PI*2);ctx.fillStyle=cg;ctx.fill();
  }else if(style===11){
    // ANISPRAY â€” taches graffiti colorÃ©es
    ctx.fillStyle='#0a0a0a';ctx.fill();ctx.shadowColor='transparent';
    [[0,r*.5,r*.22,'#ff0088'],[r*.42,-r*.3,r*.2,'#00ffcc'],[-r*.38,r*.2,r*.18,'#ffcc00'],[-r*.1,-r*.55,r*.16,'#ff4400'],[r*.35,r*.4,r*.15,'#8800ff'],[-r*.45,-r*.2,r*.14,'#00aaff']].forEach(([bx,by,br,bc])=>{const bg=ctx.createRadialGradient(bx,by,0,bx,by,br);bg.addColorStop(0,bc+'ff');bg.addColorStop(.6,bc+'88');bg.addColorStop(1,bc+'00');ctx.fillStyle=bg;ctx.beginPath();ctx.arc(bx,by,br,0,Math.PI*2);ctx.fill();});
    ctx.beginPath();ctx.arc(0,0,r*.18,0,Math.PI*2);ctx.fillStyle='#111';ctx.fill();
  }else if(style===12){
    // GOLDSTONE â€” pierre d'or avec inclusions brillantes
    const g=ctx.createRadialGradient(-r*.2,-r*.2,r*.05,0,0,r);g.addColorStop(0,'#ffe566');g.addColorStop(.4,'#cc8800');g.addColorStop(1,'#6a3d00');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    ctx.strokeStyle='#ffee88';ctx.lineWidth=r*.1;ctx.beginPath();ctx.arc(0,0,r*.86,0,Math.PI*2);ctx.stroke();
    [[r*.28,r*.28,r*.07],[r*.5,-r*.35,r*.05],[-r*.4,r*.15,r*.06],[-r*.2,-r*.48,r*.04],[r*.1,r*.55,r*.05]].forEach(([px,py,pr])=>{const sg=ctx.createRadialGradient(px-pr*.3,py-pr*.3,0,px,py,pr);sg.addColorStop(0,'#fff9cc');sg.addColorStop(.5,'#ffd700');sg.addColorStop(1,'#aa6600');ctx.fillStyle=sg;ctx.beginPath();ctx.arc(px,py,pr,0,Math.PI*2);ctx.fill();});
    const cg=ctx.createRadialGradient(-r*.06,-r*.06,0,0,0,r*.22);cg.addColorStop(0,'#fff5aa');cg.addColorStop(1,'#cc8800');ctx.beginPath();ctx.arc(0,0,r*.22,0,Math.PI*2);ctx.fillStyle=cg;ctx.fill();
  }else if(style===13){
    // REACTOR â€” 6 tubes ionisants glow vert radioactif
    const g=ctx.createRadialGradient(0,0,0,0,0,r);g.addColorStop(0,'#001508');g.addColorStop(1,'#000a04');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    for(let i=0;i<6;i++){ctx.save();ctx.rotate(i*Math.PI/3);ctx.shadowColor='#00ff88';ctx.shadowBlur=r*.4;ctx.strokeStyle='#00ff88';ctx.lineWidth=r*.09;ctx.beginPath();ctx.moveTo(0,r*.18);ctx.lineTo(0,r*.78);ctx.stroke();ctx.restore();}
    ctx.strokeStyle='#00ff88';ctx.lineWidth=r*.06;ctx.shadowColor='#00ff88';ctx.shadowBlur=r*.3;ctx.beginPath();ctx.arc(0,0,r*.88,0,Math.PI*2);ctx.stroke();ctx.shadowColor='transparent';
    const cg=ctx.createRadialGradient(0,0,0,0,0,r*.2);cg.addColorStop(0,'#aaffcc');cg.addColorStop(1,'#00aa55');ctx.beginPath();ctx.arc(0,0,r*.2,0,Math.PI*2);ctx.fillStyle=cg;ctx.fill();
  }else if(style===14){
    // CRISTIANO â€” 8 facettes diamant luxueux
    const g=ctx.createRadialGradient(-r*.15,-r*.15,r*.02,0,0,r);g.addColorStop(0,'#e8f4ff');g.addColorStop(.3,'#a0c8f0');g.addColorStop(.7,'#4488cc');g.addColorStop(1,'#1a3355');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    for(let i=0;i<8;i++){ctx.save();ctx.rotate(i*Math.PI/4);const dg=ctx.createLinearGradient(-r*.1,r*.15,r*.1,r*.82);dg.addColorStop(0,'rgba(255,255,255,.9)');dg.addColorStop(.3,'rgba(180,220,255,.7)');dg.addColorStop(.7,'rgba(100,180,255,.5)');dg.addColorStop(1,'rgba(60,120,200,.8)');ctx.fillStyle=dg;ctx.beginPath();ctx.moveTo(0,r*.15);ctx.lineTo(r*.1,r*.38);ctx.lineTo(0,r*.82);ctx.lineTo(-r*.1,r*.38);ctx.closePath();ctx.fill();ctx.restore();}
    const cg=ctx.createRadialGradient(-r*.08,-r*.08,0,0,0,r*.26);cg.addColorStop(0,'#ffffff');cg.addColorStop(.4,'#aaddff');cg.addColorStop(1,'#3366aa');ctx.beginPath();ctx.arc(0,0,r*.26,0,Math.PI*2);ctx.fillStyle=cg;ctx.fill();
    [[-.12,-.12,.06],[.06,-.14,.04],[-.08,.1,.05]].forEach(([ox,oy,sr])=>{const sg=ctx.createRadialGradient(ox*r,oy*r,0,ox*r,oy*r,sr*r);sg.addColorStop(0,'rgba(255,255,255,1)');sg.addColorStop(1,'rgba(255,255,255,0)');ctx.fillStyle=sg;ctx.beginPath();ctx.arc(ox*r,oy*r,sr*r,0,Math.PI*2);ctx.fill();});
  }else if(style===15){
    // APEX â€” hexagones imbriquÃ©s e-sport haut de gamme
    const g=ctx.createRadialGradient(0,0,0,0,0,r);g.addColorStop(0,'#1a0a00');g.addColorStop(1,'#0a0500');ctx.fillStyle=g;ctx.fill();ctx.shadowColor='transparent';
    for(let row=-1;row<=1;row++)for(let col=-1;col<=1;col++){const hx=col*r*.44+(row%2)*r*.22,hy=row*r*.38;if(Math.hypot(hx,hy)<r*.75){ctx.strokeStyle='#ff440033';ctx.lineWidth=r*.04;ctx.beginPath();for(let k=0;k<6;k++){const a=k*Math.PI/3-Math.PI/6;ctx.lineTo(hx+Math.cos(a)*r*.2,hy+Math.sin(a)*r*.2);}ctx.closePath();ctx.stroke();}}
    [.82,.58,.34].forEach((fr,idx)=>{const clr=idx===0?'#ff6600':idx===1?'#ff4400':'#ff2200';ctx.strokeStyle=clr;ctx.lineWidth=r*(idx===0?.06:idx===1?.07:.08);ctx.shadowColor=clr;ctx.shadowBlur=r*.25;ctx.beginPath();for(let k=0;k<6;k++){const a=k*Math.PI/3-Math.PI/6;ctx.lineTo(Math.cos(a)*r*fr,Math.sin(a)*r*fr);}ctx.closePath();ctx.stroke();});
    ctx.shadowColor='transparent';
    const cg=ctx.createRadialGradient(0,0,0,0,0,r*.18);cg.addColorStop(0,'#ffcc88');cg.addColorStop(1,'#ff4400');ctx.beginPath();ctx.arc(0,0,r*.18,0,Math.PI*2);ctx.fillStyle=cg;ctx.fill();
  }else{ctx.fillStyle='#222';ctx.fill();ctx.shadowColor='transparent';}
  if(![1,5,6,8,9,11,14,15].includes(style)){ctx.shadowColor='transparent';ctx.beginPath();ctx.arc(0,0,r*.08,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.6)';ctx.fill();}
  ctx.restore();
}

// =====================================================================
// DECAL DRAWING â€” 16 motifs stylisÃ©s inspirÃ©s Rocket League
// =====================================================================
function drawDecal(ctx,bx,by,bw,bh,d,c2){
  if(d===0)return;
  ctx.save();
  ctx.beginPath();ctx.rect(bx-bw*.02,by-bh*.05,bw*1.04,bh*1.1);ctx.clip();
  if(d===1){
    // FLAMMES â€” feu Heatwave style, larges langues orangÃ©es
    for(let i=0;i<7;i++){
      const x=bx+bw*(.05+i*.143);
      const g=ctx.createLinearGradient(x,by+bh,x,by-bh*.1);
      g.addColorStop(0,'rgba(255,50,0,0)');g.addColorStop(.2,'rgba(255,80,0,.95)');
      g.addColorStop(.55,'rgba(255,180,0,.85)');g.addColorStop(.85,'rgba(255,255,120,.6)');g.addColorStop(1,'rgba(255,255,200,0)');
      ctx.strokeStyle=g;ctx.lineWidth=bw*.09;ctx.lineCap='round';
      ctx.beginPath();ctx.moveTo(x,by+bh);
      ctx.bezierCurveTo(x+bw*.06,by+bh*.55,x-bw*.07,by+bh*.3,x+bw*.03,by-.05*bh);ctx.stroke();
    }
  }else if(d===2){
    // Ã‰CLAIRS â€” gros Ã©clairs bien visibles style Rocket League
    for(let i=0;i<4;i++){
      const x0=bx+bw*(.1+i*.24);
      const g=ctx.createLinearGradient(x0,by,x0,by+bh);
      g.addColorStop(0,'rgba(255,255,120,0)');g.addColorStop(.3,'rgba(255,230,0,1)');
      g.addColorStop(.7,'rgba(255,160,0,.9)');g.addColorStop(1,'rgba(200,80,0,0)');
      // Glow
      ctx.strokeStyle=`rgba(255,220,0,.25)`;ctx.lineWidth=bw*.1;ctx.lineJoin='miter';
      ctx.beginPath();ctx.moveTo(x0+bw*.06,by+bh*.05);ctx.lineTo(x0-bw*.04,by+bh*.45);ctx.lineTo(x0+bw*.08,by+bh*.42);ctx.lineTo(x0-bw*.04,by+bh*.95);ctx.stroke();
      ctx.strokeStyle=g;ctx.lineWidth=bw*.05;
      ctx.beginPath();ctx.moveTo(x0+bw*.06,by+bh*.05);ctx.lineTo(x0-bw*.04,by+bh*.45);ctx.lineTo(x0+bw*.08,by+bh*.42);ctx.lineTo(x0-bw*.04,by+bh*.95);ctx.stroke();
    }
  }else if(d===3){
    // CAMOUFLAGE â€” grandes taches bien contrastÃ©es
    const shapes=[
      [.0,.0,.55,.55,'rgba(50,70,20,.75)'],[.35,.0,.7,.5,'rgba(25,45,15,.7)'],
      [.6,.1,.95,.65,'rgba(65,60,20,.72)'],[.0,.45,.45,.95,'rgba(30,55,18,.68)'],
      [.4,.5,.85,.98,'rgba(55,75,22,.7)'],[.75,.35,1.05,.9,'rgba(20,40,12,.65)']
    ];
    shapes.forEach(([x1,y1,x2,y2,col],idx)=>{
      ctx.fillStyle=col;
      ctx.beginPath();ctx.ellipse(bx+bw*(x1+x2)/2,by+bh*(y1+y2)/2,bw*(x2-x1)/2,bh*(y2-y1)/2,idx*.5,0,Math.PI*2);ctx.fill();
    });
  }else if(d===4){
    // VAGUES â€” ondes Ã©paisses bien visibles
    for(let i=0;i<5;i++){
      const yBase=by+bh*(.08+i*.19);
      const g=ctx.createLinearGradient(bx,yBase,bx+bw,yBase);
      g.addColorStop(0,c2+'00');g.addColorStop(.15,c2+'cc');g.addColorStop(.5,c2+'ff');g.addColorStop(.85,c2+'cc');g.addColorStop(1,c2+'00');
      ctx.strokeStyle=g;ctx.lineWidth=bh*.07;ctx.lineCap='round';
      ctx.beginPath();for(let xf=0;xf<=1;xf+=.015){
        const yf=yBase+Math.sin(xf*Math.PI*4.5+i*.7)*bh*.055;
        xf<.01?ctx.moveTo(bx+xf*bw,yf):ctx.lineTo(bx+xf*bw,yf);
      }ctx.stroke();
    }
  }else if(d===5){
    // DRAGON â€” Ã©cailles grandes bien contrastÃ©es rouge vif
    const scale=[['rgba(220,30,0,.85)','rgba(170,10,0,.8)','rgba(255,70,0,.75)']];
    for(let row=0;row<4;row++)for(let col=0;col<6;col++){
      const cx=bx+bw*(.08+col*.17+(row%2)*.085),cy=by+bh*(.1+row*.24),hr=bw*.09;
      const sg=ctx.createRadialGradient(cx-hr*.3,cy-hr*.3,0,cx,cy,hr);
      sg.addColorStop(0,'rgba(255,80,0,.9)');sg.addColorStop(.5,'rgba(200,20,0,.8)');sg.addColorStop(1,'rgba(80,0,0,.5)');
      ctx.fillStyle=sg;ctx.strokeStyle='rgba(60,0,0,.7)';ctx.lineWidth=bh*.02;
      ctx.beginPath();for(let k=0;k<6;k++){const a=k*Math.PI/3-Math.PI/6;ctx.lineTo(cx+Math.cos(a)*hr,cy+Math.sin(a)*hr);}ctx.closePath();ctx.fill();ctx.stroke();
    }
  }else if(d===6){
    // DISTORTION â€” effet glitch colorÃ© bien visible
    for(let i=0;i<10;i++){
      const y=by+bh*(.04+i*.095);
      const shift=Math.sin(i*2.1)*bw*.04;
      const g=ctx.createLinearGradient(bx,y,bx+bw,y);
      g.addColorStop(0,'transparent');g.addColorStop(.25,c2+'99');g.addColorStop(.5,c2+'dd');g.addColorStop(.75,c2+'99');g.addColorStop(1,'transparent');
      ctx.strokeStyle=g;ctx.lineWidth=bh*.055;
      ctx.beginPath();for(let xf=0;xf<=1;xf+=.04){
        const n=Math.sin(xf*Math.PI*8+i*1.8)*bh*.025+shift*xf;
        xf<.01?ctx.moveTo(bx+xf*bw,y+n):ctx.lineTo(bx+xf*bw,y+n);
      }ctx.stroke();
    }
  }else if(d===7){
    // TIDAL STREAM â€” grandes vagues fluides bleuâ†’cyan
    for(let i=0;i<5;i++){
      const yOff=by+bh*(.06+i*.19);
      const g=ctx.createLinearGradient(bx,by,bx+bw,by+bh);
      g.addColorStop(0,'rgba(0,60,180,0)');g.addColorStop(.35,'rgba(0,140,255,.85)');
      g.addColorStop(.65,'rgba(0,210,255,.7)');g.addColorStop(1,'rgba(0,60,180,0)');
      ctx.strokeStyle=g;ctx.lineWidth=bh*.07;ctx.lineCap='round';
      ctx.beginPath();ctx.moveTo(bx,yOff);
      ctx.bezierCurveTo(bx+bw*.25,yOff-bh*.08,bx+bw*.75,yOff+bh*.08,bx+bw,yOff);ctx.stroke();
    }
  }else if(d===8){
    // BIOMASS â€” cellules bioluminescentes grandes et brillantes
    [[.12,.18,.16],[.5,.1,.14],[.82,.32,.15],[.3,.5,.17],[.7,.62,.13],[.1,.72,.15],[.55,.82,.13],[.88,.76,.12]].forEach(([fx,fy,fr])=>{
      const cx=bx+bw*fx,cy=by+bh*fy,cr=bw*fr;
      const g=ctx.createRadialGradient(cx-cr*.3,cy-cr*.3,0,cx,cy,cr);
      g.addColorStop(0,'rgba(150,255,100,.95)');g.addColorStop(.45,'rgba(50,200,20,.75)');g.addColorStop(1,'rgba(0,100,0,0)');
      ctx.fillStyle=g;ctx.beginPath();ctx.arc(cx,cy,cr,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='rgba(100,255,50,.6)';ctx.lineWidth=bh*.025;ctx.beginPath();ctx.arc(cx,cy,cr*.85,0,Math.PI*2);ctx.stroke();
    });
  }else if(d===9){
    // CIRCUIT â€” lignes PCB plus Ã©paisses et lumineuses
    const paths=[
      [[0,.5],[.2,.5],[.2,.15],[.55,.15],[.55,.5],[.85,.5],[.85,.85],[1,.85]],
      [[0,.2],[.3,.2],[.3,.65],[.7,.65],[.7,.3],[1,.3]],
      [[0,.8],[.25,.8],[.25,.42],[.78,.42],[.78,.8],[1,.8]]
    ];
    paths.forEach((pts,idx)=>{
      const clr=idx===0?'rgba(0,255,255,.9)':idx===1?'rgba(0,200,255,.65)':'rgba(0,160,220,.5)';
      const lw=bh*(idx===0?.055:.04);
      // Glow
      ctx.strokeStyle=idx===0?'rgba(0,255,255,.2)':'rgba(0,200,255,.15)';ctx.lineWidth=lw*2.5;
      ctx.beginPath();pts.forEach(([fx,fy],i)=>{const px=bx+bw*fx,py=by+bh*fy;i===0?ctx.moveTo(px,py):ctx.lineTo(px,py);});ctx.stroke();
      ctx.strokeStyle=clr;ctx.lineWidth=lw;
      ctx.beginPath();pts.forEach(([fx,fy],i)=>{const px=bx+bw*fx,py=by+bh*fy;i===0?ctx.moveTo(px,py):ctx.lineTo(px,py);});ctx.stroke();
      pts.forEach(([fx,fy])=>{ctx.fillStyle=clr;ctx.beginPath();ctx.arc(bx+bw*fx,by+bh*fy,bh*.035,0,Math.PI*2);ctx.fill();});
    });
  }else if(d===10){
    // SLIPSTREAM â€” grandes traÃ®nÃ©es de vitesse bien visibles
    for(let i=0;i<7;i++){
      const y0=by+bh*(.02+i*.148);
      const g=ctx.createLinearGradient(bx,y0,bx+bw,y0);
      g.addColorStop(0,'transparent');g.addColorStop(.15,c2+'66');g.addColorStop(.45,c2+'ee');
      g.addColorStop(.7,c2+'99');g.addColorStop(1,'transparent');
      ctx.fillStyle=g;const h2=bh*.055;
      ctx.beginPath();ctx.moveTo(bx,y0);ctx.lineTo(bx+bw,y0-bh*.02);ctx.lineTo(bx+bw,y0-bh*.02+h2);ctx.lineTo(bx,y0+h2);ctx.closePath();ctx.fill();
    }
  }else if(d===11){
    // HEXED â€” grille hexagonale grande et bien visible
    const hr=bw*.085,hexH=hr*1.732;
    for(let row=-1;row<=Math.ceil(bh/hexH)+1;row++)for(let col=-1;col<=Math.ceil(bw/(hr*1.5))+1;col++){
      const cx=bx+col*(hr*3)+(((row%2)+2)%2)*hr*1.5,cy=by+row*hexH;
      const dist=Math.hypot((cx-bx-bw*.5)/bw,(cy-by-bh*.5)/bh);
      const alpha=Math.max(0,1.0-dist*1.1);if(alpha<.04)continue;
      // Fill subtil
      ctx.fillStyle=`rgba(255,140,0,${alpha*.15})`;ctx.beginPath();
      for(let k=0;k<6;k++){const a=k*Math.PI/3-Math.PI/6;ctx.lineTo(cx+Math.cos(a)*hr*.9,cy+Math.sin(a)*hr*.9);}ctx.closePath();ctx.fill();
      ctx.strokeStyle=`rgba(255,170,0,${alpha*.9})`;ctx.lineWidth=bw*.016;
      ctx.beginPath();for(let k=0;k<6;k++){const a=k*Math.PI/3-Math.PI/6;ctx.lineTo(cx+Math.cos(a)*hr*.9,cy+Math.sin(a)*hr*.9);}ctx.closePath();ctx.stroke();
    }
  }else if(d===12){
    // SHATTERED â€” fractures de verre rose/violet vif
    const verts=[[.5,.5],[.12,.08],[.52,.04],[.92,.14],[.96,.58],[.74,.94],[.38,.97],[.04,.76],[.05,.32]];
    const cols=['rgba(255,40,130,.75)','rgba(210,10,100,.65)','rgba(255,80,180,.7)','rgba(190,0,90,.6)','rgba(255,30,150,.72)','rgba(220,50,140,.65)','rgba(170,0,70,.6)','rgba(245,70,160,.7)'];
    [[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,6],[0,6,7],[0,7,8],[0,8,1]].forEach((tri,idx)=>{
      ctx.fillStyle=cols[idx];ctx.strokeStyle='rgba(255,100,200,.6)';ctx.lineWidth=1.2;
      ctx.beginPath();tri.forEach((vi,i)=>{const px=bx+bw*verts[vi][0],py=by+bh*verts[vi][1];i===0?ctx.moveTo(px,py):ctx.lineTo(px,py);});ctx.closePath();ctx.fill();ctx.stroke();
    });
    // Reflets lumineux sur les arÃªtes
    verts.slice(1).forEach(([fx,fy])=>{
      const cx=bx+bw*fx,cy=by+bh*fy;
      const g=ctx.createRadialGradient(cx,cy,0,cx,cy,bw*.04);g.addColorStop(0,'rgba(255,180,255,.9)');g.addColorStop(1,'rgba(255,100,200,0)');
      ctx.fillStyle=g;ctx.beginPath();ctx.arc(cx,cy,bw*.04,0,Math.PI*2);ctx.fill();
    });
  }else if(d===13){
    // SPECTRE â€” grande aura fantÃ´me violette + traÃ®nÃ©es
    const cx=bx+bw*.5,cy=by+bh*.45;
    const aura=ctx.createRadialGradient(cx,cy,0,cx,cy,bw*.55);
    aura.addColorStop(0,'rgba(180,60,255,.5)');aura.addColorStop(.5,'rgba(120,30,220,.25)');aura.addColorStop(1,'rgba(60,0,150,0)');
    ctx.fillStyle=aura;ctx.beginPath();ctx.ellipse(cx,cy,bw*.55,bh*.55,0,0,Math.PI*2);ctx.fill();
    for(let i=0;i<14;i++){
      const fx=(i*.19+.04)%1,fy=(i*.27+.06)%1,cr=bw*(.03+.025*(i%3));
      const pcx=bx+bw*fx,pcy=by+bh*fy;
      const g=ctx.createRadialGradient(pcx,pcy,0,pcx,pcy,cr);
      g.addColorStop(0,'rgba(200,100,255,1)');g.addColorStop(.5,'rgba(140,40,220,.6)');g.addColorStop(1,'rgba(80,0,180,0)');
      ctx.fillStyle=g;ctx.beginPath();ctx.arc(pcx,pcy,cr,0,Math.PI*2);ctx.fill();
    }
    for(let i=0;i<6;i++){
      const x=bx+bw*(.06+i*.175);
      const g=ctx.createLinearGradient(x,by,x,by+bh);
      g.addColorStop(0,'transparent');g.addColorStop(.4,'rgba(180,60,255,.45)');g.addColorStop(.6,'rgba(180,60,255,.45)');g.addColorStop(1,'transparent');
      ctx.strokeStyle=g;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(x,by);ctx.lineTo(x+bw*.03,by+bh);ctx.stroke();
    }
  }else if(d===14){
    // STRIKER â€” terrain de foot stylisÃ© bien lisible
    const bg=ctx.createLinearGradient(bx,by,bx+bw,by+bh);
    bg.addColorStop(0,'rgba(255,60,0,.12)');bg.addColorStop(.5,'rgba(255,100,0,.3)');bg.addColorStop(1,'rgba(255,60,0,.12)');
    ctx.fillStyle=bg;ctx.fillRect(bx,by,bw,bh);
    // Lignes du terrain
    [[0,.33,1,.33],[0,.67,1,.67],[.5,0,.5,1]].forEach(([x1,y1,x2,y2])=>{
      ctx.strokeStyle='rgba(255,140,0,.7)';ctx.lineWidth=bh*.05;
      ctx.beginPath();ctx.moveTo(bx+bw*x1,by+bh*y1);ctx.lineTo(bx+bw*x2,by+bh*y2);ctx.stroke();
    });
    // Cercle central
    ctx.strokeStyle='rgba(255,160,0,.7)';ctx.lineWidth=bh*.05;
    ctx.beginPath();ctx.arc(bx+bw*.5,by+bh*.5,bw*.18,0,Math.PI*2);ctx.stroke();
    ctx.strokeStyle='rgba(255,160,0,.4)';ctx.lineWidth=bh*.03;
    ctx.beginPath();ctx.arc(bx+bw*.5,by+bh*.5,bw*.06,0,Math.PI*2);ctx.stroke();
  }else if(d===15){
    // MAINFRAME â€” matrice binaire lumineuse + glitch Ã©pais
    ctx.font=`bold ${bh*.18}px monospace`;ctx.textAlign='left';ctx.textBaseline='top';
    for(let row=0;row<6;row++)for(let col=0;col<11;col++){
      const bit=((row*11+col*7+42)%2===0)?'1':'0';
      const a=0.15+((row*3+col*5)%4)*.15;
      ctx.fillStyle=`rgba(0,255,180,${a})`;
      ctx.fillText(bit,bx+col*(bw/10.2),by+row*(bh/5.5));
    }
    // Glitch scanlines Ã©paisses
    [.18,.52,.82].forEach(fy=>{
      const g=ctx.createLinearGradient(bx,by,bx+bw,by);
      g.addColorStop(0,'transparent');g.addColorStop(.3,'rgba(0,255,180,.75)');
      g.addColorStop(.7,'rgba(0,220,255,.6)');g.addColorStop(1,'transparent');
      ctx.strokeStyle=g;ctx.lineWidth=bh*.06;
      ctx.beginPath();ctx.moveTo(bx,by+bh*fy);ctx.lineTo(bx+bw,by+bh*(fy+.025));ctx.stroke();
    });
  }
  ctx.restore();
}

// =====================================================================
// CAR SHAPE (garage/menu) â€” dÃ©lÃ¨gue aux mÃªmes fonctions que le jeu
// =====================================================================
function drawCarShape(ctx,x,y,w,h,c1,c2,decal,ws,model=0,spin=0){
  ctx.save();ctx.translate(x,y+h*.04);
  ctx.globalAlpha=.22;ctx.beginPath();ctx.ellipse(0,h*.38,w*.4,h*.08,0,0,Math.PI*2);ctx.fillStyle='#000';ctx.fill();ctx.globalAlpha=1;
  const fw=w*.9,fh=h*.75;
  if(model===0)drawOctane(ctx,fw,fh,c1,c2,spin,ws,decal);
  else if(model===1)drawFennec(ctx,fw,fh,c1,c2,spin,ws,decal);
  else drawDominus(ctx,fw,fh,c1,c2,spin,ws,decal);
  ctx.restore();
}
function renderMenuCar() {
  const c=document.getElementById('menuCarCanvas'); if(!c) return;
  const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  const g=ctx.createRadialGradient(c.width/2,c.height*.8,0,c.width/2,c.height*.8,c.width*.44);
  g.addColorStop(0,'rgba(60,140,255,.12)'); g.addColorStop(1,'transparent');
  ctx.fillStyle=g; ctx.fillRect(0,0,c.width,c.height);
  drawCarShape(ctx,c.width/2,c.height*.6,c.width*.85,c.height*.75,S.car.c1,S.car.c2,S.car.decal,S.car.wheel,S.car.model);
  // News car: resize canvas with device pixel ratio for sharpness
  const nc=document.getElementById('newsCarCanvas'); if(!nc) return;
  const wrap=document.getElementById('news-car-wrap');
  const dpr=Math.min(window.devicePixelRatio||1,2);
  const cssW=wrap?wrap.clientWidth:600, cssH=wrap?wrap.clientHeight:220;
  nc.width=Math.max(Math.round(cssW*dpr),1);
  nc.height=Math.max(Math.round(cssH*dpr),1);
  nc.style.width=cssW+'px'; nc.style.height=cssH+'px';
  const nctx=nc.getContext('2d');
  nctx.scale(dpr,dpr);
  nctx.clearRect(0,0,cssW,cssH);
  const ng=nctx.createRadialGradient(cssW*.5,cssH*.9,0,cssW*.5,cssH*.8,cssW*.4);
  ng.addColorStop(0,'rgba(40,120,255,.18)'); ng.addColorStop(1,'transparent');
  nctx.fillStyle=ng; nctx.fillRect(0,0,cssW,cssH);
  // Voiture occupe ~88% de la largeur, centrÃ©e verticalement
  // Taille basÃ©e sur la plus petite dimension pour garder les proportions
  const carSz=Math.min(cssW*.9,cssH*1.6);
  drawCarShape(nctx, cssW/2, cssH*.54, carSz, carSz, S.car.c1, S.car.c2, S.car.decal, S.car.wheel, S.car.model);
}
function renderGarageCar() {
  const c=document.getElementById('garageCanvas'); if(!c) return;
  const wrap=document.getElementById('garage-car-wrap');
  const dpr=Math.min(window.devicePixelRatio||1,2);
  const cssW=wrap?Math.max(wrap.clientWidth-24,120):236;
  const cssH=Math.round(cssW*0.62);
  c.width=Math.max(Math.round(cssW*dpr),1); c.height=Math.max(Math.round(cssH*dpr),1);
  c.style.width=cssW+'px'; c.style.height=cssH+'px';
  const ctx=c.getContext('2d');
  ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,cssW,cssH);
  const g=ctx.createRadialGradient(cssW/2,cssH*.8,0,cssW/2,cssH*.8,cssW*.44);
  g.addColorStop(0,'rgba(60,140,255,.12)'); g.addColorStop(1,'transparent');
  ctx.fillStyle=g; ctx.fillRect(0,0,cssW,cssH);
  drawCarShape(ctx,cssW/2,cssH*.58,cssW*.88,cssH*.88,S.car.c1,S.car.c2,S.car.decal,S.car.wheel,S.car.model);
}

// =====================================================================
// GARAGE UI
// =====================================================================
function mk(parent,txt,active,cb,locked) {
  const el=document.createElement('div'); el.className='oi'+(active?' active':''); el.style.position='relative'; el.textContent=txt;
  if(locked){el.style.opacity='.5';el.style.cursor='not-allowed';el.innerHTML+=` <span style="font-size:12px">ğŸ”’</span>`;el.onclick=()=>notify('ğŸ”’ Achetez-le en boutique !');}
  else el.onclick=cb;
  document.getElementById(parent).appendChild(el);
}
function renderGarageUI() {
  ['car-opts','cp1','cp2','decal-opts','wheel-opts'].forEach(id=>document.getElementById(id).innerHTML='');
  CAR_MODELS.forEach((m,i)=>mk('car-opts',m.name,S.car.model===i,()=>{S.car.model=i;renderGarageUI();},i>0&&!S.owned.includes(['','c_fen','c_dom'][i])));
  COLS1.forEach(c=>{const d=document.createElement('div');d.className='csw'+(S.car.c1===c?' active':'');d.style.background=c;d.onclick=()=>{S.car.c1=c;renderGarageUI();};document.getElementById('cp1').appendChild(d);});
  COLS2.forEach(c=>{const d=document.createElement('div');d.className='csw'+(S.car.c2===c?' active':'');d.style.background=c;d.onclick=()=>{S.car.c2=c;renderGarageUI();};document.getElementById('cp2').appendChild(d);});
  const decalIds=['','d_fl','d_ltg','d_cam','d_wv','d_drg','d_dis','d_tid','d_bio','d_cir','d_sli','d_hex','d_sha','d_spe','d_str','d_mai'];
  DECALS.forEach((d,i)=>mk('decal-opts',d,S.car.decal===i,()=>{S.car.decal=i;renderGarageUI();},i>0&&!S.owned.includes(decalIds[i])));
  const wheelIds=['','w_nit','w_chro','w_saf','w_oem','w_inf','w_spi','w_tur','w_raj','w_zom','w_dra','w_ani','w_gld','w_rea','w_cri','w_apx'];
  WHEELS.forEach((w,i)=>mk('wheel-opts',w,S.car.wheel===i,()=>{S.car.wheel=i;renderGarageUI();},i>0&&!S.owned.includes(wheelIds[i])));
  renderGarageCar();
}
function applyGarage() {
  save();
  if(game){game.player.c1=S.car.c1;game.player.c2=S.car.c2;game.player.decal=S.car.decal;game.player.wheelStyle=S.car.wheel;}
  notify('âœ… VÃ©hicule mis Ã  jour !'); showScreen('screen-main');
}

// =====================================================================
// SHOP ROTATION TIMER
// =====================================================================
function getMinutesUntilNextHour() {
  const now = new Date();
  return 60 - now.getMinutes() - now.getSeconds()/60;
}
function updateShopTimer() {
  const now = new Date();
  const secLeft = (60 - now.getMinutes())*60 - now.getSeconds();
  const m = String(Math.floor(secLeft/60)).padStart(2,'0');
  const s = String(secLeft%60).padStart(2,'0');
  const timerEl = document.getElementById('shop-next-timer');
  if(timerEl) timerEl.textContent = `${m}:${s}`;
  // Progress bar: fraction of the current hour elapsed
  const elapsed = (now.getMinutes()*60 + now.getSeconds());
  const pct = (elapsed / 3600) * 100;
  const fill = document.getElementById('shop-rotation-fill');
  if(fill) fill.style.width = pct+'%';
  // Check if hour changed â€” refresh shop
  if(secLeft <= 1) { initShop(); renderShop(); }
}
setInterval(updateShopTimer, 1000);

// =====================================================================
// SHOP RENDER
// =====================================================================
function renderShop() {
  initShop(); // ensure current rotation
  const g=document.getElementById('shop-grid'); if(!g) return;
  g.innerHTML='';
  updateShopTimer();

  SHOP.forEach(it=>{
    const owned=S.owned.includes(it.id);
    const rar = RARITY[it.rarity] || RARITY[0];
    const isLegendary = it.rarity === 4;
    const isEpic = it.rarity === 3;

    const d=document.createElement('div');
    d.style.cssText=`
      background:rgba(4,8,18,.9);
      border:1px solid ${rar.glow}0.15);
      border-top:2px solid ${owned?rar.glow+'0.3)':rar.col};
      padding:18px 14px 16px;
      text-align:center;
      position:relative;
      cursor:${owned?'default':'pointer'};
      transition:all .2s;
      overflow:hidden;
      ${isLegendary && !owned ? `box-shadow: 0 0 18px ${rar.glow}0.12), inset 0 0 30px ${rar.glow}0.04);` : ''}
    `;

    // Animated shimmer for legendary
    const shimmer = isLegendary && !owned ? `
      <div style="position:absolute;inset:0;background:linear-gradient(105deg,transparent 40%,${rar.glow}0.08) 50%,transparent 60%);animation:lgShimmer 2.5s ease-in-out infinite;pointer-events:none;"></div>
    ` : '';

    // Corner triangle
    const cornerCol = owned ? rar.glow+'0.15)' : rar.col;
    d.innerHTML = `
      ${shimmer}
      <div style="position:absolute;top:0;right:0;width:0;height:0;border-style:solid;border-width:0 20px 20px 0;border-color:transparent ${cornerCol} transparent transparent;${owned?'opacity:.3':''}"></div>
      ${owned ? `<div style="position:absolute;top:4px;left:8px;font-family:'Share Tech Mono',monospace;font-size:7px;letter-spacing:2px;color:${rar.col};opacity:.6;">ACQUIS</div>` : ''}
      <div style="font-size:38px;margin-bottom:10px;line-height:1;${owned?'filter:grayscale(50%) opacity(.6)':''};">${it.icon}</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;letter-spacing:2px;color:${owned?'rgba(255,255,255,.35)':'#fff'};margin-bottom:4px;text-transform:uppercase;">${it.name}</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:rgba(140,180,220,.4);letter-spacing:3px;margin-bottom:8px;">${it.type}</div>
      <div style="display:inline-block;font-family:'Share Tech Mono',monospace;font-size:7px;letter-spacing:2px;color:${rar.col};border:1px solid ${rar.glow}0.4);padding:2px 7px;margin-bottom:10px;background:${rar.glow}0.08);">${rar.label}</div>
      <div style="height:1px;background:linear-gradient(90deg,transparent,${rar.glow}0.2),transparent);margin-bottom:10px;"></div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:${owned?'18':'20'}px;font-weight:800;color:${owned?'rgba(140,180,220,.3)':rar.col};letter-spacing:2px;">${owned?'âœ“ POSSÃ‰DÃ‰':it.price+' VAK'}</div>
    `;

    if(!owned){
      d.onmouseenter=()=>{
        d.style.borderColor = rar.glow+'0.5)';
        d.style.borderTopColor = rar.col;
        d.style.background = `rgba(8,14,28,.95)`;
        d.style.boxShadow = `0 0 28px ${rar.glow}0.2), inset 0 0 20px ${rar.glow}0.05)`;
        d.style.transform = 'translateY(-4px)';
      };
      d.onmouseleave=()=>{
        d.style.borderColor = rar.glow+'0.15)';
        d.style.borderTopColor = rar.col;
        d.style.background = 'rgba(4,8,18,.9)';
        d.style.boxShadow = isLegendary ? `0 0 18px ${rar.glow}0.12)` : 'none';
        d.style.transform = 'translateY(0)';
      };
      d.onclick=()=>buyItem(it);
    }
    g.appendChild(d);
  });
}
function buyItem(it) {
  if(S.vak<it.price){notify('âŒ Pas assez de VAK !');return;}
  S.vak-=it.price; S.owned.push(it.id); save(); updateVak(); renderShop();
  const rar = RARITY[it.rarity]||RARITY[0];
  notify(`âœ… ${it.name} achetÃ© ! [${rar.label}]`);
}

// =====================================================================
// SETTINGS / KEYBINDS
// =====================================================================
const KLABELS = {up:'Avancer',down:'Reculer',left:'Gauche',right:'Droite',boost:'Boost'};
let listeningFor=null, pauseSettings=false;
function renderSettings() {
  const list=document.getElementById('keybind-list'); list.innerHTML='';
  Object.keys(KLABELS).forEach(action=>{
    const row=document.createElement('div'); row.className='krow';
    const lbl=document.createElement('span'); lbl.className='klbl'; lbl.textContent=KLABELS[action];
    const key=document.createElement('div'); key.className='kkey';
    const k=S.keys[action]; key.textContent=k===' '?'ESPACE':k.length>1?k:k.toUpperCase();
    key.onclick=()=>{document.querySelectorAll('.kkey').forEach(e=>e.classList.remove('listening'));listeningFor=action;key.textContent='...';key.classList.add('listening');};
    row.appendChild(lbl); row.appendChild(key); list.appendChild(row);
  });
}
function exitSettings() {
  listeningFor=null;
  const s=document.getElementById('screen-settings'); s.classList.remove('active');
  if(pauseSettings){pauseSettings=false;s.style.zIndex='';s.style.background='';s.style.backdropFilter='';document.getElementById('pm').classList.add('show');}
  else showScreen('screen-main');
}

// =====================================================================
// KEY HANDLER â€” Gemini fix: keydown envoie directement au serveur
// =====================================================================
const keys = {};  // Ã©tat local des touches
// Quand la fenÃªtre perd le focus (alt-tab etc.), relÃ¢cher toutes les touches
window.addEventListener('blur', () => { Object.keys(keys).forEach(k => { keys[k] = false; }); });

// Timers annulables â€” Ã©vite qu'un setTimeout d'une vieille partie se dÃ©clenche sur la suivante
let _goalTimers = [];
function _clearGoalTimers() { _goalTimers.forEach(id => clearTimeout(id)); _goalTimers = []; }
document.addEventListener('keydown', e=>{
  if(listeningFor){e.preventDefault();S.keys[listeningFor]=e.key;listeningFor=null;save();renderSettings();return;}
  if(game && game.running && !game.paused && (e.key==='Escape'||e.key==='Esc')){togglePause();return;}
  keys[e.key]=true;
  if(e.key===' ' && game) e.preventDefault();
});
document.addEventListener('keyup', e=>{ keys[e.key]=false; });

// =====================================================================
// PAUSE
// =====================================================================
function togglePause() {
  if(!game) return;
  game.paused=!game.paused;
  document.getElementById('pm').classList.toggle('show',game.paused);
  if(!game.paused){game.lastTime=performance.now();gameLoop(performance.now());}
}
function resumeGame() { document.getElementById('pm').classList.remove('show'); game.paused=false; game.lastTime=performance.now(); gameLoop(performance.now()); }
function openSettingsFromPause() {
  document.getElementById('pm').classList.remove('show'); pauseSettings=true; listeningFor=null;
  const s=document.getElementById('screen-settings'); s.style.zIndex='95'; s.style.background='rgba(0,0,20,.88)'; s.style.backdropFilter='blur(12px)'; s.classList.add('active'); renderSettings();
}
function quitGame() { document.getElementById('pm').classList.remove('show'); endToMenu(); }

// =====================================================================
// PARTICLES
// =====================================================================
function mkParticles(type,n,W,H,FX,FY,FW,FH){
  const ps=[];
  for(let i=0;i<n;i++){
    if(type==='ember')ps.push({x:FX+Math.random()*FW,y:FY+FH+Math.random()*15,vx:(Math.random()-.5)*.8,vy:-(Math.random()*1.4+.4),life:Math.random(),sz:Math.random()*2.5+.8,col:`hsl(${20+Math.random()*30},100%,${50+Math.random()*30}%)`});
    else if(type==='snow')ps.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-.5)*.25,vy:Math.random()*.7+.15,life:Math.random(),sz:Math.random()*2.5+.8,col:`rgba(200,230,255,${.35+Math.random()*.4})`});
    else if(type==='leaf')ps.push({x:Math.random()*W,y:-15,vx:(Math.random()-.5)*.7,vy:Math.random()*.55+.18,rot:Math.random()*Math.PI*2,rv:(Math.random()-.5)*.05,life:Math.random(),sz:Math.random()*3.5+2.5,col:`rgba(${150+Math.random()*50},${80+Math.random()*50},${140+Math.random()*50},.55)`});
  }
  return ps;
}
function updParticles(ps,type,W,H,FX,FY,FW,FH,dt){
  ps.forEach(p=>{
    p.x+=p.vx; p.y+=p.vy; p.life+=dt*.38;
    if(p.life>1){if(type==='ember'){p.x=FX+Math.random()*FW;p.y=FY+FH+8;p.vy=-(Math.random()*1.4+.4);}else if(type==='snow'){p.x=Math.random()*W;p.y=-8;}else{p.x=-15;p.y=Math.random()*H;}p.life=0;}
    if(type==='leaf')p.rot+=p.rv;
  });
}
function drawParticles(ctx,ps,type){
  ps.forEach(p=>{
    ctx.save(); ctx.globalAlpha=.65-p.life*.4;
    if(type==='leaf'){ctx.translate(p.x,p.y);ctx.rotate(p.rot);ctx.fillStyle=p.col;ctx.beginPath();ctx.ellipse(0,0,p.sz,p.sz*.5,0,0,Math.PI*2);ctx.fill();}
    else{ctx.beginPath();ctx.arc(p.x,p.y,p.sz,0,Math.PI*2);ctx.fillStyle=p.col;ctx.fill();}
    ctx.restore();
  });
}

// =====================================================================
// GAME STATE
// =====================================================================
let game = null;
let multiMode = false;

// SOLO: dÃ©marrage local
function startSoloGame() {
  multiMode = false;
  _launchGameUI();
}

// MULTI: dÃ©marrage sur rÃ©ception GAME_START
function startMultiGame() {
  multiMode = true;
  _launchGameUI();
  startInputLoop();
}

function _launchGameUI() {
  const cvs=document.getElementById('gameCanvas');
  cvs.width=window.innerWidth; cvs.height=window.innerHeight;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('game-canvas').style.display='block';
  document.getElementById('game-hud').style.display='block';
  showMobileControls(true);
  document.getElementById('player-bar').style.display='none';
  document.getElementById('vak-display').style.display='none';
  if(!multiMode){
    document.getElementById('hud-team-a').textContent=S.playerName||'VOUS';
    document.getElementById('hud-team-b').textContent='BOTS';
  }
  game = createGame(cvs);
  game._keys = keys;  // rÃ©fÃ©rence partagÃ©e (Gemini: pas de copie, accÃ¨s direct)
  startCountdown();
}

// =====================================================================
// CREATE GAME
// =====================================================================
function createGame(cvs) {
  const W=cvs.width, H=cvs.height;
  const theme=MAPS[S.map];
  const FW=W*.82, FH=H*.64;
  const FX=(W-FW)/2, FY=H*.14;
  const GW=FW*.065, GH=FH*.3;
  const BR=Math.min(W,H)*.028;
  const CW=Math.min(W,H)*.095, CH=Math.min(W,H)*.062;
  const g = {
    cvs,ctx:cvs.getContext('2d'),W,H,FW,FH,FX,FY,GW,GH,BR,CW,CH,theme,
    running:false, paused:false, _ended:false,
    scoreP:0, scoreB:0, timeLeft:S.time, lastTime:0, wSpin:0,
    ball:{ x:FX+FW/2, y:FY+FH/2, vx:0, vy:0, r:BR, spin:0 },
    player:{ x:multiMode?(myTeam===0?FX+FW*.22:FX+FW*.78):FX+FW*.22, y:FY+FH/2, vx:0,vy:0, w:CW,h:CH, boost:.8, angle:myTeam===1?Math.PI:0, trail:[] },
    bots:[], remotePlayers:{},
    particles:mkParticles(theme.particles,20,W,H,FX,FY,FW,FH),
    gFlash:0, gColor:'#fff', animFrame:null,
  };
  if(!multiMode){
    const pers=['aggressive','defensive','balanced'];
    const bc=['#cc2200','#cc5500','#991100'];
    const bc2=['#440000','#443300','#330000'];
    for(let i=0;i<S.bots;i++){
      g.bots.push({x:FX+FW*(.72+i*.07),y:FY+FH*(.28+i*.22),vx:0,vy:0,w:CW,h:CH,angle:Math.PI,boost:.8,trail:[],pers:pers[i%3],col:bc[i%3],col2:bc2[i%3],aiState:'chase',aiTimer:0,wheelOff:i*.3});
    }
  }
  return g;
}

// =====================================================================
// GAME LOOP â€” requestAnimationFrame (Gemini: liÃ© au temps rÃ©el)
// =====================================================================
function gameLoop(ts) {
  if(!game||!game.running||game.paused) return;
  const dt=Math.min((ts-game.lastTime)/1000, .05);
  game.lastTime=ts;
  updateGame(dt);
  renderGame();
  game.animFrame=requestAnimationFrame(gameLoop);
}

// =====================================================================
// UPDATE GAME
// =====================================================================
const SOLO_SPD=225, SOLO_FRIC=.87, SOLO_BNC=.62, SOLO_BSPD=178;

function updateGame(dt) {
  const g=game;
  const {FX,FY,FW,FH,GW,GH}=g;
  if(g.gFlash>0) g.gFlash-=dt;

  // ---- TIMER ----
  if(!multiMode){
    g.timeLeft-=dt;
    if(g.timeLeft<=0){g.timeLeft=0;if(!g._ended){g._ended=true;endGame();}return;}
  }
  // MÃ j HUD timer (1x/sec)
  if(!g._lastHUDSec||Math.floor(g.timeLeft)!==g._lastHUDSec){g._lastHUDSec=Math.floor(g.timeLeft);updateTimerHUD();}

  const p=g.player;
  let ps2=0;

  if(!multiMode){
    // ---- SOLO: physique locale ----
    const bsting=keys[S.keys.boost]&&p.boost>0;
    const spd=SOLO_SPD*(bsting?1.88:1);
    if(bsting)p.boost=Math.max(0,p.boost-dt*.55); else p.boost=Math.min(1,p.boost+dt*.18);
    let ax=0,ay=0;
    if(keys[S.keys.up])   ay-=1;
    if(keys[S.keys.down]) ay+=1;
    if(keys[S.keys.left]) ax-=1;
    if(keys[S.keys.right])ax+=1;
    const al=Math.sqrt(ax*ax+ay*ay)||1;
    p.vx+=ax/al*spd*dt*3.2; p.vy+=ay/al*spd*dt*3.2;
    p.vx*=SOLO_FRIC; p.vy*=SOLO_FRIC;
    ps2=Math.sqrt(p.vx*p.vx+p.vy*p.vy);
    if(ps2>spd*1.22){p.vx=p.vx/ps2*spd*1.22;p.vy=p.vy/ps2*spd*1.22;}
    if(ps2>8)p.angle=Math.atan2(p.vy,p.vx);
    p.x+=p.vx*dt; p.y+=p.vy*dt;
    p.x=Math.max(FX+p.w/2,Math.min(FX+FW-p.w/2,p.x));
    p.y=Math.max(FY+p.h/2,Math.min(FY+FH-p.h/2,p.y));
    if(bsting)p.trail.push({x:p.x,y:p.y,t:1});
    p.trail=p.trail.filter(t=>{t.t-=dt*4;return t.t>0;});
  } else {
    // ---- MULTI: correction douce vers position serveur ----
    if(p._tx!==undefined){
      const dist=Math.hypot(p._tx-p.x, p._ty-p.y);
      if(dist > game.FW*0.12){ p.x=p._tx; p.y=p._ty; } // snap si trÃ¨s loin
      else{ const lp=Math.min(1,dt*10); p.x+=(p._tx-p.x)*lp; p.y+=(p._ty-p.y)*lp; }
      let da=p._ta-p.angle; while(da>Math.PI)da-=Math.PI*2; while(da<-Math.PI)da+=Math.PI*2;
      p.angle+=da*Math.min(1,dt*10);
    }
    ps2=Math.sqrt((p.vx||0)**2+(p.vy||0)**2);
    if(p.boost>0)p.trail.push({x:p.x,y:p.y,t:1});
    p.trail=p.trail.filter(t=>{t.t-=dt*4;return t.t>0;});
  }

  document.getElementById('boost-fill').style.height=((p.boost||0)*100)+'%';
  g.wSpin+=ps2*dt*.05;

  // ---- BOTS AI (solo seulement) ----
  if(!multiMode){
    g.bots.forEach((bot,bi)=>{
      bot.aiTimer -= dt;
      const ball = g.ball;
      const {FX,FY,FW,FH} = g;

      // Buts : joueur attaque Ã  droite â†’ FX+FW, bots attaquent Ã  gauche â†’ FX
      const botAttackGoalX  = FX;         // but du joueur (cible des bots)
      const botDefendGoalX  = FX+FW;      // but des bots (Ã  dÃ©fendre)
      const goalCY          = FY+FH/2;

      // ---- DÃ©cision IA (toutes les 150-250ms) ----
      if(bot.aiTimer <= 0){
        bot.aiTimer = 0.15 + Math.random()*0.18;
        const db = Math.hypot(bot.x-ball.x, bot.y-ball.y);
        const ballInOwnHalf   = ball.x > FX+FW*0.5;
        const ballNearOwnGoal = ball.x > FX+FW*0.72;
        const ballNearEnemyGoal = ball.x < FX+FW*0.3;
        const hasBoost = bot.boost > 0.25;

        if(bot.pers === 'aggressive'){
          if(db < FW*0.65){
            // Si on est bien placÃ© pour tirer â†’ attaque, sinon chase
            const angle = Math.atan2(ball.y-bot.y, ball.x-bot.x);
            const goalAngle = Math.atan2(goalCY-bot.y, botAttackGoalX-bot.x);
            const angleDiff = Math.abs(angle - goalAngle);
            bot.aiState = angleDiff < 0.9 ? 'attack' : 'position_to_shoot';
          } else {
            bot.aiState = 'chase';
          }
        } else if(bot.pers === 'defensive'){
          if(ballNearOwnGoal && db < FW*0.4){
            bot.aiState = 'clear';  // dÃ©gager en urgence
          } else if(ballInOwnHalf){
            bot.aiState = db < FW*0.5 ? 'chase' : 'defend';
          } else {
            bot.aiState = db < FW*0.42 ? 'attack' : 'defend';
          }
        } else { // balanced
          if(ballNearOwnGoal && db < FW*0.38){
            bot.aiState = 'clear';
          } else if(ball.x < FX+FW*0.55){
            bot.aiState = db < FW*0.52 ? 'attack' : 'position_to_shoot';
          } else {
            bot.aiState = db < FW*0.48 ? 'chase' : 'defend';
          }
        }

        // ---- DÃ©cision BOOST ----
        bot.useBoost = false;
        if(hasBoost){
          if(bot.aiState==='attack'||bot.aiState==='clear'){
            // Boost en attaque si on est alignÃ© avec la balle
            bot.useBoost = db < FW*0.28;
          } else if(bot.aiState==='chase'){
            // Boost pour rattraper la balle qui s'Ã©loigne
            const ballMovingAway = (ball.vx*(ball.x-bot.x)+ball.vy*(ball.y-bot.y)) > 0;
            bot.useBoost = ballMovingAway && db > FW*0.22;
          } else if(bot.aiState==='defend'||bot.aiState==='position_to_shoot'){
            // Parfois boost pour se repositionner vite
            bot.useBoost = hasBoost && Math.random() < 0.3 && db > FW*0.3;
          }
        }
      }

      // ---- Calcul position cible ----
      let tx, ty;
      const predT = 0.22 + bi*0.05;
      const predBX = Math.max(FX+10, Math.min(FX+FW-10, ball.x + ball.vx*predT*32));
      const predBY = Math.max(FY+10, Math.min(FY+FH-10, ball.y + ball.vy*predT*32));

      if(bot.aiState === 'attack' || bot.aiState === 'position_to_shoot'){
        // Se place DERRIÃˆRE la balle par rapport au but ennemi (gauche)
        // Direction: de la balle vers le but ennemi
        const toBallX = predBX - botAttackGoalX;
        const toBallY = predBY - goalCY;
        const toBallLen = Math.sqrt(toBallX*toBallX + toBallY*toBallY) || 1;
        const offset = bot.aiState==='attack' ? bot.w*1.3 : bot.w*2.0;
        tx = predBX + (toBallX/toBallLen) * offset;
        ty = predBY + (toBallY/toBallLen) * offset;
        // DÃ©calage latÃ©ral pour Ã©viter de foncer en ligne droite (plus rÃ©aliste)
        if(bot.aiState==='position_to_shoot'){
          ty += (bi%2===0?1:-1) * bot.h * 0.5;
        }
      } else if(bot.aiState === 'chase'){
        tx = predBX;
        ty = predBY;
      } else if(bot.aiState === 'clear'){
        // Fonce sur la balle sans calcul d'angle, but = dÃ©gager
        tx = ball.x;
        ty = ball.y;
      } else if(bot.aiState === 'defend'){
        // Position dÃ©fensive devant leur propre but
        const bx = FX+FW*0.80 + bi*22;
        const by = FY+FH*(0.28 + bi*0.22);
        // Intercepte si la balle s'approche
        const ballHeadingToBotGoal = ball.vx > 0 && ball.x > FX+FW*0.55;
        if(ballHeadingToBotGoal && Math.hypot(bot.x-ball.x,bot.y-ball.y) < FW*0.3){
          tx = predBX; ty = predBY;
        } else {
          tx = bx; ty = by;
        }
      } else {
        tx = FX+FW*(0.60+bi*0.1);
        ty = FY+FH*(0.28+bi*0.22);
      }

      tx = Math.max(FX+bot.w, Math.min(FX+FW-bot.w, tx));
      ty = Math.max(FY+bot.h, Math.min(FY+FH-bot.h, ty));

      // ---- SÃ©paration (Ã©viter superposition) ----
      let sepX=0, sepY=0;
      g.bots.forEach((o,oi)=>{
        if(oi===bi) return;
        const od = Math.hypot(bot.x-o.x, bot.y-o.y);
        if(od < bot.w*1.9 && od > 0){ sepX+=(bot.x-o.x)/od*80; sepY+=(bot.y-o.y)/od*80; }
      });
      const pd = Math.hypot(bot.x-g.player.x, bot.y-g.player.y);
      if(pd < bot.w*1.7 && pd > 0){ sepX+=(bot.x-g.player.x)/pd*60; sepY+=(bot.y-g.player.y)/pd*60; }

      // ---- Mouvement ----
      const dx = tx-bot.x, dy = ty-bot.y, dl = Math.sqrt(dx*dx+dy*dy)||1;
      const diffFactor = bot.pers==='aggressive' ? 1.18 : bot.pers==='defensive' ? 0.85 : 1.0;

      // Boost actif
      const boostActive = bot.useBoost && bot.boost > 0;
      if(boostActive){ bot.boost = Math.max(0, bot.boost-dt*0.45); }
      else { bot.boost = Math.min(1, bot.boost+dt*0.16); }

      const bs = SOLO_BSPD * (1+bi*0.07) * diffFactor * (boostActive ? 1.82 : 1.0);

      bot.vx += (dx/dl*bs + sepX)*dt*2.9;
      bot.vy += (dy/dl*bs + sepY)*dt*2.9;
      bot.vx *= SOLO_FRIC; bot.vy *= SOLO_FRIC;
      const bv = Math.sqrt(bot.vx*bot.vx + bot.vy*bot.vy);
      if(bv > bs*1.28){ bot.vx=bot.vx/bv*bs*1.28; bot.vy=bot.vy/bv*bs*1.28; }
      if(bv > 8) bot.angle = Math.atan2(bot.vy, bot.vx);
      bot.x += bot.vx*dt; bot.y += bot.vy*dt;
      bot.x = Math.max(FX+bot.w/2, Math.min(FX+FW-bot.w/2, bot.x));
      bot.y = Math.max(FY+bot.h/2, Math.min(FY+FH-bot.h/2, bot.y));
      if(bv > 55 || boostActive) bot.trail.push({x:bot.x, y:bot.y, t: boostActive?0.9:0.55});
      bot.trail = bot.trail.filter(t=>{ t.t-=dt*4; return t.t>0; });
      ballCollideLocal(bot, g.ball);
    });
    ballCollideLocal(p, g.ball);
    g.bots.forEach(bot=>carCarCollideLocal(p,bot));
    for(let i=0;i<g.bots.length;i++) for(let j=i+1;j<g.bots.length;j++) carCarCollideLocal(g.bots[i],g.bots[j]);
    // Physique balle solo
    const b=g.ball;
    b.x+=b.vx*dt*60; b.y+=b.vy*dt*60;
    b.vx*=.994; b.vy*=.994;
    b.spin+=Math.sqrt(b.vx*b.vx+b.vy*b.vy)*dt*.09;
    const gY1=FY+FH/2-GH/2, gY2=FY+FH/2+GH/2;
    if(b.y-b.r<FY){b.y=FY+b.r;b.vy=Math.abs(b.vy)*SOLO_BNC;}
    if(b.y+b.r>FY+FH){b.y=FY+FH-b.r;b.vy=-Math.abs(b.vy)*SOLO_BNC;}
    if(b.x-b.r<FX&&b.y>gY1&&b.y<gY2){g.scoreB++;document.getElementById('score-bot').textContent=g.scoreB;showGoal('BOT GOAL!','var(--red)');startGoalReset(g);return;}
    if(b.x+b.r>FX+FW&&b.y>gY1&&b.y<gY2){g.scoreP++;document.getElementById('score-player').textContent=g.scoreP;showGoal('BUT !','var(--accent)');startGoalReset(g);return;}
    if(b.x-b.r<FX){b.x=FX+b.r;b.vx=Math.abs(b.vx)*SOLO_BNC;}
    if(b.x+b.r>FX+FW){b.x=FX+FW-b.r;b.vx=-Math.abs(b.vx)*SOLO_BNC;}
  } else {
    // ---- MULTI: prÃ©diction balle entre snapshots serveur ----
    const b=g.ball;
    if(b._svx!==undefined){
      b.x+=b._svx*dt; b.y+=b._svy*dt;
      b._svx*=0.997; b._svy*=0.997;
      // Clamp local pour Ã©viter artefacts visuels
      if(b.y-b.r<FY){b.y=FY+b.r;b._svy=Math.abs(b._svy)*0.5;}
      if(b.y+b.r>FY+FH){b.y=FY+FH-b.r;b._svy=-Math.abs(b._svy)*0.5;}
      if(b.x-b.r<FX){b.x=FX+b.r;b._svx=Math.abs(b._svx)*0.5;}
      if(b.x+b.r>FX+FW){b.x=FX+FW-b.r;b._svx=-Math.abs(b._svx)*0.5;}
    }
    b.spin+=Math.sqrt((b._svx||0)**2+(b._svy||0)**2)*dt*.09;
  }

  updParticles(g.particles,g.theme.particles,g.W,g.H,FX,FY,FW,FH,dt);
}

// Collisions physique locale (solo seulement)
function ballCollideLocal(car,ball){
  const dx=ball.x-car.x,dy=ball.y-car.y,dist=Math.sqrt(dx*dx+dy*dy)||1;
  const md=ball.r+Math.max(car.w,car.h)*.46;
  if(dist<md){
    const nx=dx/dist,ny=dy/dist;
    const cvx=(car.vx||0)/60,cvy=(car.vy||0)/60;
    const rvx=ball.vx-cvx,rvy=ball.vy-cvy,dot=rvx*nx+rvy*ny;
    if(dot<0){const cs=Math.sqrt(cvx*cvx+cvy*cvy),imp=-dot*1.65+cs*.45+2.2;ball.vx+=nx*imp;ball.vy+=ny*imp;}
    ball.x=car.x+nx*(md+1.8); ball.y=car.y+ny*(md+1.8);
  }
}
function carCarCollideLocal(a,b){
  const dx=b.x-a.x,dy=b.y-a.y,dist=Math.sqrt(dx*dx+dy*dy)||1;
  const md=Math.max(a.w,a.h)*.52+Math.max(b.w,b.h)*.52;
  if(dist<md){
    const nx=dx/dist,ny=dy/dist,ov=(md-dist)*.5+1;
    a.x-=nx*ov;a.y-=ny*ov;b.x+=nx*ov;b.y+=ny*ov;
    const dot=(a.vx-b.vx)*nx+(a.vy-b.vy)*ny;
    if(dot>0){a.vx-=.55*dot*nx;a.vy-=.55*dot*ny;b.vx+=.55*dot*nx;b.vy+=.55*dot*ny;}
  }
}

function resetPositions(g){
  g.ball.x=g.FX+g.FW/2;g.ball.y=g.FY+g.FH/2;g.ball.vx=(Math.random()-.5)*3.8;g.ball.vy=(Math.random()-.5)*3.8;
  g.player.x=g.FX+g.FW*.22;g.player.y=g.FY+g.FH/2;g.player.vx=0;g.player.vy=0;g.player.angle=0;
  g.bots.forEach((bot,i)=>{bot.x=g.FX+g.FW*(.72+i*.07);bot.y=g.FY+g.FH*(.28+i*.22);bot.vx=0;bot.vy=0;bot.angle=Math.PI;});
}
function startGoalReset(g){
  g.running=false; cancelAnimationFrame(g.animFrame); resetPositions(g);
  _clearGoalTimers();
  // BUT! affichÃ© 1.8s â†’ puis countdown
  _goalTimers.push(setTimeout(()=>{
    if(!game) return;
    const el=document.getElementById('goal-countdown'),num=document.getElementById('gc-num');
    el.classList.add('show'); let c=3; num.textContent=c; num.style.color='#fff';
    const iv=setInterval(()=>{
      if(!game){ clearInterval(iv); el.classList.remove('show'); return; }
      c--;
      if(c===0){ num.textContent='GO!'; num.style.color='var(--accent2)'; }
      else if(c<0){
        clearInterval(iv); el.classList.remove('show'); num.style.color='var(--accent)';
        if(game&&game.timeLeft>0){ game.running=true; game.lastTime=performance.now(); gameLoop(performance.now()); }
      } else { num.textContent=c; num.style.color='#fff'; }
    },1000);
    _goalTimers.push(iv);
  }, 1800));
}

function updateTimerHUD(){
  const t=Math.max(0,Math.ceil(game.timeLeft)),m=Math.floor(t/60),s=t%60;
  document.getElementById('hud-timer').textContent=`${m}:${s.toString().padStart(2,'0')}`;
  document.getElementById('hud-timer').style.color=t<=30?'var(--red)':'var(--accent)';
}

// =====================================================================
// TRIBUNES â€” offscreen canvas (perf)
// =====================================================================
let tribuneCanvas=null;
function buildTribuneCache(FX,FY,FW,FH,W,H,theme){
  tribuneCanvas=document.createElement('canvas');tribuneCanvas.width=W;tribuneCanvas.height=H;
  const tc=tribuneCanvas.getContext('2d');
  const tColor=theme===MAPS[0]?'#3a1a06':theme===MAPS[1]?'#0a1830':'#0a200a';
  const tBorder=theme===MAPS[0]?'rgba(200,80,0,.6)':theme===MAPS[1]?'rgba(0,120,255,.6)':'rgba(0,200,80,.6)';
  const npcColors=theme===MAPS[0]?['#8b4513','#a0522d','#cd853f']:theme===MAPS[1]?['#1a3a6a','#2a5a9a','#3a7aca']:['#1a4a1a','#2a6a2a','#3a8a3a'];
  const topH=FY*.82,rows=3;
  for(let r=0;r<rows;r++){tc.fillStyle=r%2===0?tColor:shade(tColor,8);tc.fillRect(FX,topH*(1-rows*.12)+r*(topH*.1),FW,topH*.11+2);}
  tc.strokeStyle=tBorder;tc.lineWidth=1.5;tc.strokeRect(FX,0,FW,FY);
  const botY=FY+FH,botH=H-(botY);
  for(let r=0;r<rows;r++){tc.fillStyle=r%2===0?tColor:shade(tColor,8);tc.fillRect(FX,botY+r*botH*.11,FW,botH*.11+2);}
  tc.strokeStyle=tBorder;tc.lineWidth=1.5;tc.strokeRect(FX,botY,FW,botH);
  const sz=Math.max(7,Math.min(12,FW/65)),spacing=sz*2.8,cols=Math.floor(FW/spacing);
  const seed=n=>Math.abs(Math.sin(n*127.1+31.41)*43758.5453)%1;
  for(let r=0;r<2;r++)for(let c=0;c<cols;c++){
    const idx=r*cols+c,bx=FX+c*spacing+spacing*.5;
    const col=npcColors[Math.floor(seed(idx)*npcColors.length)];
    const col2=npcColors[Math.floor(seed(idx+99)*npcColors.length)];
    const topY=topH*(1-rows*.12)+(r+.5)*(topH*.1);
    tc.fillStyle=col2;tc.beginPath();tc.arc(bx,topY-sz*.85,sz*.36,0,Math.PI*2);tc.fill();
    tc.fillStyle=col;tc.beginPath();tc.moveTo(bx-sz*.3,topY-sz*.5);tc.lineTo(bx+sz*.3,topY-sz*.5);tc.lineTo(bx+sz*.35,topY+sz*.2);tc.lineTo(bx-sz*.35,topY+sz*.2);tc.closePath();tc.fill();
    const botRowY=botY+(r+.5)*botH*.13;
    tc.fillStyle=col2;tc.beginPath();tc.arc(bx,botRowY-sz*.85,sz*.36,0,Math.PI*2);tc.fill();
    tc.fillStyle=col;tc.beginPath();tc.moveTo(bx-sz*.3,botRowY-sz*.5);tc.lineTo(bx+sz*.3,botRowY-sz*.5);tc.lineTo(bx+sz*.35,botRowY+sz*.2);tc.lineTo(bx-sz*.35,botRowY+sz*.2);tc.closePath();tc.fill();
  }
}

// =====================================================================
// RENDER â€” bgCache (perf)
// =====================================================================
let bgCache=null;
function buildBGCache(g){
  const {W,H,FX,FY,FW,FH,theme}=g;
  bgCache=document.createElement('canvas');bgCache.width=W;bgCache.height=H;
  const bc=bgCache.getContext('2d');
  const sky=bc.createLinearGradient(0,0,0,H);sky.addColorStop(0,theme.skyT);sky.addColorStop(.65,theme.skyB);sky.addColorStop(1,'#000');
  bc.fillStyle=sky;bc.fillRect(0,0,W,H);
  if(!tribuneCanvas)buildTribuneCache(FX,FY,FW,FH,W,H,theme);
  bc.drawImage(tribuneCanvas,0,0);
  theme.decor(bc,FX,FY,FW,FH,W,H);
}

function renderGame(){
  const g=game;
  const {ctx,W,H,FX,FY,FW,FH,GW,GH,theme}=g;
  if(!bgCache)buildBGCache(g);
  ctx.drawImage(bgCache,0,0);
  // Terrain
  const fg=ctx.createLinearGradient(FX,FY,FX,FY+FH);
  fg.addColorStop(0,theme.fCol[0]);fg.addColorStop(.5,theme.fCol[1]);fg.addColorStop(1,theme.fCol[2]);
  ctx.fillStyle=fg;ctx.fillRect(FX,FY,FW,FH);
  for(let i=0;i<10;i++){ctx.fillStyle=i%2===0?'rgba(0,0,0,.065)':'rgba(255,255,255,.025)';ctx.fillRect(FX+i*FW/10,FY,FW/10,FH);}
  const fog=ctx.createRadialGradient(FX+FW/2,FY+FH/2,0,FX+FW/2,FY+FH/2,FW*.55);
  fog.addColorStop(0,'transparent');fog.addColorStop(1,theme.fog);
  ctx.fillStyle=fog;ctx.fillRect(FX,FY,FW,FH);
  // Lignes
  ctx.strokeStyle=theme.lCol;ctx.lineWidth=2.2;
  ctx.beginPath();ctx.arc(FX+FW/2,FY+FH/2,FH*.18,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(FX+FW/2,FY);ctx.lineTo(FX+FW/2,FY+FH);ctx.stroke();
  ctx.beginPath();ctx.arc(FX+FW/2,FY+FH/2,5,0,Math.PI*2);ctx.fillStyle=theme.lCol;ctx.fill();
  [[FX,FY,0,Math.PI/2],[FX+FW,FY,Math.PI/2,Math.PI],[FX+FW,FY+FH,Math.PI,Math.PI*1.5],[FX,FY+FH,Math.PI*1.5,Math.PI*2]].forEach(([cx,cy,sa,ea])=>{ctx.beginPath();ctx.arc(cx,cy,FH*.055,sa,ea);ctx.stroke();});
  ctx.strokeStyle=theme.lCol;ctx.lineWidth=2.8;ctx.strokeRect(FX,FY,FW,FH);
  // Buts
  const gY=FY+FH/2-GH/2;
  ctx.fillStyle='rgba(0,50,120,.42)';ctx.fillRect(FX-GW,gY,GW,GH);
  ctx.strokeStyle='rgba(0,150,255,.85)';ctx.lineWidth=2.2;ctx.strokeRect(FX-GW,gY,GW,GH);
  ctx.fillStyle='rgba(120,0,0,.42)';ctx.fillRect(FX+FW,gY,GW,GH);
  ctx.strokeStyle='rgba(255,50,50,.85)';ctx.strokeRect(FX+FW,gY,GW,GH);
  // Filets (batched)
  ctx.lineWidth=1;
  ctx.strokeStyle='rgba(0,150,255,.22)';ctx.beginPath();for(let i=0;i<=6;i++){ctx.moveTo(FX-GW,gY+i*GH/6);ctx.lineTo(FX,gY+i*GH/6);}ctx.stroke();
  ctx.strokeStyle='rgba(255,50,50,.22)';ctx.beginPath();for(let i=0;i<=6;i++){ctx.moveTo(FX+FW,gY+i*GH/6);ctx.lineTo(FX+FW+GW,gY+i*GH/6);}ctx.stroke();
  ctx.strokeStyle='rgba(0,150,255,.18)';ctx.beginPath();for(let i=0;i<=3;i++){ctx.moveTo(FX-GW+i*GW/3,gY);ctx.lineTo(FX-GW+i*GW/3,gY+GH);}ctx.stroke();
  ctx.strokeStyle='rgba(255,50,50,.18)';ctx.beginPath();for(let i=0;i<=3;i++){ctx.moveTo(FX+FW+i*GW/3,gY);ctx.lineTo(FX+FW+i*GW/3,gY+GH);}ctx.stroke();
  // Particules
  drawParticles(ctx,g.particles,theme.particles);
  // Goal flash
  if(g.gFlash>0){ctx.save();ctx.globalAlpha=g.gFlash*.22;ctx.fillStyle=g.gColor;ctx.fillRect(0,0,W,H);ctx.restore();}
  // Trails
  [g.player,...g.bots].forEach(car=>{
    car.trail.forEach(pt=>{ctx.save();ctx.globalAlpha=pt.t*.38;ctx.beginPath();ctx.arc(pt.x,pt.y,9,0,Math.PI*2);ctx.fillStyle=car===g.player?S.car.c1:car.col;ctx.fill();ctx.restore();});
  });
  // Bots
  g.bots.forEach(bot=>drawGameCar(ctx,bot,bot.col,bot.col2,g.wSpin+bot.wheelOff,false));
  // Remote players (multi)
  if(multiMode) drawRemotePlayers(ctx);
  // Joueur local
  drawGameCar(ctx,g.player,S.car.c1,S.car.c2,g.wSpin,true);
  // Balle
  const b=g.ball;
  ctx.save();
  ctx.globalAlpha=.22;ctx.beginPath();ctx.ellipse(b.x,b.y+b.r*.88,b.r*.72,b.r*.2,0,0,Math.PI*2);ctx.fillStyle='#000';ctx.fill();ctx.globalAlpha=1;
  ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
  const bg=ctx.createRadialGradient(b.x-b.r*.35,b.y-b.r*.35,0,b.x,b.y,b.r);
  bg.addColorStop(0,'#fff');bg.addColorStop(.45,'#e0e0e0');bg.addColorStop(1,'#888');
  ctx.fillStyle=bg;ctx.fill();
  ctx.save();ctx.translate(b.x,b.y);ctx.rotate(b.spin);
  ctx.beginPath();ctx.arc(0,0,b.r*.7,0,Math.PI*2);ctx.strokeStyle='rgba(100,100,100,.15)';ctx.lineWidth=1.5;ctx.stroke();
  ctx.restore();ctx.restore();
  // Assombrissement hors terrain
  ctx.fillStyle='rgba(0,0,0,.52)';
  ctx.fillRect(0,0,FX,H);ctx.fillRect(FX+FW+GW,0,W-(FX+FW+GW),H);
  ctx.fillRect(FX,0,FW,FY);ctx.fillRect(FX,FY+FH,FW,H-(FY+FH));
}

// =====================================================================
// CAR DRAWING
// =====================================================================
function drawGameCar(ctx,car,c1,c2,wSpin,isPlayer){
  const {x,y,w,h,angle}=car;
  const model=isPlayer?S.car.model:(car.model??0);
  const ws=isPlayer?S.car.wheel:(car.wheelStyle??0);
  const decal=isPlayer?(S.car.decal??0):(car.decal??0);
  ctx.save();ctx.translate(x,y);ctx.rotate(angle);
  ctx.globalAlpha=.3;ctx.beginPath();ctx.ellipse(0,h*.52,w*.44,h*.1,0,0,Math.PI*2);ctx.fillStyle='#000';ctx.fill();ctx.globalAlpha=1;
  if(model===0)drawOctane(ctx,w,h,c1,c2,wSpin,ws,decal);
  else if(model===1)drawFennec(ctx,w,h,c1,c2,wSpin,ws,decal);
  else drawDominus(ctx,w,h,c1,c2,wSpin,ws,decal);
  ctx.restore();
}

// â”€â”€ OCTANE â”€â”€ FidÃ¨le RL : corps trapu, toit arrondi, becquet, feux
function drawOctane(ctx,w,h,c1,c2,wSpin,ws,decal=0){
  // Roues
  drawWheel(ctx,-w*.33,h*.32,h*.26,ws,c2,wSpin);drawWheel(ctx,w*.33,h*.32,h*.26,ws,c2,wSpin);
  // Bas de caisse
  const flG=ctx.createLinearGradient(0,h*.1,0,h*.38);flG.addColorStop(0,shade(c1,-30));flG.addColorStop(1,shade(c1,-50));ctx.fillStyle=flG;
  ctx.beginPath();ctx.moveTo(-w*.52,h*.38);ctx.lineTo(w*.52,h*.32);ctx.lineTo(w*.5,h*.08);ctx.lineTo(-w*.5,h*.1);ctx.closePath();ctx.fill();
  // Corps principal
  const bG=ctx.createLinearGradient(-w*.1,-h*.32,w*.1,h*.15);bG.addColorStop(0,shade(c1,25));bG.addColorStop(.4,c1);bG.addColorStop(1,shade(c1,-15));ctx.fillStyle=bG;
  ctx.beginPath();ctx.moveTo(-w*.5,h*.1);ctx.lineTo(-w*.48,-h*.05);ctx.lineTo(-w*.3,-h*.32);ctx.quadraticCurveTo(-w*.15,-h*.42,-w*.05,-h*.44);ctx.quadraticCurveTo(w*.12,-h*.44,w*.25,-h*.38);ctx.lineTo(w*.44,-h*.18);ctx.lineTo(w*.5,h*.08);ctx.lineTo(w*.52,h*.32);ctx.closePath();ctx.fill();
  // Bande c2 + dÃ©cal
  const bnG=ctx.createLinearGradient(0,h*.04,0,h*.12);bnG.addColorStop(0,c2);bnG.addColorStop(1,shade(c2,-20));ctx.fillStyle=bnG;
  ctx.beginPath();ctx.moveTo(-w*.5,h*.12);ctx.lineTo(w*.5,h*.1);ctx.lineTo(w*.5,h*.2);ctx.lineTo(-w*.5,h*.2);ctx.closePath();ctx.fill();
  drawDecal(ctx,-w*.48,-h*.06,w*.96,h*.34,decal,c2);
  // Surbrillance toit
  const rHL=ctx.createRadialGradient(-w*.05,-h*.35,0,0,-h*.15,w*.4);rHL.addColorStop(0,'rgba(255,255,255,.22)');rHL.addColorStop(1,'rgba(255,255,255,0)');ctx.fillStyle=rHL;
  ctx.beginPath();ctx.moveTo(-w*.3,-h*.32);ctx.quadraticCurveTo(-w*.1,-h*.44,w*.08,-h*.43);ctx.lineTo(w*.25,-h*.38);ctx.lineTo(w*.44,-h*.18);ctx.lineTo(w*.35,-h*.1);ctx.lineTo(-w*.1,-h*.12);ctx.closePath();ctx.fill();
  // Pare-brise
  const wG=ctx.createLinearGradient(-w*.2,-h*.42,w*.2,-h*.15);wG.addColorStop(0,'rgba(160,220,255,.75)');wG.addColorStop(.6,'rgba(120,190,240,.55)');wG.addColorStop(1,'rgba(80,150,220,.3)');ctx.fillStyle=wG;
  ctx.beginPath();ctx.moveTo(-w*.26,-h*.1);ctx.lineTo(-w*.28,-h*.3);ctx.quadraticCurveTo(-w*.1,-h*.43,w*.08,-h*.41);ctx.lineTo(w*.28,-h*.3);ctx.lineTo(w*.3,-h*.12);ctx.closePath();ctx.fill();
  ctx.fillStyle='rgba(255,255,255,.15)';ctx.beginPath();ctx.moveTo(-w*.2,-h*.12);ctx.lineTo(-w*.22,-h*.28);ctx.quadraticCurveTo(-w*.08,-h*.38,w*.04,-h*.36);ctx.lineTo(w*.06,-h*.14);ctx.closePath();ctx.fill();
  // Prise d'air avant
  ctx.fillStyle='rgba(0,0,0,.7)';ctx.beginPath();ctx.roundRect(w*.34,-h*.12,w*.12,h*.08,2);ctx.fill();
  ctx.fillStyle='rgba(255,200,100,.6)';ctx.beginPath();ctx.roundRect(w*.36,-h*.1,w*.08,h*.04,1);ctx.fill();
  // Becquet arriÃ¨re
  ctx.fillStyle=shade(c1,-20);ctx.beginPath();ctx.moveTo(-w*.48,-h*.06);ctx.lineTo(-w*.52,-h*.08);ctx.lineTo(-w*.52,h*.02);ctx.lineTo(-w*.48,h*.02);ctx.closePath();ctx.fill();
  // Feux avant jaunes
  const fwG=ctx.createRadialGradient(w*.48,h*.14,0,w*.48,h*.14,w*.06);fwG.addColorStop(0,'rgba(255,245,150,1)');fwG.addColorStop(1,'rgba(255,200,0,0)');ctx.fillStyle=fwG;ctx.beginPath();ctx.ellipse(w*.48,h*.14,w*.055,h*.07,.2,0,Math.PI*2);ctx.fill();
  // Feux arriÃ¨re rouges
  const bkG=ctx.createRadialGradient(-w*.48,h*.14,0,-w*.48,h*.14,w*.05);bkG.addColorStop(0,'rgba(255,80,80,1)');bkG.addColorStop(1,'rgba(180,0,0,0)');ctx.fillStyle=bkG;ctx.beginPath();ctx.ellipse(-w*.48,h*.14,w*.05,h*.07,-.1,0,Math.PI*2);ctx.fill();
}

// â”€â”€ FENNEC â”€â”€ Corps compact blocky, toit haut, calandre large
function drawFennec(ctx,w,h,c1,c2,wSpin,ws,decal=0){
  drawWheel(ctx,-w*.35,h*.3,h*.28,ws,c2,wSpin);drawWheel(ctx,w*.35,h*.3,h*.28,ws,c2,wSpin);
  // Plancher
  ctx.fillStyle=shade(c1,-40);ctx.beginPath();ctx.moveTo(-w*.5,h*.34);ctx.lineTo(w*.5,h*.34);ctx.lineTo(w*.48,h*.1);ctx.lineTo(-w*.48,h*.1);ctx.closePath();ctx.fill();
  // Corps carrÃ©
  const bG=ctx.createLinearGradient(0,-h*.42,0,h*.15);bG.addColorStop(0,shade(c1,20));bG.addColorStop(.5,c1);bG.addColorStop(1,shade(c1,-10));ctx.fillStyle=bG;
  ctx.beginPath();ctx.moveTo(-w*.5,h*.12);ctx.lineTo(-w*.48,-h*.08);ctx.quadraticCurveTo(-w*.44,-h*.38,-w*.2,-h*.44);ctx.quadraticCurveTo(0,-h*.48,w*.2,-h*.44);ctx.quadraticCurveTo(w*.44,-h*.38,w*.48,-h*.08);ctx.lineTo(w*.5,h*.12);ctx.lineTo(w*.48,h*.34);ctx.lineTo(-w*.48,h*.34);ctx.closePath();ctx.fill();
  // Reflet latÃ©ral
  const sHL=ctx.createLinearGradient(-w*.48,0,w*.48,0);sHL.addColorStop(0,'rgba(255,255,255,0)');sHL.addColorStop(.15,'rgba(255,255,255,.12)');sHL.addColorStop(.5,'rgba(255,255,255,0)');sHL.addColorStop(.85,'rgba(255,255,255,.1)');sHL.addColorStop(1,'rgba(255,255,255,0)');ctx.fillStyle=sHL;
  ctx.beginPath();ctx.moveTo(-w*.5,h*.12);ctx.lineTo(-w*.48,-h*.08);ctx.quadraticCurveTo(-w*.44,-h*.38,-w*.2,-h*.44);ctx.quadraticCurveTo(0,-h*.48,w*.2,-h*.44);ctx.quadraticCurveTo(w*.44,-h*.38,w*.48,-h*.08);ctx.lineTo(w*.5,h*.12);ctx.lineTo(w*.48,h*.34);ctx.lineTo(-w*.48,h*.34);ctx.closePath();ctx.fill();
  // Bande c2 + dÃ©cal
  const bnG=ctx.createLinearGradient(0,h*.06,0,h*.16);bnG.addColorStop(0,c2);bnG.addColorStop(1,shade(c2,-20));ctx.fillStyle=bnG;
  ctx.beginPath();ctx.moveTo(-w*.5,h*.12);ctx.lineTo(w*.5,h*.12);ctx.lineTo(w*.5,h*.22);ctx.lineTo(-w*.5,h*.22);ctx.closePath();ctx.fill();
  drawDecal(ctx,-w*.48,-h*.04,w*.96,h*.38,decal,c2);
  // Pare-brise large
  const wG=ctx.createLinearGradient(0,-h*.44,0,-h*.08);wG.addColorStop(0,'rgba(140,210,255,.8)');wG.addColorStop(.5,'rgba(100,180,240,.6)');wG.addColorStop(1,'rgba(60,140,220,.25)');ctx.fillStyle=wG;
  ctx.beginPath();ctx.moveTo(-w*.36,-h*.08);ctx.lineTo(-w*.38,-h*.38);ctx.quadraticCurveTo(-w*.2,-h*.46,0,-h*.46);ctx.quadraticCurveTo(w*.2,-h*.46,w*.38,-h*.38);ctx.lineTo(w*.36,-h*.08);ctx.closePath();ctx.fill();
  ctx.fillStyle='rgba(255,255,255,.18)';ctx.beginPath();ctx.moveTo(-w*.3,-h*.1);ctx.lineTo(-w*.32,-h*.34);ctx.quadraticCurveTo(-w*.1,-h*.42,0,-h*.42);ctx.lineTo(0,-h*.12);ctx.closePath();ctx.fill();
  // Calandre
  ctx.fillStyle=shade(c1,-35);ctx.beginPath();ctx.roundRect(w*.22,-h*.08,w*.24,h*.12,3);ctx.fill();
  ctx.fillStyle='rgba(0,0,0,.8)';ctx.beginPath();ctx.roundRect(w*.24,-h*.06,w*.2,h*.08,2);ctx.fill();
  for(let k=0;k<3;k++){ctx.fillStyle='rgba(200,220,255,.5)';ctx.fillRect(w*(.25+k*.07),-h*.04,w*.04,h*.02);}
  // Feux
  const fwG=ctx.createRadialGradient(w*.42,h*.06,0,w*.42,h*.06,w*.06);fwG.addColorStop(0,'rgba(255,248,160,1)');fwG.addColorStop(1,'rgba(255,200,0,0)');ctx.fillStyle=fwG;ctx.beginPath();ctx.arc(w*.42,h*.06,w*.06,0,Math.PI*2);ctx.fill();
  const bkG=ctx.createRadialGradient(-w*.42,h*.06,0,-w*.42,h*.06,w*.06);bkG.addColorStop(0,'rgba(255,60,60,1)');bkG.addColorStop(1,'rgba(180,0,0,0)');ctx.fillStyle=bkG;ctx.beginPath();ctx.arc(-w*.42,h*.06,w*.06,0,Math.PI*2);ctx.fill();
}

// â”€â”€ DOMINUS â”€â”€ TrÃ¨s plat, long, hitbox rectangle
function drawDominus(ctx,w,h,c1,c2,wSpin,ws,decal=0){
  drawWheel(ctx,-w*.38,h*.3,h*.21,ws,c2,wSpin);drawWheel(ctx,w*.38,h*.3,h*.21,ws,c2,wSpin);
  // Plancher plat
  ctx.fillStyle=shade(c1,-45);ctx.beginPath();ctx.moveTo(-w*.55,h*.32);ctx.lineTo(w*.55,h*.28);ctx.lineTo(w*.52,h*.08);ctx.lineTo(-w*.52,h*.1);ctx.closePath();ctx.fill();
  // Corps plat â€” profil coin
  const bG=ctx.createLinearGradient(0,-h*.28,0,h*.18);bG.addColorStop(0,shade(c1,30));bG.addColorStop(.3,shade(c1,10));bG.addColorStop(.7,c1);bG.addColorStop(1,shade(c1,-20));ctx.fillStyle=bG;
  ctx.beginPath();ctx.moveTo(-w*.54,h*.1);ctx.lineTo(-w*.5,-h*.14);ctx.lineTo(-w*.18,-h*.3);ctx.lineTo(w*.08,-h*.32);ctx.lineTo(w*.38,-h*.22);ctx.lineTo(w*.56,h*.0);ctx.lineTo(w*.54,h*.28);ctx.closePath();ctx.fill();
  // Face supÃ©rieure Ã©clairÃ©e
  const tG=ctx.createLinearGradient(0,-h*.32,0,h*.0);tG.addColorStop(0,shade(c1,40));tG.addColorStop(.4,shade(c1,18));tG.addColorStop(1,c1);ctx.fillStyle=tG;
  ctx.beginPath();ctx.moveTo(-w*.5,-h*.14);ctx.lineTo(-w*.18,-h*.3);ctx.lineTo(w*.08,-h*.32);ctx.lineTo(w*.38,-h*.22);ctx.lineTo(w*.56,h*.0);ctx.lineTo(w*.54,h*.1);ctx.lineTo(w*.48,h*.1);ctx.lineTo(w*.3,-h*.18);ctx.lineTo(w*.06,-h*.28);ctx.lineTo(-w*.16,-h*.26);ctx.lineTo(-w*.46,-h*.1);ctx.closePath();ctx.fill();
  // Bande c2 + dÃ©cal
  const bnG=ctx.createLinearGradient(0,-h*.02,0,h*.1);bnG.addColorStop(0,c2);bnG.addColorStop(1,shade(c2,-25));ctx.fillStyle=bnG;
  ctx.beginPath();ctx.moveTo(-w*.54,h*.1);ctx.lineTo(w*.54,h*.08);ctx.lineTo(w*.54,h*.2);ctx.lineTo(-w*.54,h*.2);ctx.closePath();ctx.fill();
  drawDecal(ctx,-w*.52,-h*.08,w*1.04,h*.4,decal,c2);
  // Pare-brise inclinÃ© plat
  const wG=ctx.createLinearGradient(-w*.05,-h*.3,w*.1,-h*.1);wG.addColorStop(0,'rgba(140,200,255,.75)');wG.addColorStop(.7,'rgba(100,170,240,.45)');wG.addColorStop(1,'rgba(60,130,220,.2)');ctx.fillStyle=wG;
  ctx.beginPath();ctx.moveTo(-w*.16,-h*.26);ctx.lineTo(w*.06,-h*.28);ctx.lineTo(w*.28,-h*.18);ctx.lineTo(w*.22,-h*.08);ctx.lineTo(-w*.1,-h*.06);ctx.closePath();ctx.fill();
  ctx.fillStyle='rgba(255,255,255,.14)';ctx.beginPath();ctx.moveTo(-w*.12,-h*.24);ctx.lineTo(w*.04,-h*.26);ctx.lineTo(w*.16,-h*.18);ctx.lineTo(w*.12,-h*.1);ctx.lineTo(-w*.06,-h*.08);ctx.closePath();ctx.fill();
  // Aileron arriÃ¨re + grille
  ctx.fillStyle=shade(c1,-30);ctx.beginPath();ctx.moveTo(-w*.5,-h*.14);ctx.lineTo(-w*.54,h*.0);ctx.lineTo(-w*.54,h*.1);ctx.lineTo(-w*.5,h*.0);ctx.closePath();ctx.fill();
  for(let k=0;k<3;k++){ctx.strokeStyle='rgba(0,0,0,.5)';ctx.lineWidth=h*.02;ctx.beginPath();ctx.moveTo(-w*.52,-h*(.02-k*.06));ctx.lineTo(-w*.5,-h*(.04-k*.06));ctx.stroke();}
  // Feux avant rectangulaires
  const fwG=ctx.createLinearGradient(w*.48,0,w*.56,0);fwG.addColorStop(0,'rgba(255,245,160,.9)');fwG.addColorStop(1,'rgba(255,200,50,0)');ctx.fillStyle=fwG;ctx.beginPath();ctx.roundRect(w*.44,h*.0,w*.12,h*.06,1);ctx.fill();
  // Feux arriÃ¨re
  ctx.fillStyle='rgba(255,30,30,.85)';ctx.beginPath();ctx.roundRect(-w*.54,-h*.02,w*.08,h*.06,1);ctx.fill();
  ctx.fillStyle='rgba(255,80,80,.6)';ctx.beginPath();ctx.roundRect(-w*.53,-h*.01,w*.06,h*.04,1);ctx.fill();
}

function showGoal(txt,color){
  const el=document.getElementById('goa'),t=document.getElementById('got');
  t.textContent=txt;t.style.color=color||'#fff';t.style.borderColor=color||'#fff';t.style.textShadow=`0 0 30px ${color||'#fff'}`;
  el.classList.remove('show');void el.offsetWidth;el.classList.add('show');
  if(game){game.gFlash=1.2;game.gColor=color||'#fff';}
  setTimeout(()=>el.classList.remove('show'),2000);
}
function startCountdown(){
  const o=document.getElementById('cdo'),n=document.getElementById('cdn');
  o.style.display='flex';let c=3;n.textContent=c;n.style.color='#fff';
  const iv=setInterval(()=>{c--;
    if(c===0){n.textContent='GO!';n.style.color='var(--accent2)';}
    else if(c<0){clearInterval(iv);o.style.display='none';n.style.color='#fff';game.running=true;game.lastTime=performance.now();gameLoop(performance.now());}
    else n.textContent=c;
  },1000);
}

function endGame(){
  if(!game)return; game.running=false; cancelAnimationFrame(game.animFrame);
  const oppScore=multiMode?(game.scoreOpp||0):game.scoreB;
  const win=game.scoreP>oppScore, draw=game.scoreP===oppScore;
  let vakReward=0,xpReward=0;
  if(win){vakReward=15;xpReward=100+game.scoreP*20;}else if(draw){xpReward=40;}else{xpReward=20;}
  if(vakReward>0){S.vak+=vakReward;save();updateVak();}
  if(xpReward>0)addXP(xpReward);
  document.getElementById('end-result-text').textContent=win?'VICTOIRE !':draw?'Ã‰GALITÃ‰':'DÃ‰FAITE';
  document.getElementById('end-result-text').className='er '+(win?'win':draw?'':'lose');
  document.getElementById('end-final-score').textContent=`${game.scoreP} â€“ ${oppScore}`;
  document.getElementById('end-reward').textContent=win?`+${vakReward} VAK ğŸ† Â· +${xpReward} XP`:`+${xpReward} XP`;
  document.getElementById('es').classList.add('show');
}

function endToMenu(){
  document.getElementById('es').classList.remove('show');
  document.getElementById('pm').classList.remove('show');
  document.getElementById('game-canvas').style.display='none';
  document.getElementById('game-hud').style.display='none';
  showMobileControls(false);
  document.getElementById('score-player').textContent='0';
  document.getElementById('score-bot').textContent='0';
  document.getElementById('ping-display').classList.remove('show');
  if(game)cancelAnimationFrame(game.animFrame);
  stopInputLoop();
  _clearGoalTimers();
  document.getElementById('goal-countdown').classList.remove('show');
  game=null; bgCache=null; tribuneCanvas=null;
  multiMode=false; myPlayerId=null; myTeam=0; roomPlayerList=[];
  showScreen('screen-main');
}

// =====================================================================
// WEBSOCKET â€” Architecture serveur autoritaire
// =====================================================================
const WS_URL = (location.hostname==='localhost'||location.hostname==='127.0.0.1')
  ? `ws://${location.host}` : `wss://${location.host}`;

let socket=null, myPlayerId=null, myTeam=0, roomPlayerList=[];
let _pingStart=0, _pingInterval=null;

function connectToServer(onReady) {
  if(socket&&socket.readyState===WebSocket.OPEN){if(onReady)onReady();return;}
  if(socket&&socket.readyState===WebSocket.CONNECTING){const prev=socket.onopen;socket.onopen=e=>{if(prev)prev(e);if(onReady)onReady();};return;}
  socket=new WebSocket(WS_URL);
  socket.onopen = ()=>{ if(onReady)onReady(); startPingLoop(); };
  socket.onerror= ()=>notify('âŒ Impossible de joindre le serveur');
  socket.onclose= ()=>{ socket=null; stopPingLoop(); if(multiMode)notify('âš ï¸ DÃ©connectÃ© du serveur'); };
  socket.onmessage=(e)=>{ let m; try{m=JSON.parse(e.data);}catch{return;} handleServerMsg(m); };
}

// Ping latency display
function startPingLoop(){
  _pingInterval=setInterval(()=>{
    if(!socket||socket.readyState!==WebSocket.OPEN)return;
    _pingStart=performance.now();
    socket.send(JSON.stringify({type:'PING'}));
  },2000);
}
function stopPingLoop(){ if(_pingInterval){clearInterval(_pingInterval);_pingInterval=null;} }

function handleServerMsg(msg) {
  // PONG
  if(msg.type==='PONG'){
    const ms=Math.round(performance.now()-_pingStart);
    document.getElementById('ping-val').textContent=ms;
    document.getElementById('ping-display').classList.add('show');
    return;
  }

  if(msg.type==='SERVER_CREATED'){
    document.getElementById('srv-id-display').textContent=msg.serverId;
    myPlayerId=msg.playerId;
    renderSrvMapPreview(S.map||0);
    notify('âœ… Serveur crÃ©Ã© ! ID : '+msg.serverId);
  }

  if(msg.type==='JOINED'){
    myPlayerId=msg.playerId; myTeam=msg.team??0;
    notify('âœ… ConnectÃ© au serveur '+msg.serverId);
    S.map=msg.map; S.time=msg.time;
    showScreen('screen-create-server');
    // Show server ID for guests too
    const sid=document.getElementById('srv-id-display'); if(sid)sid.textContent=msg.serverId;
    // Hide launch button for guests (only host can launch)
    const lb=document.getElementById('launch-multi-btn'); if(lb)lb.style.display=msg.isHost?'':'none';
    selectSrvMap(msg.map||0);
    selectSrvTime(msg.time||180);
    setTimeout(()=>renderSrvMapPreview(msg.map||0),80);
  }

  if(msg.type==='ROOM_UPDATE'){
    roomPlayerList=msg.players||[];
    const teamA=roomPlayerList.filter(p=>p.team===0);
    const teamB=roomPlayerList.filter(p=>p.team===1);
    const mkList=arr=>arr.map(p=>`â€¢ ${p.name}${p.id===myPlayerId?' <span style="color:var(--accent)">(Vous)</span>':''}`).join('<br>')||'(vide)';
    document.getElementById('srv-members-list').innerHTML=
      '<span style="color:var(--accent);font-size:10px">Ã‰QUIPE A ğŸ”µ</span><br>'+mkList(teamA)+
      '<br><span style="color:var(--red);font-size:10px;margin-top:4px;display:block">Ã‰QUIPE B ğŸ”´</span><br>'+mkList(teamB);
    document.getElementById('srv-member-count').textContent=roomPlayerList.length;
    if(msg.map!==undefined){ S.map=msg.map; selectSrvMap(msg.map); renderSrvMapPreview(msg.map); }
    if(msg.time!==undefined){ S.time=msg.time; selectSrvTime(msg.time); }
  }

  if(msg.type==='GAME_START'){
    S.map=msg.map; S.time=msg.time;
    roomPlayerList=msg.players||[];
    const me=roomPlayerList.find(p=>p.id===myPlayerId);
    myTeam=me?me.team:0;
    const teamA=roomPlayerList.filter(p=>p.team===0).map(p=>p.name).join(' & ')||'Ã‰QUIPE A';
    const teamB=roomPlayerList.filter(p=>p.team===1).map(p=>p.name).join(' & ')||'Ã‰QUIPE B';
    document.getElementById('hud-team-a').textContent=teamA;
    document.getElementById('hud-team-b').textContent=teamB;
    startMultiGame();
  }

  // ---- GAME_STATE: Ã©tat autoritaire du serveur (~20fps) ----
  if(msg.type==='GAME_STATE'){
    if(!game || game.paused) return; // ignorer pendant la pause
    // Timer & score (autoritÃ© serveur)
    game.timeLeft=msg.t;
    const myScore  = myTeam===0?msg.sA:msg.sB;
    const oppScore = myTeam===0?msg.sB:msg.sA;
    game.scoreP=myScore; game.scoreOpp=oppScore;
    document.getElementById('score-player').textContent=myScore;
    document.getElementById('score-bot').textContent=oppScore;

    // Balle â€” coordonnÃ©es normalisÃ©es â†’ pixels
    // Serveur: 0â†’1 sur toute la fenÃªtre (WÃ—H)
    if(msg.b){
      const bx=msg.b.x*game.W, by=msg.b.y*game.H;
      const bd=Math.hypot(game.ball.x-bx,game.ball.y-by);
      if(bd>game.BR*8){game.ball.x=bx;game.ball.y=by;}
      else{game.ball.x+=(bx-game.ball.x)*0.5;game.ball.y+=(by-game.ball.y)*0.5;}
      game.ball._svx=msg.b.vx*game.W;
      game.ball._svy=msg.b.vy*game.H;
      game.ball.vx=game.ball._svx;
      game.ball.vy=game.ball._svy;
      game.ball.r=Math.min(game.W,game.H)*0.028;
    }

    // Joueurs
    if(msg.p&&game.remotePlayers!==undefined){
      msg.p.forEach(p=>{
        const px=p.x*game.W, py=p.y*game.H;
        if(p.id===myPlayerId){
          const cx=Math.max(game.FX+game.CW/2,Math.min(game.FX+game.FW-game.CW/2,px));
          const cy=Math.max(game.FY+game.CH/2,Math.min(game.FY+game.FH-game.CH/2,py));
          if(game.player._tx===undefined){game.player.x=cx;game.player.y=cy;}
          game.player._tx=cx; game.player._ty=cy; game.player._ta=p.a;
          game.player.vx=p.vx*game.W; game.player.vy=p.vy*game.H;
          game.player.boost=p.bst;
        } else {
          const rpx=Math.max(game.FX,Math.min(game.FX+game.FW,px));
          const rpy=Math.max(game.FY,Math.min(game.FY+game.FH,py));
          if(!game.remotePlayers[p.id]) game.remotePlayers[p.id]={x:rpx,y:rpy,_tx:rpx,_ty:rpy,_ta:p.a,angle:p.a,_wSpin:0};
          else { Object.assign(game.remotePlayers[p.id],{nm:p.nm,tm:p.tm,c1:p.c1,c2:p.c2,md:p.md,ws:p.ws,vx:p.vx,vy:p.vy,bst:p.bst}); game.remotePlayers[p.id]._tx=rpx; game.remotePlayers[p.id]._ty=rpy; game.remotePlayers[p.id]._ta=p.a; }
        }
      });
    }
  }

  // BUT
  if(msg.type==='GOAL'){
    if(!game)return;
    const myScore=myTeam===0?msg.scoreA:msg.scoreB, oppScore=myTeam===0?msg.scoreB:msg.scoreA;
    game.scoreP=myScore; game.scoreOpp=oppScore;
    document.getElementById('score-player').textContent=myScore;
    document.getElementById('score-bot').textContent=oppScore;
    const iScored=(myTeam===0&&msg.team===0)||(myTeam===1&&msg.team===1);
    showGoal(iScored?'BUT ! ğŸ‰':'ADVERSAIRE !',iScored?'var(--accent)':'var(--red)');
    if(game.player){delete game.player._tx;delete game.player._ty;}
    if(game.remotePlayers)Object.values(game.remotePlayers).forEach(p=>{delete p._tx;delete p._ty;});
    game.running=false; cancelAnimationFrame(game.animFrame);
    _clearGoalTimers();
    // SÃ©quence: BUT! affichÃ© 1.8s â†’ puis countdown 3-2-1-GO (total=5s = timing serveur)
    _goalTimers.push(setTimeout(()=>{
      if(!game) return;
      const el=document.getElementById('goal-countdown'),num=document.getElementById('gc-num');
      el.classList.add('show'); num.textContent='3'; num.style.color='#fff';
      [[0,'3','#fff'],[1000,'2','#fff'],[2000,'1','#fff'],[3000,'GO!','var(--accent2)']].forEach(([d,t,col])=>{
        _goalTimers.push(setTimeout(()=>{ if(game&&el.classList.contains('show')){num.textContent=t;num.style.color=col;} }, d));
      });
      _goalTimers.push(setTimeout(()=>{
        if(!game) return;
        el.classList.remove('show'); num.style.color='var(--accent)';
        if(!game.running){ game.lastTime=performance.now(); game.running=true; gameLoop(performance.now()); }
      }, 3200)); // 1800+3200=5000ms
    }, 1800));
  }

  if(msg.type==='GAME_OVER'){
    if(game&&!game._ended){game._ended=true;endGame();}
  }

  if(msg.type==='ERROR'){
    const errEl=document.getElementById('join-error');
    if(errEl)errEl.textContent='âŒ '+msg.msg;
    notify('âŒ '+msg.msg);
  }
}

// ---- Lobby actions ----
function goCreateServer(){
  document.getElementById('srv-id-display').textContent='...';
  document.getElementById('srv-members-list').innerHTML=`â€¢ ${S.playerName} <span style="color:var(--accent)">(Vous)</span>`;
  document.getElementById('srv-member-count').textContent='1';
  showScreen('screen-create-server');
  connectToServer(()=>socket.send(JSON.stringify({
    type:'CREATE_SERVER',name:S.playerName,map:S.map,time:S.time,
    c1:S.car.c1,c2:S.car.c2,model:S.car.model,wheelStyle:S.car.wheel
  })));
}
function joinServerAction(){
  const id=document.getElementById('join-server-id').value.trim().toUpperCase();
  const errEl=document.getElementById('join-error');
  if(id.length<4){errEl.textContent='âŒ ID invalide';return;}
  errEl.textContent='';
  connectToServer(()=>socket.send(JSON.stringify({
    type:'JOIN_SERVER',serverId:id,name:S.playerName,
    c1:S.car.c1,c2:S.car.c2,model:S.car.model,wheelStyle:S.car.wheel
  })));
}
function launchMultiGame(){
  if(!socket){notify('âŒ Non connectÃ©');return;}
  socket.send(JSON.stringify({type:'LAUNCH'}));
}
function leaveServer(){
  if(socket){socket.close();socket=null;}
  showScreen('screen-play-multi');
}
function selectSrvMapAndSync(i) { selectSrvMap(i); if(socket)socket.send(JSON.stringify({type:'HOST_CONFIG',map:i})); }
function selectSrvTimeAndSync(s){ selectSrvTime(s); if(socket)socket.send(JSON.stringify({type:'HOST_CONFIG',time:s})); }

// ---- Input loop (multi) â€” Gemini: envoie dÃ¨s keydown, loop rÃ©duite ----
let _inputIv=null, _inputTick=0;
function startInputLoop(){
  if(_inputIv)clearInterval(_inputIv);
  _inputTick=0;
  _inputIv=setInterval(()=>{
    if(!socket||socket.readyState!==WebSocket.OPEN)return;
    _inputTick++;
    const m={type:'INPUT',i:{
      up:!!keys[S.keys.up], down:!!keys[S.keys.down],
      left:!!keys[S.keys.left], right:!!keys[S.keys.right],
      boost:!!keys[S.keys.boost]
    }};
    // Synchro skin toutes les 15 frames (~500ms)
    if(_inputTick%15===1){m.c1=S.car.c1;m.c2=S.car.c2;m.md=S.car.model;m.ws=S.car.wheel;}
    socket.send(JSON.stringify(m));
  },33);  // ~30fps â†’ serveur Ã  60fps â†’ moins de lag apparent
}
function stopInputLoop(){ if(_inputIv){clearInterval(_inputIv);_inputIv=null;} }

// ---- Dessin joueurs distants ----
function drawRemotePlayers(ctx){
  if(!game||!game.remotePlayers)return;
  Object.values(game.remotePlayers).forEach(rp=>{
    if(!rp||rp._tx===undefined)return;
    // Interpolation fluide vers position cible
    const dd=Math.hypot((rp._tx||0)-(rp.x||0),(rp._ty||0)-(rp.y||0));
    if(dd > game.FW*0.12){ rp.x=rp._tx; rp.y=rp._ty; }
    else{ const lp=Math.min(1,0.016*10); rp.x=rp.x===undefined?rp._tx:rp.x+(rp._tx-rp.x)*lp; rp.y=rp.y===undefined?rp._ty:rp.y+(rp._ty-rp.y)*lp; }
    if(rp._ta!==undefined){let da=rp._ta-rp.angle;while(da>Math.PI)da-=Math.PI*2;while(da<-Math.PI)da+=Math.PI*2;rp.angle+=da*0.15;}
    const rvx=(rp.vx||0)*game.W, rvy=(rp.vy||0)*game.H;
    rp._wSpin=(rp._wSpin||0)+Math.sqrt(rvx**2+rvy**2)*0.0008;
    const c1=rp.c1||(rp.tm===1?'#cc2200':'#00b4ff'), c2=rp.c2||'#fff';
    drawGameCar(ctx,{x:rp.x,y:rp.y,angle:rp.angle||0,w:game.CW,h:game.CH,trail:[],vx:rvx,vy:rvy,model:rp.md??0,wheelStyle:rp.ws??0},c1,c2,rp._wSpin,false);
    // Nametag
    if(rp.nm){
      ctx.save();ctx.font='bold 11px Rajdhani,sans-serif';ctx.textAlign='center';
      const tw=ctx.measureText(rp.nm).width;
      ctx.fillStyle=rp.tm===1?'rgba(200,40,0,.75)':'rgba(0,100,200,.75)';
      ctx.fillRect(rp.x-tw/2-4,rp.y-game.CH*.85-16,tw+8,16);
      ctx.fillStyle='#fff';ctx.fillText(rp.nm,rp.x,rp.y-game.CH*.85-4);
      ctx.restore();
    }
  });
}

// =====================================================================
// INIT
// =====================================================================
updateVak(); updatePlayerBar(); renderMenuCar();

// â”€â”€â”€ NEW PLAY SCREEN NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchToSoloDetail(){
  showScreen('screen-play-solo');
  setTimeout(()=>{ if(typeof drawMapPreviews==='function') drawMapPreviews(); },50);
}
function switchToMultiDetail(){ showScreen('screen-play-multi'); }

function renderNewsCar(){
  // renderMenuCar already handles the news canvas â€” just call it
  renderMenuCar();
}
function renderAllMapPreviews(){ drawMapPreviews(); }

// Initial delayed news car render (in case canvas wasn't ready)
setTimeout(renderMenuCar,120);
// Re-render canvases on resize so they always fill their container
window.addEventListener('resize',()=>{ renderMenuCar(); renderGarageCar(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTRÃ”LES MOBILES â€” Joystick + Boost
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const STICK_MAX = 42, DEAD = 0.12;
  let joyActive=false, joyId=null, joyOx=0, joyOy=0, jdx=0, jdy=0;
  const zone=document.getElementById('joy-zone');
  const stick=document.getElementById('joy-stick');
  const boostBtn=document.getElementById('boost-btn');
  if(!zone||!stick||!boostBtn) return;

  function setStick(dx,dy){ stick.style.transform=`translate(calc(-50% + ${dx*STICK_MAX}px),calc(-50% + ${dy*STICK_MAX}px))`; }
  function applyJoy(){
    keys[S.keys.up]    = joyActive && jdy < -DEAD;
    keys[S.keys.down]  = joyActive && jdy >  DEAD;
    keys[S.keys.left]  = joyActive && jdx < -DEAD;
    keys[S.keys.right] = joyActive && jdx >  DEAD;
  }
  zone.addEventListener('touchstart',e=>{
    e.preventDefault(); if(joyActive) return;
    const t=e.changedTouches[0]; joyId=t.identifier; joyActive=true;
    const r=zone.getBoundingClientRect(); joyOx=r.left+r.width/2; joyOy=r.top+r.height/2;
    jdx=0; jdy=0; setStick(0,0); applyJoy();
  },{passive:false});
  zone.addEventListener('touchmove',e=>{
    e.preventDefault();
    for(let i=0;i<e.changedTouches.length;i++){
      const t=e.changedTouches[i]; if(t.identifier!==joyId) continue;
      const rx=t.clientX-joyOx, ry=t.clientY-joyOy;
      const d=Math.sqrt(rx*rx+ry*ry), c=Math.min(d,STICK_MAX), a=Math.atan2(ry,rx);
      jdx=(c/STICK_MAX)*Math.cos(a); jdy=(c/STICK_MAX)*Math.sin(a);
      setStick(jdx,jdy); applyJoy();
    }
  },{passive:false});
  function joyEnd(e){ e.preventDefault();
    for(let i=0;i<e.changedTouches.length;i++){
      if(e.changedTouches[i].identifier===joyId){
        joyActive=false; joyId=null; jdx=0; jdy=0; setStick(0,0); applyJoy(); break;
      }
    }
  }
  zone.addEventListener('touchend',joyEnd,{passive:false});
  zone.addEventListener('touchcancel',joyEnd,{passive:false});

  let boostId=null;
  boostBtn.addEventListener('touchstart',e=>{
    e.preventDefault(); if(boostId!==null) return;
    boostId=e.changedTouches[0].identifier;
    keys[S.keys.boost]=true; boostBtn.classList.add('active');
  },{passive:false});
  function boostEnd(e){ e.preventDefault();
    for(let i=0;i<e.changedTouches.length;i++){
      if(e.changedTouches[i].identifier===boostId){
        boostId=null; keys[S.keys.boost]=false; boostBtn.classList.remove('active'); break;
      }
    }
  }
  boostBtn.addEventListener('touchend',boostEnd,{passive:false});
  boostBtn.addEventListener('touchcancel',boostEnd,{passive:false});
})();

function showMobileControls(v){
  const mc=document.getElementById('mobile-controls'); if(!mc) return;
  if(v) mc.classList.add('ingame'); else mc.classList.remove('ingame');
  // CSS media queries (pointer:fine/coarse) handle the actual visibility
}

</script>

<!-- MOBILE CONTROLS -->
<div id="mobile-controls">
  <div id="joy-zone">
    <div id="joy-base">
      <svg style="position:absolute;inset:0;width:100%;height:100%;opacity:.25" viewBox="0 0 130 130">
        <polygon points="65,8 73,24 57,24" fill="white"/>
        <polygon points="65,122 73,106 57,106" fill="white"/>
        <polygon points="8,65 24,57 24,73" fill="white"/>
        <polygon points="122,65 106,57 106,73" fill="white"/>
      </svg>
    </div>
    <div id="joy-stick"></div>
  </div>
  <div id="boost-btn">
    <span class="boost-icon">âš¡</span>
    <span class="boost-label">BOOST</span>
  </div>
</div>

</body>
</html>
